<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/anglictina/app/main.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/anglictina/app/main.py" />
              <option name="originalContent" value="# --- Flask and SocketIO imports ---&#10;from dotenv import load_dotenv&#10;from flask import Flask, render_template, session, send_from_directory, request, redirect, jsonify&#10;from flask_session import Session&#10;from streak import get_user_streak, update_user_streak&#10;import traceback&#10;import redis&#10;from werkzeug.middleware.proxy_fix import ProxyFix&#10;&#10;import os&#10;import sys&#10;&#10;# Import všech blueprintů&#10;from A1_music import exercises_bp&#10;from ai import ai_bp&#10;from at_on import at_on_bp&#10;from auth import auth_bp&#10;from chat import zpravy_bp&#10;from feedback import feedback_bp&#10;from hangman import hangman_bp&#10;from listening import listening_bp&#10;from main_routes import main_bp&#10;from nepravidelna_slovesa import verbs_bp&#10;from news import news_bp&#10;from obchod import obchod_bp&#10;from present_perfect import chat_bp&#10;from review import review_bp&#10;from roleplaying import roleplaying_bp&#10;from theme import theme_bp&#10;from pexeso import pexeso_bp, register_socketio_handlers&#10;from xp import get_user_xp_and_level&#10;from xp import xp_bp&#10;from drawing import drawing_bp&#10;from psani import psani_bp&#10;from stats import user_stats_bp&#10;from admin import admin_bp&#10;from vlastni_music import vlastni_music_bp&#10;from proc import proc_bp&#10;&#10;app = Flask(__name__)&#10;&#10;# NEJDŘÍVE načti proměnné prostředí a nastav SECRET_KEY&#10;load_dotenv(dotenv_path=&quot;.env&quot;)&#10;app.secret_key = os.getenv(&quot;SECRET_KEY&quot;)&#10;if not app.secret_key:&#10;    print(&quot;[main] ERROR: SECRET_KEY is not set in environment! Session will not persist correctly.&quot;)&#10;    raise RuntimeError(&quot;SECRET_KEY is missing. Set SECRET_KEY in environment for stable sessions.&quot;)&#10;&#10;# Session/cookie konfigurace (bezpečná a stabilní)&#10;app.config['SESSION_TYPE'] = 'redis'&#10;if os.getenv('REDIS_URL'):&#10;    app.config['SESSION_REDIS'] = redis.from_url(os.getenv('REDIS_URL'))&#10;&#10;# Cookie základní nastavení – upraví se v before_request podle hostu&#10;app.config['SESSION_COOKIE_NAME'] = os.getenv('SESSION_COOKIE_NAME', 'knowix_session')&#10;app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'&#10;app.config['SESSION_COOKIE_SECURE'] = True&#10;app.config['SESSION_COOKIE_HTTPONLY'] = True&#10;app.config['SESSION_USE_SIGNER'] = True&#10;app.config['PERMANENT_SESSION_LIFETIME'] = 60 * 60 * 24 * 30  # 30 dní&#10;app.config['SESSION_REFRESH_EACH_REQUEST'] = True  # DŮLEŽITÉ: vynuť refresh cookies&#10;&#10;# Respektuj proxy hlavičky (https, host, port) – důležité pro secure cookies&#10;app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_port=1)&#10;&#10;# Fallback: pokud Redis není dostupný, přepnout na filesystem sessions&#10;use_redis = False&#10;force_fs = os.getenv('SESSION_FORCE_FILESYSTEM', '').strip() == '1'&#10;redis_url = os.getenv('REDIS_URL')&#10;if not force_fs and redis_url and app.config.get('SESSION_REDIS') is not None:&#10;    try:&#10;        app.config['SESSION_REDIS'].ping()&#10;        use_redis = True&#10;        print(f&quot;[main] Session backend: Redis OK -&gt; {redis_url}&quot;)&#10;    except Exception as ex:&#10;        print(f&quot;[main] WARNING: Redis ping failed ({ex}). Falling back to filesystem sessions.&quot;)&#10;&#10;if not use_redis:&#10;    app.config['SESSION_TYPE'] = 'filesystem'&#10;    if 'SESSION_REDIS' in app.config:&#10;        app.config.pop('SESSION_REDIS', None)&#10;    print(&quot;[main] Session backend: filesystem&quot;)&#10;&#10;# TEPRVE NYNÍ inicializuj Flask-Session (s už nastaveným SECRET_KEY)&#10;Session(app)&#10;from security_ext import init_security&#10;&#10;# Konfigurace&#10;app.config['UPLOAD_FOLDER'] = 'static/profile_pics'&#10;app.config['ALLOWED_EXTENSIONS'] = {'png', 'jpg', 'jpeg', 'gif'}&#10;app.config['GENIUS_ACCESS_TOKEN'] = os.getenv('GENIUS_ACCESS_TOKEN')&#10;app.config['DEEPL_API_KEY'] = os.getenv('DEEPL_API_KEY')&#10;app.config['MAX_CONTENT_LENGTH'] = 2 * 1024 * 1024  # Max 2 MB upload (profilovky atd.)&#10;&#10;# Registrace blueprintů&#10;app.register_blueprint(main_bp)&#10;app.register_blueprint(auth_bp)&#10;app.register_blueprint(verbs_bp)&#10;app.register_blueprint(exercises_bp)&#10;app.register_blueprint(feedback_bp)&#10;app.register_blueprint(theme_bp)&#10;app.register_blueprint(hangman_bp)&#10;app.register_blueprint(news_bp)&#10;app.register_blueprint(chat_bp)&#10;app.register_blueprint(at_on_bp)&#10;app.register_blueprint(xp_bp)&#10;app.register_blueprint(listening_bp)&#10;app.register_blueprint(review_bp)&#10;app.register_blueprint(obchod_bp)&#10;app.register_blueprint(zpravy_bp)&#10;app.register_blueprint(roleplaying_bp)&#10;app.register_blueprint(ai_bp)&#10;app.register_blueprint(pexeso_bp)&#10;app.register_blueprint(drawing_bp)&#10;app.register_blueprint(psani_bp)&#10;app.register_blueprint(user_stats_bp)&#10;app.register_blueprint(admin_bp)&#10;app.register_blueprint(vlastni_music_bp)&#10;app.register_blueprint(proc_bp)&#10;&#10;&#10;@app.route('/sitemap.xml')&#10;def sitemap():&#10;    return send_from_directory('templates', 'sitemap.xml')&#10;&#10;&#10;@app.route('/robots.txt')&#10;def robots_txt():&#10;    return send_from_directory('templates', 'robots.txt')&#10;&#10;&#10;@app.before_request&#10;def redirect_to_main_domain():&#10;    host = request.host.split(':')[0]&#10;&#10;    # Debug vstupních requestů kolem loginu/registrace/indexu&#10;    if request.path in ('/login', '/register', '/'):&#10;        try:&#10;            cookie_name = app.config.get('SESSION_COOKIE_NAME', 'session')&#10;            sid = request.cookies.get(cookie_name)&#10;            print(&#10;                f&quot;[before_request] host={host} path={request.path} method={request.method} session_keys={list(session.keys())} sid={sid}&quot;)&#10;        except Exception:&#10;            pass&#10;&#10;    # Nastav cookie doménu a secure podle hostu&#10;    if host.endswith('knowix.cz'):&#10;        app.config['SESSION_COOKIE_DOMAIN'] = '.knowix.cz'&#10;        app.config['SESSION_COOKIE_SECURE'] = True&#10;        app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'&#10;    elif host in ('localhost', '127.0.0.1'):&#10;        # Lokální vývoj: nepoužívej Secure, žádná doména&#10;        app.config['SESSION_COOKIE_DOMAIN'] = None&#10;        app.config['SESSION_COOKIE_SECURE'] = False&#10;        app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'&#10;&#10;    # Preferovaný host – přesměrování na www&#10;    redirect_hosts = (&quot;knowix.cz&quot;, &quot;knowix.up.railway.app&quot;)&#10;    if host in redirect_hosts:&#10;        target = &quot;https://www.knowix.cz&quot; + request.full_path&#10;        code = 308 if request.method not in (&quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;) else 301&#10;        return redirect(target, code=code)&#10;&#10;    # Vynucení permanentních session pro přihlášené&#10;    if 'user_id' in session:&#10;        session.permanent = True&#10;        # Force session refresh to ensure cookies are sent&#10;&#10;&#10;# Inicializace bezpečnostních rozšíření (CSRF + rate limiting)&#10;init_security(app)&#10;&#10;session.modified = True&#10;&#10;&#10;@app.route('/static/profile_pics/&lt;path:filename&gt;')&#10;def serve_profile_pic(filename):&#10;    &quot;&quot;&quot;Slouží profile obrázky s fallbackem na default obrázek&quot;&quot;&quot;&#10;    try:&#10;        return send_from_directory('static/profile_pics', filename)&#10;    except:&#10;        # Fallback na default avatar pokud obrázek neexistuje&#10;        return send_from_directory('static/pic', 'default_avatar.png')&#10;&#10;&#10;@app.context_processor&#10;def inject_streak():&#10;    user_id = session.get('user_id')&#10;    if user_id:&#10;        streak = get_user_streak(user_id)&#10;        return dict(user_streak=streak)&#10;    return dict(user_streak=0)&#10;&#10;&#10;@app.errorhandler(502)&#10;@app.errorhandler(503)&#10;@app.errorhandler(504)&#10;@app.errorhandler(500)&#10;@app.errorhandler(404)&#10;@app.errorhandler(Exception)&#10;def server_error(e):&#10;    code = getattr(e, 'code', 500)&#10;    tb = traceback.format_exc()&#10;&#10;    # Pokud klient očekává JSON (AJAX fetch na JSON endpoint), vrať JSON místo HTML&#10;    wants_json = ('application/json' in request.headers.get('Accept', '')) or \&#10;                 ('application/json' in request.headers.get('Content-Type', '')) or \&#10;                 request.path.endswith('/check-answer')&#10;    if wants_json:&#10;        return jsonify({&#10;            'error': str(e),&#10;            'code': code,&#10;            'traceback': tb&#10;        }), code&#10;&#10;    return render_template(&#10;        'error.html',&#10;        error_code=code,&#10;        error_message=str(e),&#10;        error_traceback=tb&#10;    ), code&#10;&#10;&#10;LEVEL_NAMES = [&#10;    &quot;Začátečník&quot;, &quot;Učeň&quot;, &quot;Student&quot;, &quot;Pokročilý&quot;, &quot;Expert Knowixu&quot;, &quot;Mistr&quot;, &quot;Legenda&quot;, &quot;Volax&quot;, &quot;Král Knowixu&quot;&#10;]&#10;&#10;&#10;def get_level_name(level):&#10;    if level &lt;= 1:&#10;        return LEVEL_NAMES[0]&#10;    elif level &lt;= 2:&#10;        return LEVEL_NAMES[1]&#10;    elif level &lt;= 4:&#10;        return LEVEL_NAMES[2]&#10;    elif level &lt;= 5:&#10;        return LEVEL_NAMES[3]&#10;    elif level &lt;= 6:&#10;        return LEVEL_NAMES[4]&#10;    elif level &lt;= 8:&#10;        return LEVEL_NAMES[5]&#10;    elif level &lt;= 10:&#10;        return LEVEL_NAMES[6]&#10;    elif level &lt;= 12:&#10;        return LEVEL_NAMES[7]&#10;    elif level &lt;= 15:&#10;        return LEVEL_NAMES[8]&#10;    else:&#10;        return LEVEL_NAMES[-1]&#10;&#10;&#10;@app.context_processor&#10;def inject_xp_info():&#10;    user_id = session.get('user_id')&#10;    if user_id:&#10;        user_data = get_user_xp_and_level(user_id)&#10;        xp = user_data.get(&quot;xp&quot;, 0)&#10;        level = user_data.get(&quot;level&quot;, 1)&#10;        xp_in_level = xp % 50&#10;        percent = int((xp_in_level / 50) * 100)&#10;        level_name = get_level_name(level)&#10;        return dict(&#10;            user_xp=xp,&#10;            user_level=level,&#10;            user_level_name=level_name,&#10;            user_progress_percent=percent,&#10;            user_xp_in_level=xp_in_level&#10;        )&#10;    return {}&#10;&#10;&#10;@app.after_request&#10;def add_security_headers(response):&#10;    # Debug odchozí odpovědi pro login/registraci/index&#10;    if request.path in ('/login', '/register', '/'):&#10;        try:&#10;            cookie_name = app.config.get('SESSION_COOKIE_NAME', 'session')&#10;            has_set_cookie = any(h.lower() == 'set-cookie' for h in response.headers.keys())&#10;            set_cookie_header = response.headers.get('Set-Cookie')&#10;            sid_req = request.cookies.get(cookie_name)&#10;            print(&#10;                f&quot;[after_request] host={request.host} path={request.path} status={response.status_code} set_cookie={has_set_cookie} sid_req={sid_req} cookie_domain={app.config.get('SESSION_COOKIE_DOMAIN')} samesite={app.config.get('SESSION_COOKIE_SAMESITE')} secure={app.config.get('SESSION_COOKIE_SECURE')} set_cookie_header={set_cookie_header[:160] if set_cookie_header else None}&quot;)&#10;        except Exception:&#10;            pass&#10;&#10;    # Vylepšená CSP politika s podporou pro Google Analytics a další služby&#10;    response.headers['Content-Security-Policy'] = (&#10;        &quot;default-src 'self'; &quot;&#10;        &quot;base-uri 'self'; &quot;&#10;        &quot;script-src 'self' 'unsafe-inline' 'unsafe-eval' &quot;&#10;        &quot;https://cdn.quilljs.com https://cdn.jsdelivr.net &quot;&#10;        &quot;https://www.youtube.com https://s.ytimg.com &quot;&#10;        &quot;https://www.googletagmanager.com https://www.google-analytics.com &quot;&#10;        &quot;https://ssl.google-analytics.com; &quot;&#10;        &quot;style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.quilljs.com; &quot;&#10;        &quot;font-src 'self' https://fonts.gstatic.com; &quot;&#10;        &quot;img-src 'self' data: https: blob: https://www.google-analytics.com https://ssl.google-analytics.com https://www.googletagmanager.com https://stats.g.doubleclick.net; &quot;&#10;        &quot;connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com https://region1.analytics.google.com https://analytics.google.com https://stats.g.doubleclick.net https://www.googletagmanager.com; &quot;&#10;        &quot;frame-src https://open.spotify.com https://*.spotify.com https://www.youtube-nocookie.com https://www.youtube.com https://*.youtube.com; &quot;&#10;        &quot;object-src 'none'; frame-ancestors 'none'; upgrade-insecure-requests;&quot;&#10;    )&#10;    # Přidána Permissions-Policy&#10;    response.headers['Permissions-Policy'] = (&#10;        &quot;geolocation=(), microphone=(), camera=(), fullscreen=(self), magnetometer=(), gyroscope=(), usb=(), payment=()&quot;&#10;    )&#10;&#10;    # Ensure cookies are properly set for authenticated users&#10;    if 'user_id' in session and request.path in ('/login', '/register'):&#10;        response.set_cookie(&#10;            app.config.get('SESSION_COOKIE_NAME', 'knowix_session'),&#10;            value=session.get('_id', ''),&#10;            domain=app.config.get('SESSION_COOKIE_DOMAIN'),&#10;            secure=app.config.get('SESSION_COOKIE_SECURE', True),&#10;            httponly=app.config.get('SESSION_COOKIE_HTTPONLY', True),&#10;            samesite=app.config.get('SESSION_COOKIE_SAMESITE', 'Lax'),&#10;            max_age=app.config.get('PERMANENT_SESSION_LIFETIME', 60 * 60 * 24 * 30)&#10;        )&#10;&#10;    response.headers['Strict-Transport-Security'] = 'max-age=63072000; includeSubDomains; preload'&#10;    response.headers['X-Frame-Options'] = 'DENY'&#10;    response.headers['Cross-Origin-Opener-Policy'] = 'same-origin'&#10;    response.headers['Cross-Origin-Resource-Policy'] = 'same-origin'&#10;    response.headers['X-Content-Type-Options'] = 'nosniff'&#10;    response.headers['Referrer-Policy'] = 'no-referrer-when-downgrade'&#10;    return response&#10;&#10;&#10;# app.run(debug=True, port=5000)&#10;#     from waitress import serve&#10;#&#10;#     serve(app, host=&quot;0.0.0.0&quot;, port=8080)&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    app.run(debug=True, port=5000)&#10;" />
              <option name="updatedContent" value="# --- Flask and SocketIO imports ---&#10;from dotenv import load_dotenv&#10;from flask import Flask, render_template, session, send_from_directory, request, redirect, jsonify, g&#10;from flask_session import Session&#10;from streak import get_user_streak&#10;import traceback&#10;import redis&#10;from werkzeug.middleware.proxy_fix import ProxyFix&#10;import os&#10;&#10;# Import všech blueprintů&#10;from A1_music import exercises_bp&#10;from ai import ai_bp&#10;from at_on import at_on_bp&#10;from auth import auth_bp&#10;from chat import zpravy_bp&#10;from feedback import feedback_bp&#10;from hangman import hangman_bp&#10;from listening import listening_bp&#10;from main_routes import main_bp&#10;from nepravidelna_slovesa import verbs_bp&#10;from news import news_bp&#10;from obchod import obchod_bp&#10;from present_perfect import chat_bp&#10;from review import review_bp&#10;from roleplaying import roleplaying_bp&#10;from theme import theme_bp&#10;from pexeso import pexeso_bp, register_socketio_handlers&#10;from xp import get_user_xp_and_level&#10;from xp import xp_bp&#10;from drawing import drawing_bp&#10;from psani import psani_bp&#10;from stats import user_stats_bp&#10;from admin import admin_bp&#10;from vlastni_music import vlastni_music_bp&#10;from proc import proc_bp&#10;from security_ext import init_security&#10;&#10;app = Flask(__name__)&#10;&#10;# === ZÁKLADNÍ KONFIG A SESSION BACKEND ===&#10;load_dotenv(dotenv_path=&quot;.env&quot;)&#10;app.secret_key = os.getenv(&quot;SECRET_KEY&quot;)&#10;if not app.secret_key:&#10;    raise RuntimeError(&quot;SECRET_KEY is missing. Set SECRET_KEY in environment.&quot;)&#10;&#10;app.config.update(&#10;    SESSION_TYPE='redis',&#10;    SESSION_COOKIE_NAME=os.getenv('SESSION_COOKIE_NAME', 'knowix_session'),&#10;    SESSION_COOKIE_SAMESITE='Lax',&#10;    SESSION_COOKIE_SECURE=True,          # Přepneme v before_request pro localhost&#10;    SESSION_COOKIE_HTTPONLY=True,&#10;    SESSION_USE_SIGNER=True,&#10;    PERMANENT_SESSION_LIFETIME=60 * 60 * 24 * 30,  # 30 dní&#10;    SESSION_REFRESH_EACH_REQUEST=True,&#10;    UPLOAD_FOLDER='static/profile_pics',&#10;    ALLOWED_EXTENSIONS={'png', 'jpg', 'jpeg', 'gif'},&#10;    GENIUS_ACCESS_TOKEN=os.getenv('GENIUS_ACCESS_TOKEN'),&#10;    DEEPL_API_KEY=os.getenv('DEEPL_API_KEY'),&#10;    MAX_CONTENT_LENGTH=2 * 1024 * 1024&#10;)&#10;&#10;redis_url = os.getenv('REDIS_URL')&#10;use_redis = False&#10;if redis_url:&#10;    try:&#10;        app.config['SESSION_REDIS'] = redis.from_url(redis_url)&#10;        app.config['SESSION_REDIS'].ping()&#10;        use_redis = True&#10;        print(f&quot;[main] Session backend: Redis OK -&gt; {redis_url}&quot;)&#10;    except Exception as ex:&#10;        print(f&quot;[main] WARNING: Redis ping failed ({ex}). Falling back to filesystem sessions.&quot;)&#10;&#10;if not use_redis:&#10;    app.config['SESSION_TYPE'] = 'filesystem'&#10;    app.config.pop('SESSION_REDIS', None)&#10;    print(&quot;[main] Session backend: filesystem&quot;)&#10;&#10;# Proxy fix kvůli správnému HTTPS z pohledu Flasku&#10;app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_port=1)&#10;&#10;Session(app)&#10;&#10;# === Registrace blueprintů ===&#10;app.register_blueprint(main_bp)&#10;app.register_blueprint(auth_bp)&#10;app.register_blueprint(verbs_bp)&#10;app.register_blueprint(exercises_bp)&#10;app.register_blueprint(feedback_bp)&#10;app.register_blueprint(theme_bp)&#10;app.register_blueprint(hangman_bp)&#10;app.register_blueprint(news_bp)&#10;app.register_blueprint(chat_bp)&#10;app.register_blueprint(at_on_bp)&#10;app.register_blueprint(xp_bp)&#10;app.register_blueprint(listening_bp)&#10;app.register_blueprint(review_bp)&#10;app.register_blueprint(obchod_bp)&#10;app.register_blueprint(zpravy_bp)&#10;app.register_blueprint(roleplaying_bp)&#10;app.register_blueprint(ai_bp)&#10;app.register_blueprint(pexeso_bp)&#10;app.register_blueprint(drawing_bp)&#10;app.register_blueprint(psani_bp)&#10;app.register_blueprint(user_stats_bp)&#10;app.register_blueprint(admin_bp)&#10;app.register_blueprint(vlastni_music_bp)&#10;app.register_blueprint(proc_bp)&#10;&#10;# === Sitemap &amp; robots ===&#10;@app.route('/sitemap.xml')&#10;def sitemap():&#10;    return send_from_directory('templates', 'sitemap.xml')&#10;&#10;&#10;@app.route('/robots.txt')&#10;def robots_txt():&#10;    return send_from_directory('templates', 'robots.txt')&#10;&#10;&#10;# === BEFORE_REQUEST: doména, secure, redirect, refresh ===&#10;@app.before_request&#10;def handle_domain_and_session():&#10;    host = request.host.split(':')[0]&#10;&#10;    # Logy pro debug login/registrace/index&#10;    if request.path in ('/login', '/register', '/'):&#10;        cookie_name = app.config.get('SESSION_COOKIE_NAME', 'session')&#10;        print(f&quot;[before_request] host={host} path={request.path} method={request.method} session_keys={list(session.keys())} sid={request.cookies.get(cookie_name)}&quot;)&#10;&#10;    # Dynamicky přenastav cookie parametry – musí být stabilní pro daný host (www i root přesměrujeme na www)&#10;    if host.endswith('knowix.cz'):&#10;        app.config['SESSION_COOKIE_DOMAIN'] = '.knowix.cz'&#10;        app.config['SESSION_COOKIE_SECURE'] = True&#10;    elif host in ('localhost', '127.0.0.1'):&#10;        app.config['SESSION_COOKIE_DOMAIN'] = None&#10;        app.config['SESSION_COOKIE_SECURE'] = False&#10;    else:&#10;        # Default pro jiné hosty (např. preview)&#10;        app.config['SESSION_COOKIE_DOMAIN'] = None&#10;&#10;    # Přesměruj holou doménu na www pro konzistentní cookie doménu&#10;    if host in (&quot;knowix.cz&quot;, &quot;knowix.up.railway.app&quot;):&#10;        target = &quot;https://www.knowix.cz&quot; + request.full_path&#10;        code = 308 if request.method not in (&quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;) else 301&#10;        return redirect(target, code=code)&#10;&#10;    # Permanentní session pro přihlášené&#10;    if 'user_id' in session:&#10;        session.permanent = True&#10;        # Lehké dotknutí se session jednou za X minut kvůli refresh cookie&#10;        # (Flask ji po změně nebo díky SESSION_REFRESH_EACH_REQUEST obnoví)&#10;        session.setdefault('_last_refresh', 0)&#10;        # nepoužijeme čas – stačí existence klíče, případně by se dalo aktualizovat timestamp&#10;&#10;    # Flag pro after_request zda byla session změněna explicitně (informativní)&#10;    g.session_keys_before = set(session.keys())&#10;&#10;&#10;# === INIT SECURITY (CSRF, rate limiting, atd.) ===&#10;init_security(app)&#10;&#10;&#10;# === Servírování profilovek s fallbackem ===&#10;@app.route('/static/profile_pics/&lt;path:filename&gt;')&#10;def serve_profile_pic(filename):&#10;    try:&#10;        return send_from_directory('static/profile_pics', filename)&#10;    except Exception:&#10;        # Bezpečný fallback&#10;        try:&#10;            return send_from_directory('static/profile_pics', 'default.webp')&#10;        except Exception:&#10;            return send_from_directory('static', 'favicon.ico')  # poslední fallback&#10;&#10;&#10;# === Context procesory ===&#10;@app.context_processor&#10;def inject_streak():&#10;    user_id = session.get('user_id')&#10;    if user_id:&#10;        return dict(user_streak=get_user_streak(user_id))&#10;    return dict(user_streak=0)&#10;&#10;&#10;LEVEL_NAMES = [&#10;    &quot;Začátečník&quot;, &quot;Učeň&quot;, &quot;Student&quot;, &quot;Pokročilý&quot;, &quot;Expert Knowixu&quot;, &quot;Mistr&quot;, &quot;Legenda&quot;, &quot;Volax&quot;, &quot;Král Knowixu&quot;&#10;]&#10;&#10;&#10;def get_level_name(level):&#10;    if level &lt;= 1:&#10;        return LEVEL_NAMES[0]&#10;    elif level &lt;= 2:&#10;        return LEVEL_NAMES[1]&#10;    elif level &lt;= 4:&#10;        return LEVEL_NAMES[2]&#10;    elif level &lt;= 5:&#10;        return LEVEL_NAMES[3]&#10;    elif level &lt;= 6:&#10;        return LEVEL_NAMES[4]&#10;    elif level &lt;= 8:&#10;        return LEVEL_NAMES[5]&#10;    elif level &lt;= 10:&#10;        return LEVEL_NAMES[6]&#10;    elif level &lt;= 12:&#10;        return LEVEL_NAMES[7]&#10;    elif level &lt;= 15:&#10;        return LEVEL_NAMES[8]&#10;    else:&#10;        return LEVEL_NAMES[-1]&#10;&#10;&#10;@app.context_processor&#10;def inject_xp_info():&#10;    user_id = session.get('user_id')&#10;    if user_id:&#10;        user_data = get_user_xp_and_level(user_id)&#10;        xp = user_data.get(&quot;xp&quot;, 0)&#10;        level = user_data.get(&quot;level&quot;, 1)&#10;        xp_in_level = xp % 50&#10;        percent = int((xp_in_level / 50) * 100)&#10;        return dict(&#10;            user_xp=xp,&#10;            user_level=level,&#10;            user_level_name=get_level_name(level),&#10;            user_progress_percent=percent,&#10;            user_xp_in_level=xp_in_level&#10;        )&#10;    return {}&#10;&#10;&#10;# === Error handler (HTML nebo JSON) ===&#10;@app.errorhandler(502)&#10;@app.errorhandler(503)&#10;@app.errorhandler(504)&#10;@app.errorhandler(500)&#10;@app.errorhandler(404)&#10;@app.errorhandler(Exception)&#10;def server_error(e):&#10;    code = getattr(e, 'code', 500)&#10;    tb = traceback.format_exc()&#10;    wants_json = ('application/json' in request.headers.get('Accept', '')) or \&#10;                 ('application/json' in request.headers.get('Content-Type', '')) or \&#10;                 request.path.endswith('/check-answer')&#10;    if wants_json:&#10;        return jsonify({'error': str(e), 'code': code, 'traceback': tb}), code&#10;    return render_template('error.html', error_code=code, error_message=str(e), error_traceback=tb), code&#10;&#10;&#10;# === AFTER_REQUEST: bezpečnostní hlavičky + debug ===&#10;@app.after_request&#10;def add_security_headers(response):&#10;    if request.path in ('/login', '/register', '/'):&#10;        cookie_name = app.config.get('SESSION_COOKIE_NAME', 'session')&#10;        set_cookie_header = response.headers.get('Set-Cookie')&#10;        print(&#10;            f&quot;[after_request] host={request.host} path={request.path} status={response.status_code} set_cookie={'Set-Cookie' in response.headers} cookie_domain={app.config.get('SESSION_COOKIE_DOMAIN')} samesite={app.config.get('SESSION_COOKIE_SAMESITE')} secure={app.config.get('SESSION_COOKIE_SECURE')} set_cookie_header={set_cookie_header[:160] if set_cookie_header else None}&quot;)&#10;&#10;    # CSP (rozšířená o GA domény) – pokud něco chybí, doplnit zde&#10;    response.headers['Content-Security-Policy'] = (&#10;        &quot;default-src 'self'; &quot;&#10;        &quot;base-uri 'self'; &quot;&#10;        &quot;script-src 'self' 'unsafe-inline' 'unsafe-eval' &quot;&#10;        &quot;https://cdn.quilljs.com https://cdn.jsdelivr.net &quot;&#10;        &quot;https://www.youtube.com https://s.ytimg.com &quot;&#10;        &quot;https://www.googletagmanager.com https://www.google-analytics.com https://ssl.google-analytics.com; &quot;&#10;        &quot;style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.quilljs.com; &quot;&#10;        &quot;font-src 'self' https://fonts.gstatic.com; &quot;&#10;        &quot;img-src 'self' data: https: blob: https://www.google-analytics.com https://ssl.google-analytics.com https://www.googletagmanager.com https://stats.g.doubleclick.net; &quot;&#10;        &quot;connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com https://region1.analytics.google.com https://analytics.google.com https://stats.g.doubleclick.net https://www.googletagmanager.com; &quot;&#10;        &quot;frame-src https://open.spotify.com https://*.spotify.com https://www.youtube-nocookie.com https://www.youtube.com https://*.youtube.com; &quot;&#10;        &quot;object-src 'none'; frame-ancestors 'none'; upgrade-insecure-requests;&quot;&#10;    )&#10;    response.headers['Permissions-Policy'] = (&#10;        &quot;geolocation=(), microphone=(), camera=(), fullscreen=(self), magnetometer=(), gyroscope=(), usb=(), payment=()&quot;&#10;    )&#10;    response.headers['Strict-Transport-Security'] = 'max-age=63072000; includeSubDomains; preload'&#10;    response.headers['X-Frame-Options'] = 'DENY'&#10;    response.headers['Cross-Origin-Opener-Policy'] = 'same-origin'&#10;    response.headers['Cross-Origin-Resource-Policy'] = 'same-origin'&#10;    response.headers['X-Content-Type-Options'] = 'nosniff'&#10;    response.headers['Referrer-Policy'] = 'no-referrer-when-downgrade'&#10;    return response&#10;&#10;&#10;# === Spuštění aplikace ===&#10;if __name__ == &quot;__main__&quot;:&#10;    from waitress import serve&#10;    serve(app, host=&quot;0.0.0.0&quot;, port=8080)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/anglictina/app/security_ext.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/anglictina/app/security_ext.py" />
              <option name="originalContent" value="    # Make token generator available to Jinja&#10;    app.jinja_env.globals['csrf_token'] = _ensure_csrf_token&#10;" />
              <option name="updatedContent" value="import os, secrets&#10;from flask import session, request, abort&#10;from flask_limiter import Limiter&#10;from flask_limiter.util import get_remote_address&#10;&#10;# Inteligentní volba storage pro limiter (Redis -&gt; fallback memory)&#10;&#10;&#10;def _determine_storage_uri():&#10;    # Vynucení paměťového backendu pro lokální vývoj nebo proměnnou&#10;    if os.getenv('FLASK_ENV') == 'development' or os.getenv('USE_MEMORY_LIMITER') == '1':&#10;        return 'memory://'&#10;    redis_url = os.getenv('REDIS_URL')&#10;    if not redis_url:&#10;        return 'memory://'&#10;    try:&#10;        import redis&#10;&#10;        r = redis.from_url(redis_url, socket_connect_timeout=0.5, socket_timeout=0.5)&#10;        r.ping()&#10;        return redis_url&#10;    except Exception as ex:&#10;        print(f&quot;[security_ext] Redis limiter nedostupný ({ex}), přepínám na in-memory limiter.&quot;)&#10;        return 'memory://'&#10;&#10;&#10;_storage_uri = _determine_storage_uri()&#10;&#10;# Central Limiter instance (fallback už vyřešen výše)&#10;limiter = Limiter(&#10;    get_remote_address,&#10;    storage_uri=_storage_uri,&#10;    default_limits=[&quot;300 per hour&quot;, &quot;100 per 15 minutes&quot;],&#10;    headers_enabled=True&#10;)&#10;&#10;CSRF_METHODS = {&quot;POST&quot;, &quot;PUT&quot;, &quot;PATCH&quot;, &quot;DELETE&quot;}&#10;EXEMPT_ENDPOINTS = set()&#10;&#10;&#10;def _ensure_csrf_token():&#10;    token = session.get('_csrf_token')&#10;    if not token:&#10;        token = secrets.token_urlsafe(32)&#10;        session['_csrf_token'] = token&#10;    return token&#10;&#10;&#10;def init_security(app):&#10;    # Pokud se mezitím změnilo prostředí (např. import proběhl s REDIS_URL, ale lokálně ho nechceme),&#10;    # můžeme případně re‑inicializovat limiter (volitelně – zde stačí stávající konfigurace).&#10;    limiter.init_app(app)&#10;&#10;    @app.before_request&#10;    def _csrf_protect():&#10;        if request.method in CSRF_METHODS:&#10;            if request.endpoint in EXEMPT_ENDPOINTS:&#10;                return&#10;            if request.endpoint and request.endpoint.startswith('static'):&#10;                return&#10;            session_token = session.get('_csrf_token')&#10;            sent_token = None&#10;            if request.is_json:&#10;                data = request.get_json(silent=True) or {}&#10;                sent_token = data.get('csrf_token')&#10;            if sent_token is None:&#10;                sent_token = request.form.get('csrf_token') or request.headers.get('X-CSRFToken')&#10;            if not session_token or not sent_token or session_token != sent_token:&#10;                abort(400)&#10;&#10;    app.jinja_env.globals['csrf_token'] = _ensure_csrf_token" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/anglictina/app/templates/index.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/anglictina/app/templates/index.html" />
              <option name="originalContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;cs&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#10;          &lt;meta name=&quot;description&quot; content=&quot;Zábavné procvičování angličtiny pomocí písniček, chatu a testů. Knowix je zdarma a bez reklam.&quot;&gt;&#10;  &lt;meta name=&quot;keywords&quot; content=&quot;angličtina, procvičování, písničky, testy, chat, výuka, zdarma, knowix, zábava, škola&quot;&gt;&#10;  &lt;meta name=&quot;robots&quot; content=&quot;index, follow&quot;&gt;&#10;    &lt;meta property=&quot;og:title&quot; content=&quot;Knowix – Procvičování angličtiny zdarma&quot;&gt;&#10;&lt;meta property=&quot;og:description&quot; content=&quot;Procvičuj angličtinu zábavně pomocí písniček, chatu a testů. Bez reklam, zdarma.&quot;&gt;&#10;&lt;meta property=&quot;og:url&quot; content=&quot;https://www.knowix.cz&quot;&gt;&#10;&lt;meta property=&quot;og:type&quot; content=&quot;website&quot;&gt;&#10;&lt;meta property=&quot;og:image&quot; content=&quot;https://knowix.cz/static/og-banner.png&quot;&gt;&#10;&#10;    &lt;link rel=&quot;canonical&quot; href=&quot;https://www.knowix.cz&quot;&gt;&#10;&#10;&#10;    &lt;title&gt;knowix&lt;/title&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/style.css&quot;&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/mobile_header.css&quot;&gt;&#10;&#10;    &lt;!-- Preconnect zrychlí DNS a spojení --&gt;&#10;    &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;&gt;&#10;    &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin&gt;&#10;&#10;    &lt;!-- Font načti až po načtení stránky --&gt;&#10;    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&amp;display=swap&quot; rel=&quot;stylesheet&quot;&#10;          media=&quot;print&quot; onload=&quot;this.media='all'&quot;&gt;&#10;    &lt;noscript&gt;&#10;        &lt;link href=&quot;https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;&#10;    &lt;/noscript&gt;&#10;&#10;    &lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;{{ url_for('static', filename='favicon.ico') }}&quot;&gt;&#10;&#10;    &lt;!-- Google tag (gtag.js) --&gt;&#10;&lt;script async src=&quot;https://www.googletagmanager.com/gtag/js?id=G-W1EN990JKP&quot;&gt;&lt;/script&gt;&#10;&lt;script&gt;&#10;  window.dataLayer = window.dataLayer || [];&#10;  function gtag(){dataLayer.push(arguments);}&#10;  gtag('js', new Date());&#10;&#10;  gtag('config', 'G-W1EN990JKP');&#10;&lt;/script&gt;&#10;    &lt;script type=&quot;application/ld+json&quot;&gt;&#10;{&#10;  &quot;@context&quot;: &quot;https://schema.org&quot;,&#10;  &quot;@type&quot;: &quot;WebSite&quot;,&#10;  &quot;name&quot;: &quot;Knowix&quot;,&#10;  &quot;url&quot;: &quot;https://www.knowix.cz&quot;,&#10;  &quot;description&quot;: &quot;Zábavné procvičování angličtiny pomocí písniček, chatu a testů. Knowix je zdarma a bez reklam.&quot;&#10;}&#10;&lt;/script&gt;&#10;&#10;    &lt;style&gt;&#10;        .alpha-badge {&#10;            font-size: 1.2em;&#10;            font-weight: bold;&#10;            color: red;&#10;            text-transform: uppercase;&#10;            letter-spacing: 2px;&#10;            margin-top: 10px;&#10;            display: inline-block;&#10;            padding: 5px 15px;&#10;            border-radius: 20px;&#10;            background: rgba(255, 0, 0, 0.1);&#10;        }&#10;        .footer-signature {&#10;            font-size: 1em;&#10;            font-weight: bold;&#10;            color: #666;&#10;            margin-top: 10px;&#10;        }&#10;        .logo-name {&#10;            font-size: 4rem;&#10;            color: #2c3e50;&#10;            text-transform: lowercase;&#10;            margin-bottom: 15px;&#10;            letter-spacing: -2px;&#10;        }&#10;        .profile-container {&#10;            position: relative;&#10;        }&#10;        .profile-pic {&#10;            border-radius: 50%;&#10;        }&#10;        .profile-menu {&#10;            position: absolute;&#10;            top: 70px;&#10;            right: 0;&#10;            background-color: white;&#10;            border: 1px solid #ddd;&#10;            border-radius: 8px;&#10;            padding: 10px;&#10;            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);&#10;            opacity: 0;&#10;            visibility: hidden;&#10;            transform: translateY(10px);&#10;            transition: all 0.3s ease-in-out;&#10;        }&#10;        .profile-container:hover .profile-menu {&#10;            opacity: 1;&#10;            visibility: visible;&#10;            transform: translateY(0);&#10;        }&#10;        /* XP Progress bar v headeru */&#10;        .xp-header-bar {&#10;            margin-top: 0.5em;&#10;            margin-bottom: 0.5em;&#10;            width: 220px;&#10;            max-width: 90vw;&#10;        }&#10;        .xp-header-bar-labels {&#10;            display: flex;&#10;            justify-content: space-between;&#10;            align-items: center;&#10;            font-size: 1em;&#10;            margin-bottom: 0.2em;&#10;        }&#10;        .xp-level-badge {&#10;            background: #4CAF50;&#10;            color: #fff;&#10;            border-radius: 8px;&#10;            padding: 2px 10px;&#10;            font-weight: 600;&#10;            font-size: 0.95em;&#10;            margin-right: 0.5em;&#10;        }&#10;        .xp-value {&#10;            color: #333;&#10;            font-size: 0.95em;&#10;        }&#10;        body.dark-mode .xp-level-badge {&#10;            background: #2e7d32;&#10;        }&#10;        body.dark-mode .xp-value {&#10;            color: #eee;&#10;        }&#10;        .xp-header-bar-progress-bg {&#10;            background: #e0e0e0;&#10;            border-radius: 8px;&#10;            height: 12px;&#10;            width: 100%;&#10;            overflow: hidden;&#10;            box-shadow: 0 1px 4px rgba(0,0,0,0.04);&#10;        }&#10;        .xp-header-bar-progress {&#10;            height: 100%;&#10;            background: linear-gradient(90deg, #4CAF50 60%, #43a047 100%);&#10;            border-radius: 8px 0 0 8px;&#10;            transition: width 0.4s;&#10;        }&#10;        body.dark-mode .xp-header-bar-progress-bg {&#10;            background: #333;&#10;        }&#10;        body.dark-mode .xp-header-bar-progress {&#10;            background: linear-gradient(90deg, #2e7d32 60%, #1b5e20 100%);&#10;        }&#10;&#10;    &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body class=&quot;{{ 'dark-mode' if session.get('theme') == 'dark' else '' }}&quot;&gt;&#10;&lt;header&gt;&#10;    &lt;div class=&quot;logo-streak-wrapper&quot;&gt;&#10;        &lt;div class=&quot;logo&quot;&gt;&#10;            &lt;a href=&quot;{{ url_for('main.index') }}&quot;&gt;&#10;                &lt;img src=&quot;{{ url_for('static', filename='pic/logo.webp') }}&quot; alt=&quot;Knowix Logo&quot;&gt;&#10;            &lt;/a&gt;&#10;        &lt;/div&gt;&#10;        &lt;span class=&quot;streak-badge&quot;&gt;&#10;            &lt;img src=&quot;/static/fire.svg&quot; alt=&quot;Streak&quot;&gt;&#10;            {{ user_streak }}&#10;        &lt;/span&gt;&#10;    &lt;/div&gt;&#10;    &lt;div class=&quot;nav-profile-wrapper&quot;&gt;&#10;        &lt;ul class=&quot;nav-right&quot;&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/anglictina&quot; title=&quot;Angličtina&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/eng.png') }}&quot; alt=&quot;Angličtina&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/feedback&quot; title=&quot;Feedback&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/chat.png') }}&quot; alt=&quot;Feedback&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/news&quot; title=&quot;Novinky&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/bell.png') }}&quot; alt=&quot;Novinky&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/obchod&quot; title=&quot;Obchod&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/shop.png') }}&quot; alt=&quot;Obchod&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/zpravy&quot; title=&quot;Zprávy&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/mail.png') }}&quot; alt=&quot;Zprávy&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;button id=&quot;theme-toggle&quot; title=&quot;Přepnout téma&quot; style=&quot;background:none;border:none;cursor:pointer;padding:0;&quot;&gt;&#10;                    &#10;                &lt;/button&gt;&#10;            &lt;/li&gt;&#10;        &lt;/ul&gt;&#10;        {% if session['user_name'] %}&#10;        &lt;div class=&quot;user-profile&quot;&gt;&#10;            &lt;div class=&quot;profile-container&quot;&gt;&#10;                {% if session.get('profile_pic') %}&#10;                &lt;img src=&quot;{{ url_for('static', filename='profile_pics/' + session['profile_pic']) }}&quot;&#10;                     alt=&quot;Profilová fotka&quot; width=&quot;64&quot; class=&quot;profile-pic&quot;&#10;                     onerror=&quot;this.onerror=null; this.src='{{ url_for('static', filename='pic/default.webp') }}';&quot;&gt;&#10;                {% else %}&#10;                &lt;img src=&quot;{{ url_for('static', filename='pic/default.webp') }}&quot; alt=&quot;Defaultní profilovka&quot;&#10;                     class=&quot;profile-pic&quot; id=&quot;profileMenuTrigger&quot;&gt;&#10;                {% endif %}&#10;                &lt;div class=&quot;profile-menu&quot; id=&quot;profileMenu&quot;&gt;&#10;                    &lt;a href=&quot;{{ url_for('auth.settings') }}&quot;&gt;⚙️ Nastavení&lt;/a&gt;&#10;                    &lt;a href=&quot;{{ url_for('auth.logout') }}&quot;&gt; Odhlásit se&lt;/a&gt;&#10;                &lt;/div&gt;&#10;                &lt;span class=&quot;greeting&quot; style=&quot;margin-left: 10px;&quot;&gt;Ahoj {{ session['user_name'].split()[0] }}!&lt;/span&gt;&#10;            &lt;/div&gt;&#10;            {% if user_xp is defined and user_level is defined and user_level_name is defined and user_progress_percent is defined %}&#10;            &lt;div class=&quot;xp-header-bar&quot;&gt;&#10;                &lt;div class=&quot;xp-header-bar-labels&quot;&gt;&#10;                    &lt;span class=&quot;xp-level-badge&quot;&gt;Level {{ user_level }} – {{ user_level_name }}&lt;/span&gt;&#10;                    &lt;span class=&quot;xp-value&quot;&gt;{{ user_xp_in_level }}/50 XP&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;xp-header-bar-progress-bg&quot;&gt;&#10;                    &lt;div class=&quot;xp-header-bar-progress&quot; style=&quot;width: {{ user_progress_percent }}%&quot;&gt;&lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;            {% endif %}&#10;        &lt;/div&gt;&#10;        {% else %}&#10;&lt;div class=&quot;auth-links&quot;&gt;&#10;    &lt;a href=&quot;{{ url_for('auth.login') }}&quot; class=&quot;auth-btn login-btn&quot;&gt; Přihlásit se&lt;/a&gt;&#10;    &lt;a href=&quot;{{ url_for('auth.register') }}&quot; class=&quot;auth-btn register-btn&quot;&gt; Registrovat se&lt;/a&gt;&#10;&lt;/div&gt;&#10;        {% endif %}&#10;    &lt;/div&gt;&#10;&lt;/header&gt;&#10;&#10;&lt;main&gt;&#10;    &lt;section class=&quot;intro&quot;&gt;&#10;        &lt;h1 class=&quot;logo-name&quot;&gt;knowix&lt;/h1&gt;&#10;&lt;!--        &lt;span class=&quot;alpha-badge&quot;&gt;ALPHA VERZE&lt;/span&gt;--&gt;&#10;        &lt;h2 class=&quot;motto&quot;&gt;Každý pád je krok vpřed&lt;/h2&gt;&#10;    &lt;/section&gt;&#10;&#10;    &lt;section class=&quot;info&quot;&gt;&#10;&#10;        &lt;div class=&quot;bubble support-bubble&quot; onclick=&quot;window.open('/anglictina', '_blank')&quot;&gt;&#10;            &lt;img src=&quot;{{ url_for('static', filename='icons/eng.png') }}&quot; alt=&quot;angličtina&quot;&gt;&#10;            &lt;div class=&quot;bubble-text&quot;&gt;&#10;                &lt;h3&gt;Angličtina&lt;/h3&gt;&#10;                &lt;p&gt;Zábavné cvičení na téma Angličtina&lt;/p&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;        &lt;div class=&quot;bubble support-bubble&quot; onclick=&quot;window.open('/proc_jit_s_nama', '_blank')&quot;&gt;&#10;            &lt;img src=&quot;{{ url_for('static', filename='pic/why.png') }}&quot; alt=&quot;Podpora&quot;&gt;&#10;            &lt;div class=&quot;bubble-text&quot;&gt;&#10;                &lt;h3&gt;Proč jít s náma?&lt;/h3&gt;&#10;                &lt;p&gt;Klikni na to, a dozvíte se proč jít s náma.&lt;/p&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;        &lt;div class=&quot;bubble&quot;&gt;&#10;            &lt;img src=&quot;{{ url_for('static', filename='pic/logo1.png') }}&quot; alt=&quot;Knowix Logo&quot;&gt;&#10;            &lt;div class=&quot;bubble-text&quot;&gt;&#10;                &lt;h3&gt;Kdo vytvořil Knowix?&lt;/h3&gt;&#10;                &lt;p&gt;Vytvořil žák Vojtěch Kurinec&lt;/p&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;        &lt;div class=&quot;bubble support-bubble&quot; onclick=&quot;window.open('https://ko-fi.com/voku199', '_blank')&quot;&gt;&#10;            &lt;img src=&quot;{{ url_for('static', filename='pic/support.webp') }}&quot; alt=&quot;Podpora&quot;&gt;&#10;            &lt;div class=&quot;bubble-text&quot;&gt;&#10;                &lt;h3&gt;Podpora&lt;/h3&gt;&#10;                &lt;p&gt;Chceš mě finančně podpořit? Klikni na to &lt;/p&gt;&#10;                &lt;p&gt;Dobrovolný příspěvek!&lt;/p&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/section&gt;&#10;&lt;/main&gt;&#10;&#10;&lt;footer&gt;&#10;    &lt;p&gt;&amp;copy; 2025 Knowix. Všechna práva vyhrazena.&lt;/p&gt;&#10;    &lt;p class=&quot;footer-signature&quot;&gt;&#10;        Made with ❤️ by&#10;        &lt;a href=&quot;https://ko-fi.com/voku199&quot; target=&quot;_blank&quot; style=&quot;color: inherit; text-decoration: underline;&quot;&gt;Voku&lt;/a&gt;&#10;        and lot of ☕&#10;    &lt;/p&gt;&#10;&lt;/footer&gt;&#10;&#10;&lt;script&gt;&#10;    // theme-toggle.js&#10;    document.getElementById('theme-toggle').addEventListener('click', () =&gt; {&#10;        fetch('/set_theme', {&#10;            method: 'POST',&#10;            headers: {'Content-Type': 'application/json'},&#10;            body: JSON.stringify({&#10;                theme: document.body.classList.contains('dark-mode') ? 'light' : 'dark'&#10;            })&#10;        }).then(() =&gt; {&#10;            document.body.classList.toggle('dark-mode');&#10;            sessionStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');&#10;        });&#10;    });&#10;&#10;    // Detekce kliknutí mimo menu&#10;    document.addEventListener('click', (e) =&gt; {&#10;        const profileMenu = document.getElementById('profileMenu');&#10;        const trigger = document.getElementById('profileMenuTrigger');&#10;        if (profileMenu &amp;&amp; trigger &amp;&amp; !trigger.contains(e.target) &amp;&amp; !profileMenu.contains(e.target)) {&#10;            profileMenu.style.opacity = '0';&#10;            profileMenu.style.visibility = 'hidden';&#10;            profileMenu.style.transform = 'translateY(10px)';&#10;        }&#10;    });&#10;&lt;/script&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;" />
              <option name="updatedContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;cs&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#10;          &lt;meta name=&quot;description&quot; content=&quot;Zábavné procvičování angličtiny pomocí písniček, chatu a testů. Knowix je zdarma a bez reklam.&quot;&gt;&#10;  &lt;meta name=&quot;keywords&quot; content=&quot;angličtina, procvičování, písničky, testy, chat, výuka, zdarma, knowix, zábava, škola&quot;&gt;&#10;  &lt;meta name=&quot;robots&quot; content=&quot;index, follow&quot;&gt;&#10;    &lt;meta property=&quot;og:title&quot; content=&quot;Knowix – Procvičování angličtiny zdarma&quot;&gt;&#10;&lt;meta property=&quot;og:description&quot; content=&quot;Procvičuj angličtinu zábavně pomocí písniček, chatu a testů. Bez reklam, zdarma.&quot;&gt;&#10;&lt;meta property=&quot;og:url&quot; content=&quot;https://www.knowix.cz&quot;&gt;&#10;&lt;meta property=&quot;og:type&quot; content=&quot;website&quot;&gt;&#10;&lt;meta property=&quot;og:image&quot; content=&quot;https://knowix.cz/static/og-banner.png&quot;&gt;&#10;&#10;    &lt;link rel=&quot;canonical&quot; href=&quot;https://www.knowix.cz&quot;&gt;&#10;&#10;&#10;    &lt;title&gt;knowix&lt;/title&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/style.css&quot;&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/mobile_header.css&quot;&gt;&#10;&#10;    &lt;!-- Preconnect zrychlí DNS a spojení --&gt;&#10;    &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;&gt;&#10;    &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin&gt;&#10;&#10;    &lt;!-- Font načti až po načtení stránky --&gt;&#10;    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&amp;display=swap&quot; rel=&quot;stylesheet&quot;&#10;          media=&quot;print&quot; onload=&quot;this.media='all'&quot;&gt;&#10;    &lt;noscript&gt;&#10;        &lt;link href=&quot;https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;&#10;    &lt;/noscript&gt;&#10;&#10;    &lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;{{ url_for('static', filename='favicon.ico') }}&quot;&gt;&#10;&#10;    &lt;!-- Google tag (gtag.js) --&gt;&#10;&lt;script async src=&quot;https://www.googletagmanager.com/gtag/js?id=G-W1EN990JKP&quot;&gt;&lt;/script&gt;&#10;&lt;script&gt;&#10;  window.dataLayer = window.dataLayer || [];&#10;  function gtag(){dataLayer.push(arguments);}&#10;  gtag('js', new Date());&#10;&#10;  gtag('config', 'G-W1EN990JKP');&#10;&lt;/script&gt;&#10;    &lt;script type=&quot;application/ld+json&quot;&gt;&#10;{&#10;  &quot;@context&quot;: &quot;https://schema.org&quot;,&#10;  &quot;@type&quot;: &quot;WebSite&quot;,&#10;  &quot;name&quot;: &quot;Knowix&quot;,&#10;  &quot;url&quot;: &quot;https://www.knowix.cz&quot;,&#10;  &quot;description&quot;: &quot;Zábavné procvičování angličtiny pomocí písniček, chatu a testů. Knowix je zdarma a bez reklam.&quot;&#10;}&#10;&lt;/script&gt;&#10;&#10;    &lt;style&gt;&#10;        .alpha-badge {&#10;            font-size: 1.2em;&#10;            font-weight: bold;&#10;            color: red;&#10;            text-transform: uppercase;&#10;            letter-spacing: 2px;&#10;            margin-top: 10px;&#10;            display: inline-block;&#10;            padding: 5px 15px;&#10;            border-radius: 20px;&#10;            background: rgba(255, 0, 0, 0.1);&#10;        }&#10;        .footer-signature {&#10;            font-size: 1em;&#10;            font-weight: bold;&#10;            color: #666;&#10;            margin-top: 10px;&#10;        }&#10;        .logo-name {&#10;            font-size: 4rem;&#10;            color: #2c3e50;&#10;            text-transform: lowercase;&#10;            margin-bottom: 15px;&#10;            letter-spacing: -2px;&#10;        }&#10;        .profile-container {&#10;            position: relative;&#10;        }&#10;        .profile-pic {&#10;            border-radius: 50%;&#10;        }&#10;        .profile-menu {&#10;            position: absolute;&#10;            top: 70px;&#10;            right: 0;&#10;            background-color: white;&#10;            border: 1px solid #ddd;&#10;            border-radius: 8px;&#10;            padding: 10px;&#10;            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);&#10;            opacity: 0;&#10;            visibility: hidden;&#10;            transform: translateY(10px);&#10;            transition: all 0.3s ease-in-out;&#10;        }&#10;        .profile-container:hover .profile-menu {&#10;            opacity: 1;&#10;            visibility: visible;&#10;            transform: translateY(0);&#10;        }&#10;        /* XP Progress bar v headeru */&#10;        .xp-header-bar {&#10;            margin-top: 0.5em;&#10;            margin-bottom: 0.5em;&#10;            width: 220px;&#10;            max-width: 90vw;&#10;        }&#10;        .xp-header-bar-labels {&#10;            display: flex;&#10;            justify-content: space-between;&#10;            align-items: center;&#10;            font-size: 1em;&#10;            margin-bottom: 0.2em;&#10;        }&#10;        .xp-level-badge {&#10;            background: #4CAF50;&#10;            color: #fff;&#10;            border-radius: 8px;&#10;            padding: 2px 10px;&#10;            font-weight: 600;&#10;            font-size: 0.95em;&#10;            margin-right: 0.5em;&#10;        }&#10;        .xp-value {&#10;            color: #333;&#10;            font-size: 0.95em;&#10;        }&#10;        body.dark-mode .xp-level-badge {&#10;            background: #2e7d32;&#10;        }&#10;        body.dark-mode .xp-value {&#10;            color: #eee;&#10;        }&#10;        .xp-header-bar-progress-bg {&#10;            background: #e0e0e0;&#10;            border-radius: 8px;&#10;            height: 12px;&#10;            width: 100%;&#10;            overflow: hidden;&#10;            box-shadow: 0 1px 4px rgba(0,0,0,0.04);&#10;        }&#10;        .xp-header-bar-progress {&#10;            height: 100%;&#10;            background: linear-gradient(90deg, #4CAF50 60%, #43a047 100%);&#10;            border-radius: 8px 0 0 8px;&#10;            transition: width 0.4s;&#10;        }&#10;        body.dark-mode .xp-header-bar-progress-bg {&#10;            background: #333;&#10;        }&#10;        body.dark-mode .xp-header-bar-progress {&#10;            background: linear-gradient(90deg, #2e7d32 60%, #1b5e20 100%);&#10;        }&#10;&#10;    &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body class=&quot;{{ 'dark-mode' if session.get('theme') == 'dark' else '' }}&quot;&gt;&#10;&lt;header&gt;&#10;    &lt;div class=&quot;logo-streak-wrapper&quot;&gt;&#10;        &lt;div class=&quot;logo&quot;&gt;&#10;            &lt;a href=&quot;{{ url_for('main.index') }}&quot;&gt;&#10;                &lt;img src=&quot;{{ url_for('static', filename='pic/logo.webp') }}&quot; alt=&quot;Knowix Logo&quot;&gt;&#10;            &lt;/a&gt;&#10;        &lt;/div&gt;&#10;        &lt;span class=&quot;streak-badge&quot;&gt;&#10;            &lt;img src=&quot;/static/fire.svg&quot; alt=&quot;Streak&quot;&gt;&#10;            {{ user_streak }}&#10;        &lt;/span&gt;&#10;    &lt;/div&gt;&#10;    &lt;div class=&quot;nav-profile-wrapper&quot;&gt;&#10;        &lt;ul class=&quot;nav-right&quot;&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/anglictina&quot; title=&quot;Angličtina&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/eng.png') }}&quot; alt=&quot;Angličtina&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/feedback&quot; title=&quot;Feedback&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/chat.png') }}&quot; alt=&quot;Feedback&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/news&quot; title=&quot;Novinky&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/bell.png') }}&quot; alt=&quot;Novinky&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/obchod&quot; title=&quot;Obchod&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/shop.png') }}&quot; alt=&quot;Obchod&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;a href=&quot;/zpravy&quot; title=&quot;Zprávy&quot;&gt;&#10;                    &lt;img src=&quot;{{ url_for('static', filename='icons/mail.png') }}&quot; alt=&quot;Zprávy&quot; class=&quot;nav-icon&quot;&gt;&#10;                &lt;/a&gt;&#10;            &lt;/li&gt;&#10;            &lt;li&gt;&#10;                &lt;button id=&quot;theme-toggle&quot; title=&quot;Přepnout téma&quot; style=&quot;background:none;border:none;cursor:pointer;padding:0;&quot;&gt;&#10;                    &#10;                &lt;/button&gt;&#10;            &lt;/li&gt;&#10;        &lt;/ul&gt;&#10;        {% if session['user_name'] %}&#10;        &lt;div class=&quot;user-profile&quot;&gt;&#10;            &lt;div class=&quot;profile-container&quot;&gt;&#10;                {% if session.get('profile_pic') %}&#10;                &lt;img src=&quot;{{ url_for('static', filename='profile_pics/' + session['profile_pic']) }}&quot;&#10;                     alt=&quot;Profilová fotka&quot; width=&quot;64&quot; class=&quot;profile-pic&quot;&#10;                     onerror=&quot;this.onerror=null; this.src='{{ url_for('static', filename='pic/default.webp') }}';&quot;&gt;&#10;                {% else %}&#10;                &lt;img src=&quot;{{ url_for('static', filename='pic/default.webp') }}&quot; alt=&quot;Defaultní profilovka&quot;&#10;                     class=&quot;profile-pic&quot; id=&quot;profileMenuTrigger&quot;&gt;&#10;                {% endif %}&#10;                &lt;div class=&quot;profile-menu&quot; id=&quot;profileMenu&quot;&gt;&#10;                    &lt;a href=&quot;{{ url_for('auth.settings') }}&quot;&gt;⚙️ Nastavení&lt;/a&gt;&#10;                    &lt;a href=&quot;{{ url_for('auth.logout') }}&quot;&gt; Odhlásit se&lt;/a&gt;&#10;                &lt;/div&gt;&#10;                &lt;span class=&quot;greeting&quot; style=&quot;margin-left: 10px;&quot;&gt;Ahoj {{ session['user_name'].split()[0] }}!&lt;/span&gt;&#10;            &lt;/div&gt;&#10;            {% if user_xp is defined and user_level is defined and user_level_name is defined and user_progress_percent is defined %}&#10;            &lt;div class=&quot;xp-header-bar&quot;&gt;&#10;                &lt;div class=&quot;xp-header-bar-labels&quot;&gt;&#10;                    &lt;span class=&quot;xp-level-badge&quot;&gt;Level {{ user_level }} – {{ user_level_name }}&lt;/span&gt;&#10;                    &lt;span class=&quot;xp-value&quot;&gt;{{ user_xp_in_level }}/50 XP&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;xp-header-bar-progress-bg&quot;&gt;&#10;                    &lt;div class=&quot;xp-header-bar-progress&quot; style=&quot;width: {{ user_progress_percent }}%&quot;&gt;&lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;            {% endif %}&#10;        &lt;/div&gt;&#10;        {% else %}&#10;&lt;div class=&quot;auth-links&quot;&gt;&#10;    &lt;a href=&quot;{{ url_for('auth.login') }}&quot; class=&quot;auth-btn login-btn&quot;&gt; Přihlásit se&lt;/a&gt;&#10;    &lt;a href=&quot;{{ url_for('auth.register') }}&quot; class=&quot;auth-btn register-btn&quot;&gt; Registrovat se&lt;/a&gt;&#10;&lt;/div&gt;&#10;        {% endif %}&#10;    &lt;/div&gt;&#10;&lt;/header&gt;&#10;&#10;&lt;main&gt;&#10;    &lt;section class=&quot;intro&quot;&gt;&#10;        &lt;h1 class=&quot;logo-name&quot;&gt;knowix&lt;/h1&gt;&#10;&lt;!--        &lt;span class=&quot;alpha-badge&quot;&gt;ALPHA VERZE&lt;/span&gt;--&gt;&#10;        &lt;h2 class=&quot;motto&quot;&gt;Každý pád je krok vpřed&lt;/h2&gt;&#10;    &lt;/section&gt;&#10;&#10;    &lt;section class=&quot;info&quot;&gt;&#10;&#10;        &lt;div class=&quot;bubble support-bubble&quot; onclick=&quot;location.href='/anglictina'&quot;&gt;&#10;            &lt;img src=&quot;{{ url_for('static', filename='icons/eng.png') }}&quot; alt=&quot;angličtina&quot;&gt;&#10;            &lt;div class=&quot;bubble-text&quot;&gt;&#10;                &lt;h3&gt;Angličtina&lt;/h3&gt;&#10;                &lt;p&gt;Zábavné cvičení na téma Angličtina&lt;/p&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;        &lt;div class=&quot;bubble support-bubble&quot; onclick=&quot;location.href='/proc_jit_s_nama'&quot;&gt;&#10;            &lt;img src=&quot;{{ url_for('static', filename='pic/why.png') }}&quot; alt=&quot;Podpora&quot;&gt;&#10;            &lt;div class=&quot;bubble-text&quot;&gt;&#10;                &lt;h3&gt;Proč jít s náma?&lt;/h3&gt;&#10;                &lt;p&gt;Klikni na to, a dozvíte se proč jít s náma.&lt;/p&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;        &lt;div class=&quot;bubble&quot;&gt;&#10;            &lt;img src=&quot;{{ url_for('static', filename='pic/logo1.png') }}&quot; alt=&quot;Knowix Logo&quot;&gt;&#10;            &lt;div class=&quot;bubble-text&quot;&gt;&#10;                &lt;h3&gt;Kdo vytvořil Knowix?&lt;/h3&gt;&#10;                &lt;p&gt;Vytvořil žák Vojtěch Kurinec&lt;/p&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;        &lt;div class=&quot;bubble support-bubble&quot; onclick=&quot;window.open('https://ko-fi.com/voku199', '_blank')&quot;&gt;&#10;            &lt;img src=&quot;{{ url_for('static', filename='pic/support.webp') }}&quot; alt=&quot;Podpora&quot;&gt;&#10;            &lt;div class=&quot;bubble-text&quot;&gt;&#10;                &lt;h3&gt;Podpora&lt;/h3&gt;&#10;                &lt;p&gt;Chceš mě finančně podpořit? Klikni na to &lt;/p&gt;&#10;                &lt;p&gt;Dobrovolný příspěvek!&lt;/p&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/section&gt;&#10;&lt;/main&gt;&#10;&#10;&lt;footer&gt;&#10;    &lt;p&gt;&amp;copy; 2025 Knowix. Všechna práva vyhrazena.&lt;/p&gt;&#10;    &lt;p class=&quot;footer-signature&quot;&gt;&#10;        Made with ❤️ by&#10;        &lt;a href=&quot;https://ko-fi.com/voku199&quot; target=&quot;_blank&quot; style=&quot;color: inherit; text-decoration: underline;&quot;&gt;Voku&lt;/a&gt;&#10;        and lot of ☕&#10;    &lt;/p&gt;&#10;&lt;/footer&gt;&#10;&#10;&lt;script&gt;&#10;    const CSRF_TOKEN = &quot;{{ csrf_token() }}&quot;;&#10;    document.getElementById('theme-toggle').addEventListener('click', () =&gt; {&#10;        fetch('/set_theme', {&#10;            method: 'POST',&#10;            headers: {'Content-Type': 'application/json','X-CSRFToken': CSRF_TOKEN},&#10;            body: JSON.stringify({&#10;                theme: document.body.classList.contains('dark-mode') ? 'light' : 'dark',&#10;                csrf_token: CSRF_TOKEN&#10;            })&#10;        }).then(r=&gt;{ if(r.ok){&#10;            document.body.classList.toggle('dark-mode');&#10;            sessionStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');&#10;        }});&#10;    });&#10;&#10;    // Detekce kliknutí mimo menu&#10;    document.addEventListener('click', (e) =&gt; {&#10;        const profileMenu = document.getElementById('profileMenu');&#10;        const trigger = document.getElementById('profileMenuTrigger');&#10;        if (profileMenu &amp;&amp; trigger &amp;&amp; !trigger.contains(e.target) &amp;&amp; !profileMenu.contains(e.target)) {&#10;            profileMenu.style.opacity = '0';&#10;            profileMenu.style.visibility = 'hidden';&#10;            profileMenu.style.transform = 'translateY(10px)';&#10;        }&#10;    });&#10;&lt;/script&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/anglictina/app/templates/login.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/anglictina/app/templates/login.html" />
              <option name="originalContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;cs&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#10;    &lt;title&gt;Přihlášení | Knowix&lt;/title&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;{{ url_for('static', filename='style_reg_log.css') }}&quot;&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;&gt;&#10;    &lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;{{ url_for('static', filename='favicon.ico') }}&quot;&gt;&#10;&lt;/head&gt;&#10;&lt;body&gt;&#10;&lt;nav class=&quot;auth-header&quot;&gt;&#10;    &lt;a href=&quot;/&quot; class=&quot;home-link&quot;&gt;&#10;        &lt;img src=&quot;{{ url_for('static', filename='pic/logo.webp') }}&quot; alt=&quot;Knowix Logo&quot;&gt;&#10;        &lt;span&gt;← Zpět na hlavní stránku&lt;/span&gt;&#10;    &lt;/a&gt;&#10;&lt;/nav&gt;&#10;&#10;&lt;div class=&quot;auth-container&quot;&gt;&#10;    &lt;div class=&quot;auth-title&quot;&gt;&#10;        &lt;div class=&quot;header-icon&quot;&gt;&#10;            &lt;i class=&quot;fas fa-user-circle fa-3x text-primary&quot;&gt;&lt;/i&gt;&#10;        &lt;/div&gt;&#10;        &lt;h2&gt;Vítejte zpět&lt;/h2&gt;&#10;        &lt;p&gt;Pokračujte přihlášením&lt;/p&gt;&#10;    &lt;/div&gt;&#10;&#10;    {% with messages = get_flashed_messages(with_categories=true) %}&#10;    &lt;div class=&quot;flash-messages&quot;&gt;&#10;        {% for category, message in messages %}&#10;        &lt;div class=&quot;flash-message {{ category }}&quot;&gt;&#10;            &lt;i class=&quot;fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}&quot;&gt;&lt;/i&gt;&#10;            {{ message }}&#10;        &lt;/div&gt;&#10;        {% endfor %}&#10;    &lt;/div&gt;&#10;    {% endwith %}&#10;&#10;    &lt;form method=&quot;POST&quot; class=&quot;auth-form&quot;&gt;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;input type=&quot;email&quot; name=&quot;email&quot; placeholder=&quot; &quot; required&gt;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-envelope&quot;&gt;&lt;/i&gt; E-mail&lt;/label&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;input type=&quot;password&quot; name=&quot;password&quot; placeholder=&quot; &quot; required&gt;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-lock&quot;&gt;&lt;/i&gt; Heslo&lt;/label&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;button type=&quot;submit&quot;&gt;Přihlásit se&lt;/button&gt;&#10;    &lt;/form&gt;&#10;&#10;    &lt;div class=&quot;auth-footer&quot;&gt;&#10;        &lt;p&gt;Nemáte účet? &lt;a href=&quot;{{ url_for('auth.register') }}&quot;&gt;Vytvořte si ho&lt;/a&gt;&lt;/p&gt;&#10;        &lt;a href=&quot;{{ url_for('auth.forgot_password') }}&quot;&gt;Zapomněli jste heslo?&lt;/a&gt;&#10;    &lt;/div&gt;&#10;&lt;/div&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;" />
              <option name="updatedContent" value="&lt;!DOCTYPE html&gt;&#13;&#10;&lt;html lang=&quot;cs&quot;&gt;&#13;&#10;&lt;head&gt;&#13;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#13;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#13;&#10;    &lt;title&gt;Přihlášení | Knowix&lt;/title&gt;&#13;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;{{ url_for('static', filename='style_reg_log.css') }}&quot;&gt;&#13;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;&gt;&#13;&#10;    &lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;{{ url_for('static', filename='favicon.ico') }}&quot;&gt;&#13;&#10;&lt;/head&gt;&#13;&#10;&lt;body&gt;&#13;&#10;&lt;nav class=&quot;auth-header&quot;&gt;&#13;&#10;    &lt;a href=&quot;/&quot; class=&quot;home-link&quot;&gt;&#13;&#10;        &lt;img src=&quot;{{ url_for('static', filename='pic/logo.webp') }}&quot; alt=&quot;Knowix Logo&quot;&gt;&#13;&#10;        &lt;span&gt;← Zpět na hlavní stránku&lt;/span&gt;&#13;&#10;    &lt;/a&gt;&#13;&#10;&lt;/nav&gt;&#13;&#10;&#13;&#10;&lt;div class=&quot;auth-container&quot;&gt;&#13;&#10;    &lt;div class=&quot;auth-title&quot;&gt;&#13;&#10;        &lt;div class=&quot;header-icon&quot;&gt;&#13;&#10;            &lt;i class=&quot;fas fa-user-circle fa-3x text-primary&quot;&gt;&lt;/i&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;        &lt;h2&gt;Vítejte zpět&lt;/h2&gt;&#13;&#10;        &lt;p&gt;Pokračujte přihlášením&lt;/p&gt;&#13;&#10;    &lt;/div&gt;&#13;&#10;&#13;&#10;    {% with messages = get_flashed_messages(with_categories=true) %}&#13;&#10;    &lt;div class=&quot;flash-messages&quot;&gt;&#13;&#10;        {% for category, message in messages %}&#13;&#10;        &lt;div class=&quot;flash-message {{ category }}&quot;&gt;&#13;&#10;            &lt;i class=&quot;fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}&quot;&gt;&lt;/i&gt;&#13;&#10;            {{ message }}&#13;&#10;        &lt;/div&gt;&#13;&#10;        {% endfor %}&#13;&#10;    &lt;/div&gt;&#13;&#10;    {% endwith %}&#13;&#10;&#13;&#10;    &lt;form method=&quot;POST&quot; class=&quot;auth-form&quot;&gt;&#13;&#10;        &lt;!-- CSRF token --&gt;&#13;&#10;        &lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;{{ csrf_token() }}&quot;&gt;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;input type=&quot;email&quot; name=&quot;email&quot; placeholder=&quot; &quot; required&gt;&#13;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-envelope&quot;&gt;&lt;/i&gt; E-mail&lt;/label&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;input type=&quot;password&quot; name=&quot;password&quot; placeholder=&quot; &quot; required&gt;&#13;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-lock&quot;&gt;&lt;/i&gt; Heslo&lt;/label&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;button type=&quot;submit&quot;&gt;Přihlásit se&lt;/button&gt;&#13;&#10;    &lt;/form&gt;&#13;&#10;&#13;&#10;    &lt;div class=&quot;auth-footer&quot;&gt;&#13;&#10;        &lt;p&gt;Nemáte účet? &lt;a href=&quot;{{ url_for('auth.register') }}&quot;&gt;Vytvořte si ho&lt;/a&gt;&lt;/p&gt;&#13;&#10;        &lt;a href=&quot;{{ url_for('auth.forgot_password') }}&quot;&gt;Zapomněli jste heslo?&lt;/a&gt;&#13;&#10;    &lt;/div&gt;&#13;&#10;&lt;/div&gt;&#13;&#10;&lt;/body&gt;&#13;&#10;&lt;/html&gt;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/anglictina/app/templates/registrace.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/anglictina/app/templates/registrace.html" />
              <option name="originalContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;cs&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#10;    &lt;title&gt;Registrace | Knowix&lt;/title&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;{{ url_for('static', filename='style_reg_log.css') }}&quot;&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/min.css&quot;&gt;&#10;    &lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;{{ url_for('static', filename='favicon.ico') }}&quot;&gt;&#10;    &lt;style&gt;&#10;        /* Modal styles */&#10;        .modal-bg {&#10;            display: none;&#10;            position: fixed;&#10;            z-index: 1000;&#10;            left: 0;&#10;            top: 0;&#10;            width: 100vw;&#10;            height: 100vh;&#10;            background: rgba(0, 0, 0, 0.4);&#10;            justify-content: center;&#10;            align-items: center;&#10;        }&#10;&#10;        .modal-bg.active {&#10;            display: flex;&#10;        }&#10;&#10;        .modal-content {&#10;            background: #fff;&#10;            padding: 2rem 2.5rem;&#10;            border-radius: 12px;&#10;            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.15);&#10;            max-width: 350px;&#10;            text-align: center;&#10;            position: relative;&#10;        }&#10;&#10;        .modal-content h3 {&#10;            margin-top: 0;&#10;            color: #2c3e50;&#10;        }&#10;&#10;        .modal-close {&#10;            position: absolute;&#10;            top: 12px;&#10;            right: 16px;&#10;            background: none;&#10;            border: none;&#10;            font-size: 1.5rem;&#10;            color: #888;&#10;            cursor: pointer;&#10;        }&#10;&#10;        .modal-content p {&#10;            margin-bottom: 0;&#10;        }&#10;    &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body&gt;&#10;&lt;nav class=&quot;auth-header&quot;&gt;&#10;    &lt;a href=&quot;/&quot; class=&quot;home-link&quot;&gt;&#10;        &lt;img src=&quot;{{ url_for('static', filename='pic/logo.webp') }}&quot; alt=&quot;Knowix Logo&quot;&gt;&#10;        &lt;span&gt;← Zpět na hlavní stránku&lt;/span&gt;&#10;    &lt;/a&gt;&#10;&lt;/nav&gt;&#10;&#10;&lt;div class=&quot;auth-container&quot;&gt;&#10;    &lt;div class=&quot;auth-title&quot;&gt;&#10;        &lt;div class=&quot;header-icon&quot;&gt;&#10;            &lt;i class=&quot;fas fa-user-plus fa-3x text-primary&quot;&gt;&lt;/i&gt;&#10;        &lt;/div&gt;&#10;        &lt;h2&gt;Vytvořte si účet&lt;/h2&gt;&#10;        &lt;p&gt;Začněte svou vzdělávací cestu&lt;/p&gt;&#10;    &lt;/div&gt;&#10;&#10;    {% with messages = get_flashed_messages(with_categories=true) %}&#10;    &lt;div class=&quot;flash-messages&quot;&gt;&#10;        {% for category, message in messages %}&#10;        &lt;div class=&quot;flash-message {{ category }}&quot;&gt;&#10;            &lt;i class=&quot;fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}&quot;&gt;&lt;/i&gt;&#10;            {{ message }}&#10;        &lt;/div&gt;&#10;        {% endfor %}&#10;    &lt;/div&gt;&#10;    {% endwith %}&#10;&#10;    &lt;form method=&quot;POST&quot; class=&quot;auth-form&quot;&gt;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;input type=&quot;text&quot; name=&quot;first_name&quot; placeholder=&quot; &quot; required&gt;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-user&quot;&gt;&lt;/i&gt; Jméno&lt;/label&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;input type=&quot;text&quot; name=&quot;last_name&quot; placeholder=&quot; &quot; required&gt;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-user-tag&quot;&gt;&lt;/i&gt; Příjmení&lt;/label&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;input type=&quot;email&quot; name=&quot;email&quot; placeholder=&quot; &quot; required&gt;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-envelope&quot;&gt;&lt;/i&gt; E-mail&lt;/label&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;input type=&quot;password&quot; name=&quot;password&quot; placeholder=&quot; &quot; required&gt;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-lock&quot;&gt;&lt;/i&gt; Heslo&lt;/label&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;input type=&quot;date&quot; name=&quot;birthdate&quot;&gt;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-birthday-cake&quot;&gt;&lt;/i&gt; Datum narození (volitelné)&lt;/label&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;label for=&quot;english_level&quot; class=&quot;select-label&quot;&gt;Úroveň angličtiny&lt;/label&gt;&#10;            &lt;select name=&quot;english_level&quot; id=&quot;english_level&quot; required&gt;&#10;                &lt;option value=&quot;&quot; disabled selected&gt;Vyberte úroveň&lt;/option&gt;&#10;                &lt;option value=&quot;A1&quot;&gt;A1 – Začátečník&lt;/option&gt;&#10;                &lt;option value=&quot;A2&quot;&gt;A2 – Mírně pokročilý&lt;/option&gt;&#10;                &lt;option value=&quot;B1&quot;&gt;B1 – Středně pokročilý&lt;/option&gt;&#10;                &lt;option value=&quot;B2&quot;&gt;B2 – Pokročilý&lt;/option&gt;&#10;                &lt;option value=&quot;C1&quot;&gt;C1 – Velmi pokročilý&lt;/option&gt;&#10;                &lt;option value=&quot;C2&quot;&gt;C2 – Výborná znalost&lt;/option&gt;&#10;            &lt;/select&gt;&#10;            &lt;div class=&quot;select-description&quot;&gt;Vyber si svou aktuální úroveň angličtiny, aby ti lekce seděly.&lt;/div&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#10;            &lt;input list=&quot;schools-list&quot; id=&quot;school-input&quot; name=&quot;school&quot; placeholder=&quot;Začněte psát název školy&quot; required&#10;                   autocomplete=&quot;off&quot;&gt;&#10;            &lt;datalist id=&quot;schools-list&quot;&gt;&#10;                {% for school in schools %}&#10;                &lt;option value=&quot;{{ school.name }}&quot;&gt;&#10;                    {% endfor %}&#10;            &lt;/datalist&gt;&#10;            &lt;div id=&quot;school-create-info&quot; style=&quot;display:none; color: #007bff; margin-top: 0.5em;&quot;&gt;&#10;                Škola nebyla nalezena. &lt;a href=&quot;#&quot; id=&quot;create-school-link&quot;&gt;Přidat tuto školu?&lt;/a&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div class=&quot;input-group checkbox-group&quot;&gt;&#10;            &lt;input type=&quot;checkbox&quot; id=&quot;terms_opt_in&quot; name=&quot;terms_opt_in&quot;&gt;&#10;            &lt;label for=&quot;terms_opt_in&quot;&gt;&#10;                Souhlasím s &lt;a href=&quot;/terms&quot; target=&quot;_blank&quot;&gt;Podmínkami používání&lt;/a&gt;&#10;                a &lt;a href=&quot;/cookies&quot; target=&quot;_blank&quot;&gt;Zásadami cookies&lt;/a&gt;&#10;            &lt;/label&gt;&#10;        &lt;/div&gt;&#10;        &lt;button type=&quot;submit&quot;&gt;Zaregistrovat se&lt;/button&gt;&#10;&#10;    &lt;/form&gt;&#10;    &lt;div class=&quot;auth-footer&quot;&gt;&#10;        &lt;p&gt;Jste učitel?&lt;a href=&quot;#&quot; id=&quot;teacher-register-link&quot;&gt; Registrujte se jako učitel&lt;/a&gt;&lt;/p&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;div class=&quot;auth-footer&quot;&gt;&#10;        &lt;p&gt;Máte již účet? &lt;a href=&quot;{{ url_for('auth.login') }}&quot;&gt;Přihlaste se&lt;/a&gt;&lt;/p&gt;&#10;    &lt;/div&gt;&#10;&lt;/div&gt;&#10;&#10;&lt;!-- Modal popout --&gt;&#10;&lt;div class=&quot;modal-bg&quot; id=&quot;teacher-modal&quot;&gt;&#10;    &lt;div class=&quot;modal-content&quot;&gt;&#10;        &lt;button class=&quot;modal-close&quot; id=&quot;close-modal&quot; aria-label=&quot;Zavřít&quot;&gt;&amp;times;&lt;/button&gt;&#10;        &lt;h3&gt;Chcete být učitelem?&lt;/h3&gt;&#10;        &lt;p&gt;Zaregistrujte se a běžte do nastavení, pak postupujte podle instrukce.&lt;/p&gt;&#10;    &lt;/div&gt;&#10;&lt;/div&gt;&#10;&#10;&lt;script&gt;&#10;    document.addEventListener('DOMContentLoaded', function () {&#10;        // Kód pro teacher modal (zůstává stejný)&#10;        const teacherLink = document.getElementById('teacher-register-link');&#10;        const modal = document.getElementById('teacher-modal');&#10;        const closeModal = document.getElementById('close-modal');&#10;        teacherLink.addEventListener('click', function (e) {&#10;            e.preventDefault();&#10;            modal.classList.add('active');&#10;        });&#10;        closeModal.addEventListener('click', function () {&#10;            modal.classList.remove('active');&#10;        });&#10;        modal.addEventListener('click', function (e) {&#10;            if (e.target === modal) {&#10;                modal.classList.remove('active');&#10;            }&#10;        });&#10;&#10;        // Vylepšený kód pro vyhledávání škol&#10;        const schoolInput = document.getElementById('school-input');&#10;        const datalist = document.getElementById('schools-list');&#10;        const info = document.getElementById('school-create-info');&#10;        const createLink = document.getElementById('create-school-link');&#10;&#10;        // Načteme všechny školy do pole&#10;        let schools = Array.from(datalist.options).map(opt =&gt; opt.value);&#10;&#10;        // Uložíme původní seznam škol pro případné resetování&#10;        const originalOptions = [...datalist.options];&#10;&#10;        // Funkce pro filtrování škol&#10;        function filterSchools(query) {&#10;            return schools.filter(school =&gt;&#10;                school.toLowerCase().includes(query.toLowerCase())&#10;            );&#10;        }&#10;&#10;        // Při psaní do pole školy&#10;        schoolInput.addEventListener('input', function () {&#10;            const val = schoolInput.value.trim();&#10;&#10;            // Resetujeme datalist na původní seznam&#10;            datalist.innerHTML = '';&#10;            originalOptions.forEach(opt =&gt; {&#10;                datalist.appendChild(opt.cloneNode(true));&#10;            });&#10;&#10;            // Pokud je text dostatečně dlouhý, filtrujeme školy&#10;            if (val.length &gt;= 2) {&#10;                const filteredSchools = filterSchools(val);&#10;&#10;                // Aktualizujeme datalist s filtrovanými školami&#10;                datalist.innerHTML = '';&#10;                filteredSchools.forEach(school =&gt; {&#10;                    const option = document.createElement('option');&#10;                    option.value = school;&#10;                    datalist.appendChild(option);&#10;                });&#10;&#10;                // Zobrazíme info o možnosti přidání nové školy&#10;                if (filteredSchools.length === 0 &amp;&amp; val.length &gt; 2) {&#10;                    info.style.display = '';&#10;                    createLink.textContent = `&quot;${val}&quot;`;&#10;                } else {&#10;                    info.style.display = 'none';&#10;                }&#10;            } else {&#10;                info.style.display = 'none';&#10;            }&#10;        });&#10;&#10;        // Zbytek kódu pro přidání školy zůstává stejný&#10;        createLink.addEventListener('click', function (e) {&#10;            e.preventDefault();&#10;            const schoolName = schoolInput.value.trim();&#10;            if (!schoolName) return;&#10;            fetch('/add_school', {&#10;                method: 'POST',&#10;                headers: {'Content-Type': 'application/json'},&#10;                body: JSON.stringify({name: schoolName})&#10;            })&#10;                .then(res =&gt; res.json())&#10;                .then(data =&gt; {&#10;                    if (data.success) {&#10;                        // Přidej do datalistu&#10;                        const option = document.createElement('option');&#10;                        option.value = schoolName;&#10;                        datalist.appendChild(option);&#10;                        schools.push(schoolName);&#10;                        info.style.display = 'none';&#10;                        alert('Škola byla přidána.');&#10;                    } else {&#10;                        alert(data.error || 'Chyba při přidávání školy.');&#10;                    }&#10;                });&#10;        });&#10;    });&#10;&lt;/script&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;" />
              <option name="updatedContent" value="&lt;!DOCTYPE html&gt;&#13;&#10;&lt;html lang=&quot;cs&quot;&gt;&#13;&#10;&lt;head&gt;&#13;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#13;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#13;&#10;    &lt;title&gt;Registrace | Knowix&lt;/title&gt;&#13;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;{{ url_for('static', filename='style_reg_log.css') }}&quot;&gt;&#13;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/min.css&quot;&gt;&#13;&#10;    &lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;{{ url_for('static', filename='favicon.ico') }}&quot;&gt;&#13;&#10;    &lt;style&gt;&#13;&#10;        /* Modal styles */&#13;&#10;        .modal-bg {&#13;&#10;            display: none;&#13;&#10;            position: fixed;&#13;&#10;            z-index: 1000;&#13;&#10;            left: 0;&#13;&#10;            top: 0;&#13;&#10;            width: 100vw;&#13;&#10;            height: 100vh;&#13;&#10;            background: rgba(0, 0, 0, 0.4);&#13;&#10;            justify-content: center;&#13;&#10;            align-items: center;&#13;&#10;        }&#13;&#10;&#13;&#10;        .modal-bg.active {&#13;&#10;            display: flex;&#13;&#10;        }&#13;&#10;&#13;&#10;        .modal-content {&#13;&#10;            background: #fff;&#13;&#10;            padding: 2rem 2.5rem;&#13;&#10;            border-radius: 12px;&#13;&#10;            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.15);&#13;&#10;            max-width: 350px;&#13;&#10;            text-align: center;&#13;&#10;            position: relative;&#13;&#10;        }&#13;&#10;&#13;&#10;        .modal-content h3 {&#13;&#10;            margin-top: 0;&#13;&#10;            color: #2c3e50;&#13;&#10;        }&#13;&#10;&#13;&#10;        .modal-close {&#13;&#10;            position: absolute;&#13;&#10;            top: 12px;&#13;&#10;            right: 16px;&#13;&#10;            background: none;&#13;&#10;            border: none;&#13;&#10;            font-size: 1.5rem;&#13;&#10;            color: #888;&#13;&#10;            cursor: pointer;&#13;&#10;        }&#13;&#10;&#13;&#10;        .modal-content p {&#13;&#10;            margin-bottom: 0;&#13;&#10;        }&#13;&#10;    &lt;/style&gt;&#13;&#10;&lt;/head&gt;&#13;&#10;&lt;body&gt;&#13;&#10;&lt;nav class=&quot;auth-header&quot;&gt;&#13;&#10;    &lt;a href=&quot;/&quot; class=&quot;home-link&quot;&gt;&#13;&#10;        &lt;img src=&quot;{{ url_for('static', filename='pic/logo.webp') }}&quot; alt=&quot;Knowix Logo&quot;&gt;&#13;&#10;        &lt;span&gt;← Zpět na hlavní stránku&lt;/span&gt;&#13;&#10;    &lt;/a&gt;&#13;&#10;&lt;/nav&gt;&#13;&#10;&#13;&#10;&lt;div class=&quot;auth-container&quot;&gt;&#13;&#10;    &lt;div class=&quot;auth-title&quot;&gt;&#13;&#10;        &lt;div class=&quot;header-icon&quot;&gt;&#13;&#10;            &lt;i class=&quot;fas fa-user-plus fa-3x text-primary&quot;&gt;&lt;/i&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;        &lt;h2&gt;Vytvořte si účet&lt;/h2&gt;&#13;&#10;        &lt;p&gt;Začněte svou vzdělávací cestu&lt;/p&gt;&#13;&#10;    &lt;/div&gt;&#13;&#10;&#13;&#10;    {% with messages = get_flashed_messages(with_categories=true) %}&#13;&#10;    &lt;div class=&quot;flash-messages&quot;&gt;&#13;&#10;        {% for category, message in messages %}&#13;&#10;        &lt;div class=&quot;flash-message {{ category }}&quot;&gt;&#13;&#10;            &lt;i class=&quot;fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}&quot;&gt;&lt;/i&gt;&#13;&#10;            {{ message }}&#13;&#10;        &lt;/div&gt;&#13;&#10;        {% endfor %}&#13;&#10;    &lt;/div&gt;&#13;&#10;    {% endwith %}&#13;&#10;&#13;&#10;    &lt;form method=&quot;POST&quot; class=&quot;auth-form&quot;&gt;&#13;&#10;        &lt;!-- CSRF token --&gt;&#13;&#10;        &lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;{{ csrf_token() }}&quot;&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;input type=&quot;text&quot; name=&quot;first_name&quot; placeholder=&quot; &quot; required&gt;&#13;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-user&quot;&gt;&lt;/i&gt; Jméno&lt;/label&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;input type=&quot;text&quot; name=&quot;last_name&quot; placeholder=&quot; &quot; required&gt;&#13;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-user-tag&quot;&gt;&lt;/i&gt; Příjmení&lt;/label&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;input type=&quot;email&quot; name=&quot;email&quot; placeholder=&quot; &quot; required&gt;&#13;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-envelope&quot;&gt;&lt;/i&gt; E-mail&lt;/label&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;input type=&quot;password&quot; name=&quot;password&quot; placeholder=&quot; &quot; required&gt;&#13;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-lock&quot;&gt;&lt;/i&gt; Heslo&lt;/label&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;input type=&quot;date&quot; name=&quot;birthdate&quot;&gt;&#13;&#10;            &lt;label&gt;&lt;i class=&quot;fas fa-birthday-cake&quot;&gt;&lt;/i&gt; Datum narození (volitelné)&lt;/label&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;label for=&quot;english_level&quot; class=&quot;select-label&quot;&gt;Úroveň angličtiny&lt;/label&gt;&#13;&#10;            &lt;select name=&quot;english_level&quot; id=&quot;english_level&quot; required&gt;&#13;&#10;                &lt;option value=&quot;&quot; disabled selected&gt;Vyberte úroveň&lt;/option&gt;&#13;&#10;                &lt;option value=&quot;A1&quot;&gt;A1 – Začátečník&lt;/option&gt;&#13;&#10;                &lt;option value=&quot;A2&quot;&gt;A2 – Mírně pokročilý&lt;/option&gt;&#13;&#10;                &lt;option value=&quot;B1&quot;&gt;B1 – Středně pokročilý&lt;/option&gt;&#13;&#10;                &lt;option value=&quot;B2&quot;&gt;B2 – Pokročilý&lt;/option&gt;&#13;&#10;                &lt;option value=&quot;C1&quot;&gt;C1 – Velmi pokročilý&lt;/option&gt;&#13;&#10;                &lt;option value=&quot;C2&quot;&gt;C2 – Výborná znalost&lt;/option&gt;&#13;&#10;            &lt;/select&gt;&#13;&#10;            &lt;div class=&quot;select-description&quot;&gt;Vyber si svou aktuální úroveň angličtiny, aby ti lekce seděly.&lt;/div&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group&quot;&gt;&#13;&#10;            &lt;input list=&quot;schools-list&quot; id=&quot;school-input&quot; name=&quot;school&quot; placeholder=&quot;Začněte psát název školy&quot; required&#13;&#10;                   autocomplete=&quot;off&quot;&gt;&#13;&#10;            &lt;datalist id=&quot;schools-list&quot;&gt;&#13;&#10;                {% for school in schools %}&#13;&#10;                &lt;option value=&quot;{{ school.name }}&quot;&gt;&#13;&#10;                    {% endfor %}&#13;&#10;            &lt;/datalist&gt;&#13;&#10;            &lt;div id=&quot;school-create-info&quot; style=&quot;display:none; color: #007bff; margin-top: 0.5em;&quot;&gt;&#13;&#10;                Škola nebyla nalezena. &lt;a href=&quot;#&quot; id=&quot;create-school-link&quot;&gt;Přidat tuto školu?&lt;/a&gt;&#13;&#10;            &lt;/div&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;&#13;&#10;        &lt;div class=&quot;input-group checkbox-group&quot;&gt;&#13;&#10;            &lt;input type=&quot;checkbox&quot; id=&quot;terms_opt_in&quot; name=&quot;terms_opt_in&quot;&gt;&#13;&#10;            &lt;label for=&quot;terms_opt_in&quot;&gt;&#13;&#10;                Souhlasím s &lt;a href=&quot;/terms&quot; target=&quot;_blank&quot;&gt;Podmínkami používání&lt;/a&gt;&#13;&#10;                a &lt;a href=&quot;/cookies&quot; target=&quot;_blank&quot;&gt;Zásadami cookies&lt;/a&gt;&#13;&#10;            &lt;/label&gt;&#13;&#10;        &lt;/div&gt;&#13;&#10;        &lt;button type=&quot;submit&quot;&gt;Zaregistrovat se&lt;/button&gt;&#13;&#10;&#13;&#10;    &lt;/form&gt;&#13;&#10;    &lt;div class=&quot;auth-footer&quot;&gt;&#13;&#10;        &lt;p&gt;Jste učitel?&lt;a href=&quot;#&quot; id=&quot;teacher-register-link&quot;&gt; Registrujte se jako učitel&lt;/a&gt;&lt;/p&gt;&#13;&#10;    &lt;/div&gt;&#13;&#10;&#13;&#10;    &lt;div class=&quot;auth-footer&quot;&gt;&#13;&#10;        &lt;p&gt;Máte již účet? &lt;a href=&quot;{{ url_for('auth.login') }}&quot;&gt;Přihlaste se&lt;/a&gt;&lt;/p&gt;&#13;&#10;    &lt;/div&gt;&#13;&#10;&lt;/div&gt;&#13;&#10;&#13;&#10;&lt;!-- Modal popout --&gt;&#13;&#10;&lt;div class=&quot;modal-bg&quot; id=&quot;teacher-modal&quot;&gt;&#13;&#10;    &lt;div class=&quot;modal-content&quot;&gt;&#13;&#10;        &lt;button class=&quot;modal-close&quot; id=&quot;close-modal&quot; aria-label=&quot;Zavřít&quot;&gt;&amp;times;&lt;/button&gt;&#13;&#10;        &lt;h3&gt;Chcete být učitelem?&lt;/h3&gt;&#13;&#10;        &lt;p&gt;Zaregistrujte se a běžte do nastavení, pak postupujte podle instrukce.&lt;/p&gt;&#13;&#10;    &lt;/div&gt;&#13;&#10;&lt;/div&gt;&#13;&#10;&#13;&#10;&lt;script&gt;&#13;&#10;    document.addEventListener('DOMContentLoaded', function () {&#13;&#10;        const csrfToken = &quot;{{ csrf_token() }}&quot;; // pro JS fetchy&#13;&#10;&#13;&#10;        // Kód pro teacher modal (zůstává stejný)&#13;&#10;        const teacherLink = document.getElementById('teacher-register-link');&#13;&#10;        const modal = document.getElementById('teacher-modal');&#13;&#10;        const closeModal = document.getElementById('close-modal');&#13;&#10;        teacherLink.addEventListener('click', function (e) {&#13;&#10;            e.preventDefault();&#13;&#10;            modal.classList.add('active');&#13;&#10;        });&#13;&#10;        closeModal.addEventListener('click', function () {&#13;&#10;            modal.classList.remove('active');&#13;&#10;        });&#13;&#10;        modal.addEventListener('click', function (e) {&#13;&#10;            if (e.target === modal) {&#13;&#10;                modal.classList.remove('active');&#13;&#10;            }&#13;&#10;        });&#13;&#10;&#13;&#10;        // Vylepšený kód pro vyhledávání škol&#13;&#10;        const schoolInput = document.getElementById('school-input');&#13;&#10;        const datalist = document.getElementById('schools-list');&#13;&#10;        const info = document.getElementById('school-create-info');&#13;&#10;        const createLink = document.getElementById('create-school-link');&#13;&#10;&#13;&#10;        // Načteme všechny školy do pole&#13;&#10;        let schools = Array.from(datalist.options).map(opt =&gt; opt.value);&#13;&#10;&#13;&#10;        // Uložíme původní seznam škol pro případné resetování&#13;&#10;        const originalOptions = [...datalist.options];&#13;&#10;&#13;&#10;        // Funkce pro filtrování škol&#13;&#10;        function filterSchools(query) {&#13;&#10;            return schools.filter(school =&gt;&#13;&#10;                school.toLowerCase().includes(query.toLowerCase())&#13;&#10;            );&#13;&#10;        }&#13;&#10;&#13;&#10;        // Při psaní do pole školy&#13;&#10;        schoolInput.addEventListener('input', function () {&#13;&#10;            const val = schoolInput.value.trim();&#13;&#10;&#13;&#10;            // Resetujeme datalist na původní seznam&#13;&#10;            datalist.innerHTML = '';&#13;&#10;            originalOptions.forEach(opt =&gt; {&#13;&#10;                datalist.appendChild(opt.cloneNode(true));&#13;&#10;            });&#13;&#10;&#13;&#10;            // Pokud je text dostatečně dlouhý, filtrujeme školy&#13;&#10;            if (val.length &gt;= 2) {&#13;&#10;                const filteredSchools = filterSchools(val);&#13;&#10;&#13;&#10;                // Aktualizujeme datalist s filtrovanými školami&#13;&#10;                datalist.innerHTML = '';&#13;&#10;                filteredSchools.forEach(school =&gt; {&#13;&#10;                    const option = document.createElement('option');&#13;&#10;                    option.value = school;&#13;&#10;                    datalist.appendChild(option);&#13;&#10;                });&#13;&#10;&#13;&#10;                // Zobrazíme info o možnosti přidání nové školy&#13;&#10;                if (filteredSchools.length === 0 &amp;&amp; val.length &gt; 2) {&#13;&#10;                    info.style.display = '';&#13;&#10;                    createLink.textContent = `&quot;${val}&quot;`;&#13;&#10;                } else {&#13;&#10;                    info.style.display = 'none';&#13;&#10;                }&#13;&#10;            } else {&#13;&#10;                info.style.display = 'none';&#13;&#10;            }&#13;&#10;        });&#13;&#10;&#13;&#10;        // Zbytek kódu pro přidání školy zůstává stejný&#13;&#10;        createLink.addEventListener('click', function (e) {&#13;&#10;            e.preventDefault();&#13;&#10;            const schoolName = schoolInput.value.trim();&#13;&#10;            if (!schoolName) return;&#13;&#10;            fetch('/add_school', {&#13;&#10;                method: 'POST',&#13;&#10;                headers: {&#13;&#10;                    'Content-Type': 'application/json',&#13;&#10;                    'X-CSRFToken': csrfToken&#13;&#10;                },&#13;&#10;                body: JSON.stringify({name: schoolName, csrf_token: csrfToken})&#13;&#10;            })&#13;&#10;                .then(res =&gt; res.json())&#13;&#10;                .then(data =&gt; {&#13;&#10;                    if (data.success) {&#13;&#10;                        const option = document.createElement('option');&#13;&#10;                        option.value = schoolName;&#13;&#10;                        datalist.appendChild(option);&#13;&#10;                        schools.push(schoolName);&#13;&#10;                        info.style.display = 'none';&#13;&#10;                        alert('Škola byla přidána.');&#13;&#10;                    } else {&#13;&#10;                        alert(data.error || 'Chyba při přidávání školy.');&#13;&#10;                    }&#13;&#10;                });&#13;&#10;        });&#13;&#10;    });&#13;&#10;&lt;/script&gt;&#13;&#10;&lt;/body&gt;&#13;&#10;&lt;/html&gt;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/anglictina/app/templates/student_stats_chart.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/anglictina/app/templates/student_stats_chart.html" />
              <option name="updatedContent" value="{% extends 'base.html' %}&#10;{% block content %}&#10;&lt;div class=&quot;container&quot;&gt;&#10;    &lt;h2&gt;Statistiky studenta: {{ student.first_name }} {{ student.last_name }}&lt;/h2&gt;&#10;    &lt;div class=&quot;profile&quot;&gt;&#10;        &lt;img src=&quot;{{ url_for('static', filename='profile_pics/' + (student.profile_pic or 'default.jpg')) }}&quot; width=&quot;80&quot; height=&quot;80&quot; style=&quot;border-radius:50%&quot;&gt;&#10;        &lt;p&gt;Email: {{ student.email }}&lt;/p&gt;&#10;        &lt;p&gt;Úroveň: {{ student.english_level }}&lt;/p&gt;&#10;        &lt;p&gt;XP: {{ student.xp }}&lt;/p&gt;&#10;        &lt;p&gt;Level: {{ student.level }}&lt;/p&gt;&#10;        &lt;p&gt;Streak: {{ student.streak }}&lt;/p&gt;&#10;    &lt;/div&gt;&#10;    &lt;hr&gt;&#10;    &lt;h3&gt;Přehled statistik&lt;/h3&gt;&#10;    &lt;canvas id=&quot;statsChart&quot; width=&quot;400&quot; height=&quot;200&quot;&gt;&lt;/canvas&gt;&#10;&lt;/div&gt;&#10;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/chart.js&quot;&gt;&lt;/script&gt;&#10;&lt;script&gt;&#10;    // Připrav data z user_stats&#10;    const stats = {{ stats|tojson }};&#10;    // Předpokládáme, že user_stats má sloupce: id, user_id, stat_name, stat_value&#10;    const labels = stats.map(s =&gt; s.stat_name);&#10;    const values = stats.map(s =&gt; s.stat_value);&#10;    const ctx = document.getElementById('statsChart').getContext('2d');&#10;    new Chart(ctx, {&#10;        type: 'bar',&#10;        data: {&#10;            labels: labels,&#10;            datasets: [{&#10;                label: 'Hodnota',&#10;                data: values,&#10;                backgroundColor: 'rgba(54, 162, 235, 0.5)',&#10;                borderColor: 'rgba(54, 162, 235, 1)',&#10;                borderWidth: 1&#10;            }]&#10;        },&#10;        options: {&#10;            responsive: true,&#10;            scales: {&#10;                y: {&#10;                    beginAtZero: true&#10;                }&#10;            }&#10;        }&#10;    });&#10;&lt;/script&gt;&#10;{% endblock %}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>