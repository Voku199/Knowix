<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Uƒç se anglicky zdarma a z√°bavnƒõ. Knowix nab√≠z√≠ p√≠sniƒçky, chatov√© lekce, testy, p≈ô√≠bƒõhy a interaktivn√≠ cviƒçen√≠ pro dƒõti i studenty. Modern√≠ v√Ωuka angliƒçtiny bez reklam. Angliƒçitna Zdarma, Z√°bavn√° Angliƒçtina">
    <meta name="keywords" content="angliƒçtina zdarma, v√Ωuka angliƒçtiny, angliƒçtina pro dƒõti, procviƒçov√°n√≠ angliƒçtiny, angliƒçtina online, angliƒçtina z√°bavnƒõ, p√≠sniƒçky angliƒçtina, testy angliƒçtina, chat angliƒçtina, gramatika angliƒçtina, knowix">
    <meta name="robots" content="index, follow">
<meta property="og:title" content="Knowix ‚Äì Angliƒçtina zdarma a z√°bavnƒõ">
<meta property="og:description" content="Procviƒçuj angliƒçtinu pomoc√≠ p√≠sniƒçek, chat≈Ø, p≈ô√≠bƒõh≈Ø a test≈Ø. Kompletnƒõ zdarma, bez reklam.">
<meta property="og:image" content="https://www.knowix.cz/static/og-banner.png">
<meta property="og:url" content="https://www.knowix.cz">
<meta property="og:type" content="website">
    <!-- PWA manifest & theme -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0d1117">
    <!-- iOS PWA podpora -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Knowix">
    <link rel="apple-touch-icon" href="/static/pic/logo1.png">
    <!-- CSRF token pro JS -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <!-- P≈ôedej user_id do JS -->
    <meta name="user-id" content="{{ session.get('user_id') or '' }}">

    <link rel="canonical" href="https://www.knowix.cz">

    <title>{% block title %}knowix{% endblock %}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/mobile_header.css">


    <!-- Preconnect zrychl√≠ DNS a spojen√≠ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Font naƒçti a≈æ po naƒçten√≠ str√°nky -->
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet"
          media="print" onload="this.media='all'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet">
    </noscript>

    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Google tag (gtag.js) -->
<!--<script async src="https://www.googletagmanager.com/gtag/js?id=G-W1EN990JKP"></script>-->
<!--<script>-->
<!--  window.dataLayer = window.dataLayer || [];-->
<!--  function gtag(){dataLayer.push(arguments);}-->
<!--  gtag('js', new Date());-->

<!--  gtag('config', 'G-W1EN990JKP');-->
<!--</script>-->
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Knowix",
  "url": "https://www.knowix.cz",
  "description": "Z√°bavn√© procviƒçov√°n√≠ angliƒçtiny pomoc√≠ p√≠sniƒçek, chatu a test≈Ø. Knowix je zdarma a bez reklam."
}
</script>
    <style>
        /* Zv√Ωraznƒõn√° tlaƒç√≠tka pro PWA a notifikace */
        .pwa-action-btn {
            display:none; /* z≈Øst√°v√°, JS p≈ôepne na inline-block */
            background: linear-gradient(135deg,#2d7ff9,#6aa9ff);
            color:#fff;
            border:none;
            cursor:pointer;
            padding:6px 14px;
            font-size:14px;
            font-weight:600;
            border-radius:999px;
            font-family:inherit;
            position:relative;
            box-shadow:0 4px 12px rgba(0,0,0,.15);
            transition:background .3s, transform .15s, box-shadow .3s;
        }
        .pwa-action-btn[data-type="notif"] {background: linear-gradient(135deg,#ff9600,#ffbf4d);}
        .dark-mode .pwa-action-btn {box-shadow:0 4px 14px rgba(0,0,0,.5);}
        .pwa-action-btn:hover {transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.25);}
        .pwa-action-btn:active {transform:translateY(0); box-shadow:0 3px 10px rgba(0,0,0,.2);}
        .pwa-action-btn:focus-visible {outline:2px solid #fff; outline-offset:3px;}
        .pwa-action-btn .icon {margin-right:6px; font-size:16px;}
        .pwa-action-btn .label {vertical-align:middle;}
        /* Pulz p≈ôi prvn√≠m zobrazen√≠ */
        @keyframes pwaPulse {0%{box-shadow:0 0 0 0 rgba(45,127,249,.6);}70%{box-shadow:0 0 0 10px rgba(45,127,249,0);}100%{box-shadow:0 0 0 0 rgba(45,127,249,0);}}
        @keyframes notifPulse {0%{box-shadow:0 0 0 0 rgba(255,150,0,.6);}70%{box-shadow:0 0 0 10px rgba(255,150,0,0);}100%{box-shadow:0 0 0 0 rgba(255,150,0,0);}}
        .pwa-action-btn.pulse {animation:pwaPulse 2s ease-out 1;}
        .pwa-action-btn[data-type="notif"].pulse {animation:notifPulse 2s ease-out 1;}
    </style>
    <style>
    /* Kdy≈æ je onboarding aktivn√≠, rozost≈ôi obsah za n√≠m */
    body.onboarding-active #content-wrapper {
        filter: blur(3px);
        opacity: 0.7;
        pointer-events: none;
        user-select: none;
        transition: filter 0.3s ease, opacity 0.3s ease;
    }

    /* V√Ωjimka pro highlighted element */
    .onboarding-highlight {
        filter: none !important;
        opacity: 1 !important;
        pointer-events: auto !important;
    }
</style>
    <style>
    /* V√°noƒçn√≠ dopl≈àky: barvy, sn√≠h a dekorace */
    .christmas-accent { color: #b71c1c; } /* tmav√° v√°noƒçn√≠ ƒçerven√° */
    .christmas-accent-2 { color: #1b5e20; } /* tmav√° v√°noƒçn√≠ zelen√° */

    /* Lehk√© p≈ôebarven√≠ odkaz≈Ø a tlaƒç√≠tek bƒõhem V√°noc */
    header .nav-right a, header .nav-right button { transition: transform .12s ease, color .12s ease; }
    header .nav-right a:hover, header .nav-right button:hover { transform: translateY(-2px); color: #b71c1c; }

    /* Logo s ƒçepiƒçkou a girlandou */
    .logo { position: relative; display:inline-block; }
    .logo .santa-hat { position: absolute; left: -8px; top: -12px; width: 48px; pointer-events:none; transform-origin:center; }
    .logo .garland { position: absolute; right: -6px; top: 38px; width: 120px; pointer-events:none; opacity:0.9; }

    /* Snƒõhov√© vloƒçky (CSS fallback - animovan√Ω gradient a z√°kladn√≠ animace) */
    /* Sn√≠h mus√≠ b√Ωt nad vƒõt≈°inou UI, zv√Ω≈°√≠me z-index pro spolehlivou viditelnost */
    #snow-container { pointer-events:none; position:fixed; left:0; top:0; width:100%; height:100%; z-index:1000000; overflow:hidden; }
    .snowflake { position:absolute; top:-10px; font-size:14px; opacity:0.9; will-change: transform; user-select:none; text-shadow:0 1px 2px rgba(0,0,0,.25); }
    /* Pln√© kruhov√© vloƒçky (lep≈°√≠ kontrast na svƒõtl√©m pozad√≠) */
    .snowflake.dot { width:12px; height:12px; border-radius:50%; display:block; text-indent:-9999px; position:absolute; z-index:1000001; mix-blend-mode:normal; box-shadow: 0 6px 18px rgba(0,0,0,0.32); border:1px solid rgba(0,0,0,0.12); }
    .snowflake.dot.large { width:18px; height:18px; }
    /* Odstranƒõna CSS animace transform, proto≈æe JS pou≈æ√≠v√° transform pro p√°d a animace by s n√≠ kolidovala. */

    /* Zv√Ωraznƒõn√Ω drop-shadow pro v√Ωrazn√Ω kontrast na svƒõtl√©m pozad√≠ */
    /* SVG vloƒçky: z√°kladn√≠ styly pro inline SVG elementy pou≈æ√≠van√© jako vloƒçky */
    .flake-svg { position:absolute; pointer-events:none; z-index:1000002; display:block; will-change: transform; }
    .flake-svg line { stroke-linecap: round; }
    .flake-svg.small line { stroke-width:1.2; }
    .flake-svg.medium line { stroke-width:1.6; }
    .flake-svg.large line { stroke-width:2.2; }

    /* jemn√© blik√°n√≠ svƒõt√©lek v hlaviƒçce */
    .header-lights { position:absolute; left:0; right:0; top:0; height:8px; pointer-events:none; }
    .header-lights span { display:inline-block; width:10px; height:10px; border-radius:50%; margin:0 6px; opacity:0.95; animation:lightTwinkle 3s infinite; }
    @keyframes lightTwinkle { 0%,100%{ opacity:0.6; transform: scale(1);} 50%{ opacity:1; transform: scale(1.25);} }

    /* lehk√Ω sn√≠h efekt p≈ôes obsah (pro tmav√© i svƒõtl√© t√©ma) */
    .snow-overlay { position:fixed; inset:0; background-image: radial-gradient(rgba(134, 131, 131, 0.03) 1px, transparent 1px); background-size: 40px 40px; z-index:15; pointer-events:none; mix-blend-mode:screen; }

    /* V√°noƒçn√≠ toast (popout bublina) */
    .xmas-toast { position:fixed; right:20px; bottom:24px; background: linear-gradient(135deg,#fff8e1,#ffe0b2); color:#222; border-radius:12px; padding:12px 16px; box-shadow:0 8px 30px rgba(0,0,0,.2); z-index:10001; display:flex; gap:10px; align-items:center; max-width:320px; font-weight:600; }
    .dark-mode .xmas-toast { background: linear-gradient(135deg,#2b2b2b,#1e1e1e); color:#fff; box-shadow:0 8px 30px rgba(0,0,0,.6); }
    .xmas-toast .xmas-close { background:transparent; border:none; font-size:18px; cursor:pointer; color:inherit; margin-left:auto; }
    .xmas-toast img { width:36px; height:36px; border-radius:6px; }
    @keyframes xmasPop { 0%{ transform: translateY(20px) scale(.98); opacity:0} 60%{ transform: translateY(-6px) scale(1.02); opacity:1 } 100%{ transform: translateY(0) scale(1); } }
    .xmas-toast.show { animation: xmasPop .6s cubic-bezier(.2,.9,.3,1) both; }

    /* Footer styl + mal√© v√°noƒçn√≠ p≈ô√°n√≠ */
    footer { position:relative; }
    footer .xmas-greeting { font-weight:600; color:#b71c1c; margin-top:6px; }
    </style>
</head>
<body class="{{ 'dark-mode' if session.get('theme') == 'dark' else '' }}">

<!-- V√°noƒçn√≠ sn√≠h + dekorace -->
<div id="snow-container" aria-hidden="true"></div>
<div class="snow-overlay" aria-hidden="true"></div>

<header style="position:relative;">
    <div class="header-lights" aria-hidden="true" style="display:flex;justify-content:center;align-items:center;">
        <span style="background:#ff3d00; animation-delay:0s;"></span>
        <span style="background:#ffd600; animation-delay:.4s;"></span>
        <span style="background:#00c853; animation-delay:.8s;"></span>
        <span style="background:#2979ff; animation-delay:1.2s;"></span>
        <span style="background:#ff4081; animation-delay:1.6s;"></span>
    </div>

    <div class="logo-streak-wrapper">
        <div class="logo">
            <a href="{{ url_for('main.index') }}" aria-label="Knowix dom≈Ø">
                <img src="{{ url_for('static', filename='pic/logo.webp') }}" alt="Knowix Logo">
            </a>
            <!-- Santa ƒçepiƒçka (p≈ôelepen√° p≈ôes logo) - pou≈æ√≠v√°me PNG um√≠stƒõn√© ve static/pic -->
            <img class="santa-hat" src="{{ url_for('static', filename='pic/santa_hat.png') }}" alt="Santa hat" onerror="this.style.display='none'">
            <!-- Girlanda dekorace -->
            <img class="garland" src="{{ url_for('static', filename='pic/garland.png') }}" alt="Garland" onerror="this.style.display='none'">
        </div>
        <span class="streak-badge">
            <img src="/static/fire.svg" alt="Streak">
            {{ user_streak }}
        </span>
    </div>
    <div class="nav-profile-wrapper">
        <ul class="nav-right">
<!--            <li>-->
<!--                <a href="/set_lang/cs" title="ƒåe≈°tina">-->
<!--                    <img src="{{ url_for('static', filename='icons/cz.png') }}" alt="Angliƒçtina" class="nav-icon">-->
<!--                </a>-->
<!--            </li>-->
<!--            <li>-->
<!--                <a href="/set_lang/uk" title="Ukrajin≈°tina">-->
<!--                    <img src="{{ url_for('static', filename='icons/uk.png') }}" alt="Angliƒçtina" class="nav-icon">-->
<!--                </a>-->
<!--            </li>-->
            <li>
                <a href="/anglictina" title="Angliƒçtina">
                    <img src="{{ url_for('static', filename='icons/eng.png') }}" alt="Angliƒçtina" class="nav-icon">
                </a>
            </li>

<!--            <li>-->
<!--                <a href="/math" title="Matematika">-->
<!--                    <img src="{{ url_for('static', filename='icons/math.png') }}" alt="Angliƒçtina" class="nav-icon">-->
<!--                </a>-->
<!--            </li>-->
            <li>
                <a href="/feedback" title="Feedback">
                    <img src="{{ url_for('static', filename='icons/chat.png') }}" alt="Feedback" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/news" title="Novinky">
                    <img src="{{ url_for('static', filename='icons/bell.png') }}" alt="Novinky" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/obchod" title="Obchod">
                    <img src="{{ url_for('static', filename='icons/shop.png') }}" alt="Obchod" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/zpravy" title="Zpr√°vy">
                    <img src="{{ url_for('static', filename='icons/mail.png') }}" alt="Zpr√°vy" class="nav-icon">
                </a>
            </li>
            <li>
                <button id="theme-toggle" title="P≈ôepnout t√©ma" style="background:none;border:none;cursor:pointer;padding:0;">
                    üåô
                </button>
            </li>
            <li>
                <button id="enable-notifications" data-type="notif" aria-label="Povolit notifikace" title="Povolit notifikace" class="pwa-action-btn" style="display:none;">
                    <span class="icon">üîî</span><span class="label">Notifikace</span>
                </button>
            </li>
            {% if session.user_id == 1 %}
            <li>
    <button id="test-push" title="Test push notifikac√≠" style="background:none;border:1px solid #444;border-radius:6px;cursor:pointer;padding:4px 8px;color:inherit;font-size:12px;">
        Test Push
    </button>
</li>

<li>
    <a href="/push/admin/subscriptions" title="Push Admin" style="color: #ff4444; font-weight: bold;">
        üîß Push Admin
    </a>
</li>
{% endif %}
            <li>
                <button id="install-app" data-type="pwa" aria-label="Instalovat aplikaci" title="Instalovat aplikaci" class="pwa-action-btn" style="display:none;">
                    <span class="icon">‚¨áÔ∏è</span><span class="label">Instalovat</span>
                </button>
            </li>
<!--            <li>-->
<!--                <button id="test-notif" title="Test notifikace" style="background:none;border:1px solid #444;border-radius:6px;cursor:pointer;padding:4px 8px;color:inherit;">Test notif</button>-->
<!--            </li>-->
        </ul>
        {% if session.get('user_name') %}
        <div class="user-profile">
            <div class="profile-container">
                {% if session.get('profile_pic') %}
                <img src="{{ url_for('static', filename='profile_pics/' + session.get('profile_pic')) }}"
                     alt="Profilov√° fotka" width="64" class="profile-pic"
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='pic/default.webp') }}';">
                {% else %}
                <img src="{{ url_for('static', filename='pic/default.webp') }}" alt="Defaultn√≠ profilovka"
                     class="profile-pic" id="profileMenuTrigger">
                {% endif %}
                <div class="profile-menu" id="profileMenu">
                    <a href="{{ url_for('auth.settings') }}">‚öôÔ∏è Nastaven√≠</a>
                    <a href="{{ url_for('auth.logout') }}">üö™ Odhl√°sit se</a>
                </div>
                <span class="greeting" style="margin-left: 10px;">Ahoj {{ (session.get('user_name') or '').split()[0] }}!</span>
            </div>
            {% if user_xp is defined and user_level is defined and user_level_name is defined and user_progress_percent is defined %}
            <div class="xp-header-bar">
                <div class="xp-header-bar-labels">
                    <span class="xp-level-badge">Level {{ user_level }} ‚Äì {{ user_level_name }}</span>
                    <span class="xp-value">{{ user_xp_in_level }}/50 XP</span>
                </div>
                <div class="xp-header-bar-progress-bg">
                    <div class="xp-header-bar-progress" style="width: {{ user_progress_percent }}%"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
<div class="auth-links">
    <a href="{{ url_for('auth.login') }}" class="auth-btn login-btn">üîë P≈ôihl√°sit se</a>
    <a href="{{ url_for('auth.register') }}" class="auth-btn register-btn">üìù Registrovat se</a>
</div>
        {% endif %}
    </div>
</header>
<main>
    {% block content %}{% endblock %}
</main>
<footer>
    <p>&copy; 2025 Knowix. V≈°echna pr√°va vyhrazena.</p>
    <p class="footer-signature">
        Made with ‚ù§Ô∏è by
        <a href="https://ko-fi.com/voku199" target="_blank" style="color: inherit; text-decoration: underline;">Voku</a>
        and lot of ‚òï
    </p>
</footer>
<script src="/static/js/pwa.js"></script>
<script>
(function(){
  // Gener√°tor jednoduch√Ωch snƒõhov√Ωch vloƒçek - vytv√°≈ô√≠ elementy s n√°hodnou pozic√≠, rychlost√≠ a velikost√≠
  const container = document.getElementById('snow-container');
  if (!container) return;

  // Vrac√≠ barvu vloƒçek podle pozad√≠/t√©my (svƒõtl√© pozad√≠ -> tmav√© vloƒçky)
  function computeSnowColor(){
    // Pokud m√°me explictn√≠ t≈ô√≠du dark-mode, pou≈æij b√≠lou
    if (document.body.classList.contains('dark-mode')){ window.__snow_is_light = false; return '#ffffff'; }

    // Zkontroluj nƒõkolik element≈Ø (body, main, #content-wrapper) a spoƒçti pr≈Ømƒõrnou luminanci
    try{
      const candidates = [document.body, document.querySelector('#content-wrapper'), document.querySelector('main')].filter(Boolean);
      let sumLum = 0, count = 0;
      for (const el of candidates){
        const bg = window.getComputedStyle(el).backgroundColor;
        if (!bg) continue;
        const m = bg.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
        if (!m) continue;
        const r = parseInt(m[1],10), g = parseInt(m[2],10), b = parseInt(m[3],10);
        const lum = 0.2126*r + 0.7152*g + 0.0722*b;
        sumLum += lum; count++;
      }
      const avgLum = count ? (sumLum / count) : 255;
      // pokud je pr≈Ømƒõrn√° luminance > 150 -> svƒõtl√© pozad√≠ => tmav√© vloƒçky
      window.__snow_is_light = (avgLum > 150);
      return window.__snow_is_light ? '#111111' : '#ffffff';
    }catch(e){
      window.__snow_is_light = true;
      return '#111111';
    }
  }

  // Pou≈æij barvu jednou; p≈ô√≠padnƒõ obnov p≈ôi resize/t√©matu
  let currentSnowColor = computeSnowColor();
  // glob√°ln√≠ p≈ô√≠znak pro jednoduch√© kontroly
  window.__snow_is_light = !!window.__snow_is_light;

  const maxFlakes = Math.min(Math.max(Math.round(window.innerWidth / 30), 15), 120); // p≈ôizp≈Øsob√≠ se ≈°√≠≈ôce
  function createFlake(){
    let f;
    const size = Math.random() * 10 + 6; // 6-16px
    // Pokud je str√°nka svƒõtl√°, preferuj SVG ≈°ed√© vloƒçky; jinak pou≈æij b√≠l√© unicode vloƒçky
    const useSvgFlake = (window.__snow_is_light === true) ? (Math.random() < 0.95) : (Math.random() < 0.18);
    if (useSvgFlake) {
      // vytvo≈ô√≠me inline SVG m√≠sto kulat√© teƒçky
      const dim = Math.round(10 + Math.random() * 8); // 10-18
      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('width', dim);
      svg.setAttribute('height', dim);
      svg.setAttribute('viewBox', `0 0 ${dim} ${dim}`);
      svg.className.baseVal = 'flake-svg';
      // urƒçeme variantu stroke width podle velikosti
      if (dim < 12) svg.classList.add('small'); else if (dim < 16) svg.classList.add('medium'); else svg.classList.add('large');
      // pozice a styl
      svg.style.left = Math.random() * 100 + '%';
      svg.style.top = '-10px';
      svg.style.opacity = (0.65 + Math.random() * 0.35).toFixed(2);
      svg.style.transformOrigin = 'center';

      // styl: ≈°ed√° barva pro lep≈°√≠ kontrast na b√≠l√©m pozad√≠
      const strokeColor = '#8a8a8a';

      // jednoduch√° vloƒçka: 6 paprsk≈Ø
      const cx = dim/2, cy = dim/2, len = dim*0.38;
      for (let i=0;i<6;i++){
        const ang = (i * Math.PI / 3);
        const x1 = cx - Math.cos(ang)*len;
        const y1 = cy - Math.sin(ang)*len;
        const x2 = cx + Math.cos(ang)*len;
        const y2 = cy + Math.sin(ang)*len;
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', x1); line.setAttribute('y1', y1); line.setAttribute('x2', x2); line.setAttribute('y2', y2);
        line.setAttribute('stroke', strokeColor);
        line.setAttribute('stroke-opacity', 0.95);
        line.setAttribute('stroke-width', Math.max(1, Math.round(dim*0.12)));
        svg.appendChild(line);
        // drobn√© vƒõtviƒçky u nƒõkter√Ωch paprsk≈Ø (dekor)
        const bx = cx + Math.cos(ang)* (len*0.55);
        const by = cy + Math.sin(ang)* (len*0.55);
        const angL = ang + Math.PI/6; const angR = ang - Math.PI/6;
        const l1 = document.createElementNS(svgNS, 'line');
        l1.setAttribute('x1', bx); l1.setAttribute('y1', by);
        l1.setAttribute('x2', bx + Math.cos(angL)* (len*0.18));
        l1.setAttribute('y2', by + Math.sin(angL)* (len*0.18));
        l1.setAttribute('stroke', strokeColor); l1.setAttribute('stroke-opacity',0.9); l1.setAttribute('stroke-width', Math.max(1, Math.round(dim*0.08)));
        svg.appendChild(l1);
        const l2 = document.createElementNS(svgNS, 'line');
        l2.setAttribute('x1', bx); l2.setAttribute('y1', by);
        l2.setAttribute('x2', bx + Math.cos(angR)* (len*0.18));
        l2.setAttribute('y2', by + Math.sin(angR)* (len*0.18));
        l2.setAttribute('stroke', strokeColor); l2.setAttribute('stroke-opacity',0.9); l2.setAttribute('stroke-width', Math.max(1, Math.round(dim*0.08)));
        svg.appendChild(l2);
      }

      // lehk√© ot√°ƒçen√≠ pro variaci
      svg.style.transition = `transform ${8000 + Math.random()*8000}ms linear`;
      f = svg;
    } else {
      const div = document.createElement('div');
      div.className = 'snowflake';
      div.style.fontSize = size + 'px';
      div.style.left = Math.random() * 100 + '%';
      div.style.opacity = (0.5 + Math.random() * 0.5).toFixed(2);
      div.style.color = currentSnowColor;
      if (currentSnowColor === '#111111' || currentSnowColor === '#000') {
        div.style.textShadow = '0 1px 0 rgba(255,255,255,0.85)';
      } else {
        div.style.textShadow = '0 1px 2px rgba(0,0,0,0.35)';
      }
      div.textContent = '‚ùÑ';
      f = div;
    }

    // Animace p≈ôes transform pomoc√≠ transition + JS (kompatibiln√≠ fallback)
    const duration = 8000 + Math.random() * 12000; // 8-20s
    f.style.transition = `transform ${duration}ms linear, top ${duration}ms linear, left ${duration}ms linear`;

    container.appendChild(f);

    // Vypoƒçti koncovou pozici a p≈ôidej jemn√© ot√°ƒçen√≠
    requestAnimationFrame(()=>{
      const endX = (Math.random() * 20 - 10); // horizont√°ln√≠ drift
      const rot = (Math.random()*60 - 30); // ot√°ƒçen√≠ bƒõhem p√°du
      f.style.transform = `translate(${endX}vw, ${window.innerHeight + 40}px) rotate(${rot}deg)`;
    });

    // Odstranƒõn√≠ po dobƒõ trv√°n√≠
    setTimeout(()=>{ try{ f.remove(); }catch(e){} }, duration + 500);
  }

  // Plynul√© dopl≈àov√°n√≠ vloƒçek
  let running = true;
  function loop(){
    if (!running) return;
    if (container.children.length < maxFlakes) createFlake();
    setTimeout(loop, 200 + Math.random() * 300);
  }
  loop();

  // Pokud se zmƒõn√≠ rozmƒõr nebo t√©ma, znovu vypoƒçti barvu
  window.addEventListener('resize', ()=>{ currentSnowColor = computeSnowColor(); });
  // Poslouchej zmƒõnu t≈ô√≠dy dark-mode (pokud nƒõkdo p≈ôep√≠n√° t√©ma JSem)
  const mo = new MutationObserver(()=>{ currentSnowColor = computeSnowColor(); });
  mo.observe(document.body, { attributes: true, attributeFilter:['class'] });

})();
</script>

<!-- P≈ôid√°me jednor√°zovou v√°noƒçn√≠ bublinu (toast) -->
<script>
(function(){
  const KEY = 'knowix_xmas_toast_shown_v1';
  const PHRASE = 'Vesel√© V√°noce a ≈°≈•astn√Ω nov√Ω rok od Knowix! üéÑ';
  // zobraz jen jednou za session/klienta
  if (sessionStorage.getItem(KEY)) return;

  function pageHasPhrase(){
    try{
      if (document.body && document.body.innerText && document.body.innerText.indexOf(PHRASE) !== -1) return true;
      const footer = document.querySelector('footer');
      if (footer && footer.innerText && footer.innerText.indexOf(PHRASE) !== -1) return true;
      if (document.querySelector('.xmas-greeting') && document.querySelector('.xmas-greeting').innerText.indexOf(PHRASE) !== -1) return true;
    }catch(e){ /* ignore */ }
    return false;
  }

  function showToastOnce(){
    if (sessionStorage.getItem(KEY)) return;
    try{
      const toast = document.createElement('div');
      toast.className = 'xmas-toast show';

      const img = document.createElement('img');
      img.src = '/static/pic/christmas_icon.png';
      img.alt = 'üéÑ';
      img.onerror = function(){ this.style.display='none'; };

      const txt = document.createElement('div');
      txt.textContent = PHRASE;

      const close = document.createElement('button');
      close.className = 'xmas-close';
      close.innerHTML = '‚úï';
      close.addEventListener('click', ()=>{ toast.remove(); sessionStorage.setItem(KEY,'1'); });

      toast.appendChild(img);
      toast.appendChild(txt);
      toast.appendChild(close);

      document.body.appendChild(toast);

      // automaticky skryj po some sekund√°ch
      setTimeout(()=>{ try{ if(document.body.contains(toast)){ toast.remove(); sessionStorage.setItem(KEY,'1'); } }catch(e){} }, 9000);
    }catch(e){ console.error('xmas toast error', e); }
  }

  // Pokud u≈æ str√°nka obsahuje fr√°zi, uka≈æ toast, jinak sleduj DOM kr√°tce
  if (pageHasPhrase()){
    setTimeout(showToastOnce, 600); // mal√° prodleva, a≈• nen√≠ v konfliktu s layoutem
  } else {
    const mo = new MutationObserver((muts, obs)=>{
      if (pageHasPhrase()){
        obs.disconnect();
        showToastOnce();
      }
    });
    mo.observe(document.body, { childList:true, subtree:true });
    // timeout - pokud se fr√°ze neobjev√≠ do 5s, p≈ôesta≈à sledovat
    setTimeout(()=>{ try{ mo.disconnect(); }catch(e){} }, 5000);
  }

})();
</script>

<!-- zachovej dal≈°√≠ skripty a include onboarding -->
<!--<script>-->
<!--// P≈ôidej mal√Ω v√°noƒçn√≠ text do patiƒçky (pokud nen√≠) - nech√°v√°me mo≈ænost lokalizace p≈ôes Jinja-->
<!--(function(){-->
<!--  const footer = document.querySelector('footer');-->
<!--  if (footer && !footer.querySelector('.xmas-greeting')){-->
<!--    const p = document.createElement('p');-->
<!--    p.className = 'xmas-greeting';-->
<!--    p.textContent = 'Vesel√© V√°noce a ≈°≈•astn√Ω nov√Ω rok od Knowix! üéÑ';-->
<!--    footer.insertBefore(p, footer.firstChild);-->
<!--  }-->
<!--})();-->
<!--</script>-->
<script>
// Diagnostika push notifikac√≠
document.getElementById('test-push')?.addEventListener('click', async function() {
    try {
        const response = await fetch('/push/test-send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify({
                title: 'Test Knowix',
                body: 'Pokud vid√≠≈° tuto zpr√°vu, push notifikace funguj√≠! üéâ',
                url: '/'
            })
        });

        const result = await response.json();
        alert('Test v√Ωsledek:\n' + JSON.stringify(result, null, 2));
    } catch (error) {
        alert('Chyba testu: ' + error.message);
    }
});

// P≈ôep√≠naƒç notifikac√≠: povolit/vypnout (unsubscribe)
(function(){
  const btn = document.getElementById('enable-notifications');
  if (!btn) return;

  // Pomocn√° funkce pro nastaven√≠ vizu√°lu tlaƒç√≠tka
  function setBtnState(enabled){
    if (enabled){
      btn.querySelector('.icon')?.replaceWith(Object.assign(document.createElement('span'), {className:'icon', textContent:'üîî'}));
      btn.querySelector('.label')?.replaceWith(Object.assign(document.createElement('span'), {className:'label', textContent:'Vypnout notifikace'}));
      btn.title = 'Vypnout notifikace';
    } else {
      btn.querySelector('.icon')?.replaceWith(Object.assign(document.createElement('span'), {className:'icon', textContent:'üîî'}));
      btn.querySelector('.label')?.replaceWith(Object.assign(document.createElement('span'), {className:'label', textContent:'Povolit notifikace'}));
      btn.title = 'Povolit notifikace';
    }
  }

  // Inicializace stavu podle subscription
  (async function init(){
    try {
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      setBtnState(!!sub && Notification.permission === 'granted');
      btn.style.display = 'inline-block';
    } catch(e){ /* ignore */ }
  })();

  btn.addEventListener('click', async function(){
    try {
      // Pokud prohl√≠≈æeƒç nepodporuje notifikace
      if (!('Notification' in window)){
        alert('Notifikace nejsou podporovan√© t√≠mto prohl√≠≈æeƒçem.');
        return;
      }
      const reg = await navigator.serviceWorker.ready;
      let sub = await reg.pushManager.getSubscription();

      // Pokud je subscription a povolen√≠ udƒõleno -> vypnout (unsubscribe)
      if (sub && Notification.permission === 'granted'){
        const ok = await sub.unsubscribe();
        setBtnState(false);
        if (!ok){
          console.warn('Unsubscribe nevr√°til OK, ale subscription by mƒõla b√Ωt zru≈°ena.');
        }
        alert('Notifikace byly vypnuty.');
        return;
      }

      // Pokud nem√°me subscription, po≈æ√°d√°me o opr√°vnƒõn√≠ a pokus√≠me se p≈ôihl√°sit
      if (Notification.permission === 'default'){
        const perm = await Notification.requestPermission();
        if (perm !== 'granted'){
          alert('Notifikace nejsou povolen√©. Povol je v nastaven√≠ prohl√≠≈æeƒçe.');
          setBtnState(false);
          return;
        }
      } else if (Notification.permission === 'denied'){
        alert('Notifikace jsou zak√°zan√© v prohl√≠≈æeƒçi. Povol je v nastaven√≠.');
        setBtnState(false);
        return;
      }

      // Vytvo≈ôen√≠ nov√© subscription (vy≈æaduje VAPID public key na serveru ‚Äì pokud pwa.js ji≈æ ≈ôe≈°√≠, jen triggeruj)
      try {
        // Pokud va≈°e pwa.js obsahuje logiku pro subscribe, lze ji vyvolat ud√°lost√≠/custom handlerem.
        // Zde fallback: pokus o vytvo≈ôen√≠ subscription bez odesl√°n√≠ na server (nutn√© doplnit VAPID kl√≠ƒç v re√°ln√© implementaci).
        const newSub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: undefined });
        if (newSub){
          setBtnState(true);
          alert('Notifikace byly povoleny.');
        } else {
          alert('Nepoda≈ôilo se povolit notifikace.');
          setBtnState(false);
        }
      } catch(err){
        console.error('Subscribe error', err);
        alert('Chyba p≈ôi povolov√°n√≠ notifikac√≠.');
        setBtnState(false);
      }
    } catch(e){
      console.error('Toggle notif error', e);
      alert('Chyba p≈ôi zmƒõnƒõ stavu notifikac√≠.');
    }
  });
})();

    document.getElementById('theme-toggle').addEventListener('click', () => {
        fetch('/set_theme', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN},
            body: JSON.stringify({
                theme: document.body.classList.contains('dark-mode') ? 'light' : 'dark',
                csrf_token: CSRF_TOKEN
            })
        }).then(r => {
            if (r.ok) {
                document.body.classList.toggle('dark-mode');
                sessionStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            }
        });
    });
</script>
<script>
(function(){
  const btn = document.getElementById('test-notif');
  if(!btn) return;
  btn.addEventListener('click', async ()=>{
    try {
      if(Notification.permission === 'default') {
        await Notification.requestPermission();
      }
      if(Notification.permission !== 'granted') {
        alert('Notifikace nejsou povoleny v prohl√≠≈æeƒçi/OS.');
        return;
      }
      const reg = await navigator.serviceWorker.ready;
      // Preferuj PNG (Windows/Chrome ƒçasto l√©pe zobraz√≠)
      const iconPng = '/static/icons/bell.png';
      await reg.showNotification('Test notifikace ‚Äì Knowix', {
        body: 'Pokud vid√≠≈° tento toast, notifikace funguj√≠. (klikni pro otev≈ôen√≠ dom≈Ø)',
        icon: iconPng,
        badge: iconPng,
        requireInteraction: true,
        renotify: true,
        tag: 'knowix-test-1',
        vibrate: [100, 50, 100],
        data: { url: '/' }
      });
      // Fallback pro nƒõkter√° prost≈ôed√≠ ‚Äì vytvo≈ô√≠ i ne-persistentn√≠ notifikaci
      try { new Notification('Fallback notif', { body: 'Alternativn√≠ zp≈Øsob zobrazen√≠', icon: iconPng, tag: 'knowix-fallback-1', requireInteraction: true }); } catch(_){ }
    } catch(e){ console.error('Test notifikace selhal', e); alert('Zobrazen√≠ notifikace selhalo ‚Äì viz konzoli.'); }
  });
})();
</script>
<script>
// P≈ôid√°n√≠ pulzu po zobrazen√≠ tlaƒç√≠tek (pozoruje zmƒõnu display)
(function(){
  const notifBtn = document.getElementById('enable-notifications');
  const installBtn = document.getElementById('install-app');
  const observer = new MutationObserver(muts => {
    muts.forEach(m => {
      if (m.attributeName === 'style') {
        if (installBtn && installBtn.style.display !== 'none' && !installBtn.classList.contains('pulse')) {
          installBtn.classList.add('pulse');
        }
        if (notifBtn && notifBtn.style.display !== 'none' && !notifBtn.classList.contains('pulse')) {
          notifBtn.classList.add('pulse');
        }
      }
    });
  });
  if (installBtn) observer.observe(installBtn, {attributes:true});
  if (notifBtn) observer.observe(notifBtn, {attributes:true});
})();
</script>

{# Onboarding overlay ‚Äì vlo≈æeno glob√°lnƒõ #}
{% include 'onboarding.html' %}

</body>
</html>
