{% extends "base.html" %}
{% block content %}
    <style>
        .word-box { display: inline-block; margin: 5px; padding: 8px 14px; border: 1px solid #aaa; border-radius: 6px; cursor: pointer; background: #f8f8f8; }
        .word-box.selected { background: #cce5ff; border-color: #007bff; }
        .word-box.paired { background: #d4edda; border-color: #28a745; }
        .word-box.wrong { background: #f8d7da; border-color: #dc3545; }
        .popup-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .popup-container.active {
            opacity: 1; pointer-events: all;
        }
        .popup-content {
            background: #fff; padding: 2em 2.5em; border-radius: 18px;
            box-shadow: 0 8px 48px rgba(0,0,0,0.18);
            text-align: center;
            transform: scale(0.85); opacity: 0;
            animation: popupIn 0.35s cubic-bezier(.68,-0.55,.27,1.55) forwards;
        }
        @keyframes popupIn {
            0% { transform: scale(0.85); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .popup-buttons { margin-top: 1.5em; }
        .popup-button { margin: 0 1em; padding: 0.7em 2em; border-radius: 6px; border: none; font-size: 1.1em; cursor: pointer; transition: background 0.2s, color 0.2s; }
        .popup-button.confirm { background: #28a745; color: #fff; }
        .popup-button.confirm:hover { background: #218838; }
        .popup-button.cancel { background: #f8f9fa; color: #333; border: 1px solid #ccc; }
        .popup-button.cancel:hover { background: #e2e6ea; }
        /* Review sekce */
        #reviewSection {
            display: none;
            margin: 2em auto;
            max-width: 700px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            padding: 2em 2em 1em 2em;
            animation: fadeInReview 0.5s;
        }
        @keyframes fadeInReview {
            from { opacity: 0; transform: translateY(30px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .review-title { font-size: 1.4em; margin-bottom: 1em; }
        .review-block { margin-bottom: 1.2em; }
        .review-block.correct { background: #e6f9ea; border-left: 4px solid #28a745; }
        .review-block.incorrect { background: #fff0f0; border-left: 4px solid #dc3545; }
        .review-block.almost { background: #fffbe6; border-left: 4px solid #ffc107; }
        .review-block { padding: 1em; border-radius: 8px; }
        .review-label { font-weight: bold; }
        .review-user { color: #007bff; }
        .review-correct { color: #28a745; }
        .review-feedback { font-size: 0.98em; color: #555; margin-top: 0.3em; }

        /* --- STREAK TOAST --- */
        .streak-toast {
            position: fixed;
            top: 80px;
            right: 30px;
            background: #fffbe6;
            color: #d35400;
            border: 2px solid #ffc107;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            padding: 1em 2em;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s, transform 0.4s;
            transform: translateY(-30px);
        }
        .streak-toast.active {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }
        .streak-fire {
            height: 2em;
            margin-right: 0.7em;
            animation: firePop 0.7s cubic-bezier(.68,-0.55,.27,1.55);
        }
        @keyframes firePop {
            0% { transform: scale(0.7) rotate(-10deg);}
            60% { transform: scale(1.2) rotate(10deg);}
            100% { transform: scale(1) rotate(0);}
        }
    </style>

<main class="exercises-container">
    <!-- STREAK TOAST -->
    <div id="streakToast" class="streak-toast" style="display:none;">
        <img src="/static/fire.svg" alt="Streak" class="streak-fire">
        <span id="streakToastText"></span>
    </div>
    <form id="exerciseForm" autocomplete="off">
        <section class="exercises-section">
            {% for item in missing_exercises %}
            <div class="exercise-card">
                <h3>{{ loop.index }}. Dopl켿 chyb캩j칤c칤 slovo:</h3>
                <p class="blank-sentence">{{ item.with_blank | safe }}</p>
                <input type="text" name="missing_word_{{ loop.index0 }}" class="exercise-input" placeholder="Napi코 chyb캩j칤c칤 slovo..." data-correct="{{ item.missing_word }}" data-original="{{ item.original }}">
                <div class="feedback"></div>
            </div>
            {% endfor %}

            {% for item in translation_exercises %}
            <div class="exercise-card">
                <h3>{{ loop.index + missing_exercises|length }}. P콏elo v캩tu:</h3>
                <p class="original-sentence"><em>"{{ item.original }}"</em></p>
                <input type="text" class="exercise-input translation-input" name="translation_{{ loop.index0 }}" placeholder="Tv콢j p콏eklad..." data-correct="{{ item.translated }}" data-original="{{ item.original }}">
                <div class="feedback"></div>
            </div>
            {% endfor %}
        </section>

        <section class="word-matching">
            <h3>Spoj slova k sob캩:</h3>
            <div id="matchingExerciseContainer"></div>
        </section>

        <section class="audio-section">
            <h3>Poslechni si audio:</h3>
            <audio controls class="audio-player">
                <source src="{{ url_for('static', filename='music/audio/' + audio_file) }}" type="audio/mp3">
                Tv콢j prohl칤쬰캜 nepodporuje p콏ehr치v치n칤 audia.
            </audio>
            <button id="showLyrics" class="lyrics-toggle" type="button">Zobrazit text p칤sn캩</button>
            <div id="lyrics" class="lyrics-container"></div>
        </section>

        <button type="button" id="checkButton" class="check-button">Zkontrolovat odpov캩di</button>
        <div id="result" class="result-container"></div>

        <!-- Pop-up po 칰sp캩코n칠m dokon캜en칤 -->
        <div id="successPopup" class="popup-container" style="display: none;">
            <div class="popup-content">
                <h3>Skv캩l치 pr치ce! 游꿀</h3>
                <p>Chce코 pokra캜ovat na dal코칤 lekci?</p>
                <div class="popup-buttons">
                    <button type="button" id="nextLessonBtn" class="popup-button confirm">Ano</button>
                    <button type="button" id="reviewBtn" class="popup-button cancel">Ne, kouknu se co jsem ud캩lal</button>
                </div>
            </div>
        </div>
        <!-- NOV칗 MODAL: P콏ehled spr치vn칳ch odpov캩d칤 -->
        <div id="solutionPopup" class="popup-container" style="display: none;">
            <div class="popup-content" style="max-width: 500px;">
                <h3>Spr치vn칠 odpov캩di</h3>
                <div id="solutionContent"></div>
                <div class="popup-buttons">
                    <button type="button" id="closeSolutionBtn" class="popup-button confirm">Zav콏칤t</button>
                </div>
            </div>
        </div>
        <!-- Review sekce (u se nebude pou쮂셨at, ale nech치me pro p콏칤padn칠 dal코칤 roz코칤콏en칤) -->
        <div id="reviewSection"></div>
    </form>
</main>



<script>
/* ===== JS pro str치nku cvi캜en칤 (exercises.html) ===== */

// Zabr치n칤me reloadu formul치콏e
document.getElementById('exerciseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    return false;
});

// P콏ep칤n치n칤 dark/light re쬴mu
document.getElementById('theme-toggle').addEventListener('click', () => {
    fetch('/set_theme', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            theme: document.body.classList.contains('dark-mode') ? 'light' : 'dark'
        })
    }).then(() => {
        document.body.classList.toggle('dark-mode');
        sessionStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });
});

// LRC lyrics parsing
window.lrc_lyrics = {{ lrc_lyrics | tojson | safe }};
const lrcContent = window.lrc_lyrics || "";
function parseLrc(lrc) {
    const parsed = lrc.split('\n')
        .map(line => {
            const match = line.match(/\[(\d+):(\d+(?:\.\d+)?)\](.*)/);
            if (!match) return null;
            const minutes = parseFloat(match[1]);
            const seconds = parseFloat(match[2]);
            return {
                time: minutes * 60 + seconds,
                text: match[3].trim()
            };
        })
        .filter(line => line !== null)
        .sort((a, b) => a.time - b.time);
    return parsed;
}

document.getElementById('showLyrics').addEventListener('click', function() {
    const audio = document.querySelector('audio');
    const lyricsContainer = document.getElementById('lyrics');
    const parsedLyrics = parseLrc(lrcContent);

    if (lyricsContainer.style.display === 'none' || !lyricsContainer.style.display) {
        lyricsContainer.style.display = 'block';
        this.textContent = 'Skr칳t text p칤sn캩';
        audio.addEventListener('timeupdate', updateLyrics);
        // Initial render even before audio plays
        updateLyrics();
    } else {
        lyricsContainer.style.display = 'none';
        this.textContent = 'Zobrazit text p칤sn캩';
        audio.removeEventListener('timeupdate', updateLyrics);
    }

    function updateLyrics() {
        const currentTime = audio.currentTime;
        let currentLine = parsedLyrics.findLast(line => line.time <= currentTime);
        lyricsContainer.innerHTML = currentLine
            ? `<p class="current-line">${currentLine.text}</p>`
            : '<p>Za캜치tek skladby...</p>';
    }
});

// Profile menu hide on click outside
document.addEventListener('click', (e) => {
    const profileMenu = document.getElementById('profileMenu');
    const trigger = document.getElementById('profileMenuTrigger');
    if (profileMenu && trigger && !trigger.contains(e.target) && !profileMenu.contains(e.target)) {
        profileMenu.style.opacity = '0';
        profileMenu.style.visibility = 'hidden';
        profileMenu.style.transform = 'translateY(10px)';
    }
});

// ===== SPOJOVA캛KA: z칤sk치n칤 u쬴vatelsk칳ch p치r콢 =====
window.matchedPairs = []; // Glob치ln칤 pole pro p치ry

window.getUserMatchingPairs = function() {
    // Vrac칤 pole u쬴vatelsk칳ch sp치rovan칳ch dvojic ve form치tu [["en","cz"], ...]
    return window.matchedPairs ? window.matchedPairs.slice() : [];
};

// Kontrola odpov캩d칤 a pop-up logika
let lastCheckData = null; // Ulo쮂셠e si posledn칤 data pro review

document.getElementById('checkButton').addEventListener('click', async () => {
    const inputs = document.querySelectorAll('.exercise-input');
    const translations = [];
    const missings = [];

    inputs.forEach((input) => {
        if (input.classList.contains('translation-input')) {
            translations.push({ user: input.value });
        } else {
            missings.push({ user: input.value });
        }
    });

    // --- Z칈SK츼N칈 P츼R콡 ZE SPOJOVA캛KY ---
    let userPairs = [];
    if (window.getUserMatchingPairs) {
        userPairs = window.getUserMatchingPairs();
    }

    // DEBUG: zobraz co pos칤l치코
    console.log("ODES칈L츼M ODPOV캨DI:", {
        translations,
        missing: missings,
        pairs: userPairs
    });

    try {
        // Get CSRF token
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
        
        if (!csrfToken) {
            console.error('CSRF token not found');
            return;
        }

        const res = await fetch('/check-answer', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                translations, 
                missing: missings, 
                pairs: userPairs,
                csrf_token: csrfToken
            })
        });
        const data = await res.json();
        console.log("ODPOV캨캝 ZE SERVERU:", data);
        lastCheckData = data; // Ulo쮂셠e pro review

        // Feedback pro p콏eklady
        data.results.details.translations.forEach((result, idx) => {
            const input = document.querySelectorAll('.translation-input')[idx];
            const feedbackBox = input.nextElementSibling;
            input.classList.remove('correct', 'incorrect', 'almost');
            feedbackBox.textContent = '';
            feedbackBox.classList.remove('error-feedback');
            if (data.results.translations[idx] === true) {
                input.classList.add('correct');
            } else if (data.results.translations[idx] === 'almost') {
                input.classList.add('almost');
                feedbackBox.textContent = result.feedback || '캛치ste캜n캩 spr치vn캩, zkus to vyladit!';
                feedbackBox.classList.add('error-feedback');
            } else {
                input.classList.add('incorrect');
                feedbackBox.textContent = result.feedback || 'Zkus to znovu!';
                feedbackBox.classList.add('error-feedback');
            }
        });

        // Feedback pro missing words
        data.results.details.missing.forEach((result, idx) => {
            const input = document.querySelectorAll('.exercise-input:not(.translation-input)')[idx];
            const feedbackBox = input.nextElementSibling;
            input.classList.remove('correct', 'incorrect', 'almost');
            feedbackBox.textContent = '';
            if (data.results.missing[idx] === true) {
                input.classList.add('correct');
            } else if (data.results.missing[idx] === 'almost') {
                input.classList.add('almost');
                feedbackBox.textContent = `T칠m캩콏 spr치vn캩! Spr치vn칠 slovo: ${result.correct}`;
            } else {
                input.classList.add('incorrect');
                feedbackBox.textContent = `Spr치vn치 odpov캩캞: ${result.correct}`;
            }
        });

        // Feedback pro spojova캜ku (voliteln캩 m콢쬰코 zv칳raznit spr치vn칠/코patn칠 p치ry)

        // Zobraz pop-up pokud je v코e spr치vn캩
        if (data.success) {
            showSuccessPopup();

            // --- ZOBRAZ STREAK TOAST ---
            if (data.streak_info && (data.streak_info.status === "started" || data.streak_info.status === "continued")) {
                showStreakToast(data.streak_info.streak);
            }
        }

    } catch (error) {
        console.error('Chyba p콏i kontrole odpov캩d칤:', error);
    }
});

// Modern칤 animace pop-upu
function showSuccessPopup() {
    const popup = document.getElementById('successPopup');
    popup.style.display = 'flex';
    setTimeout(() => popup.classList.add('active'), 10);
}
function hideSuccessPopup() {
    const popup = document.getElementById('successPopup');
    popup.classList.remove('active');
    setTimeout(() => popup.style.display = 'none', 300);
}

// --- STREAK TOAST FUNKCE ---
function showStreakToast(streak) {
    const toast = document.getElementById('streakToast');
    const text = document.getElementById('streakToastText');
    text.textContent = `游댠 M치코 streak ${streak} dn칤 v 콏ad캩!`;
    toast.classList.add('active');
    toast.style.display = 'flex';
    setTimeout(() => {
        toast.classList.remove('active');
        setTimeout(() => { toast.style.display = 'none'; }, 400);
    }, 3500);
}

// NOV칄: Funkce pro zobrazen칤 spr치vn칳ch odpov캩d칤 v modalu
function showSolutionPopup() {
    const popup = document.getElementById('solutionPopup');
    const content = document.getElementById('solutionContent');
    const config = window.exerciseConfig;

    let html = '';

    // Missing words
    if (config.missing_exercises && config.missing_exercises.length) {
        html += `<div style="margin-bottom:1em;"><b>Chyb캩j칤c칤 slova:</b><ul>`;
        config.missing_exercises.forEach((word, idx) => {
            html += `<li>${idx+1}. <span style="color:#28a745;font-weight:bold;">${word}</span></li>`;
        });
        html += `</ul></div>`;
    }

    // P콏eklady
    if (config.translation_exercises && config.translation_exercises.length) {
        html += `<div style="margin-bottom:1em;"><b>Spr치vn칠 p콏eklady:</b><ul>`;
        config.translation_exercises.forEach((tr, idx) => {
            html += `<li>${idx+1}. <span style="color:#28a745;font-weight:bold;">${tr}</span></li>`;
        });
        html += `</ul></div>`;
    }

    content.innerHTML = html;
    popup.style.display = 'flex';
    setTimeout(() => popup.classList.add('active'), 10);
}
function hideSolutionPopup() {
    const popup = document.getElementById('solutionPopup');
    popup.classList.remove('active');
    setTimeout(() => popup.style.display = 'none', 300);
}

// Obsluha tla캜칤tek v pop-upech
document.getElementById('nextLessonBtn').addEventListener('click', () => {
    window.location.href = "/song-selection";
});

document.getElementById('reviewBtn').addEventListener('click', (e) => {
    e.preventDefault();
    hideSuccessPopup();
    showSolutionPopup();
});

document.getElementById('closeSolutionBtn').addEventListener('click', (e) => {
    e.preventDefault();
    hideSolutionPopup();
});

// Mo쬹ost zav콏칤t kliknut칤m mimo obsah pro oba modaly
document.getElementById('successPopup').addEventListener('click', (e) => {
    if (e.target === document.getElementById('successPopup')) {
        hideSuccessPopup();
    }
});
document.getElementById('solutionPopup').addEventListener('click', (e) => {
    if (e.target === document.getElementById('solutionPopup')) {
        hideSolutionPopup();
    }
});

// Konfigurace cvi涌쬂찧en칤 pro p콏칤padn칠 dal코칤 JS
window.exerciseConfig = {{ config | tojson | safe }};
// console.log('Konfigurace cvi캜en칤:', exerciseConfig);
// ===== SPOJOVA캛KA SLOV - KLIKAC칈, DV캨 KOLONY POD SEBOU, DARK MODE READY =====
function showMatchingExerciseMusic(pairs) {
    const container = document.getElementById('matchingExerciseContainer');
    container.innerHTML = `
        <div style="font-size:1.2em;margin-bottom:10px;">Spoj anglick치 slova s 캜esk칳mi:</div>
        <div id="matchingExerciseColumns" style="display:flex;gap:40px;justify-content:center;align-items:flex-start;margin-bottom:10px;">
            <div id="enCol" style="display:flex;flex-direction:column;gap:10px;"></div>
            <div id="czCol" style="display:flex;flex-direction:column;gap:10px;"></div>
        </div>
        <div id="matchingResult" style="margin-top:8px;font-size:1.1em;"></div>
    `;

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
    }

    // EN a CZ slova pod sebou ve dvou sloupc칤ch
    const enArr = pairs.map(p => p.en);
    const czArr = pairs.map(p => p.cz);
    shuffle(enArr);
    shuffle(czArr);
    const enCol = document.getElementById('enCol');
    const czCol = document.getElementById('czCol');
    enArr.forEach(word => {
        const div = document.createElement('div');
        div.className = 'word-box en-word';
        div.textContent = word;
        div.dataset.word = word;
        enCol.appendChild(div);
    });
    czArr.forEach(word => {
        const div = document.createElement('div');
        div.className = 'word-box cs-word';
        div.textContent = word;
        div.dataset.word = word;
        czCol.appendChild(div);
    });

    let selectedWord = null;
    window.matchedPairs = [];
    const wordBoxes = container.querySelectorAll('.word-box');

    function isAlreadyPaired(word) {
        return window.matchedPairs.some(pair => pair[0] === word || pair[1] === word);
    }

    wordBoxes.forEach(box => {
        box.addEventListener('click', function() {
            if (this.classList.contains('paired')) return;
            if (isAlreadyPaired(this.dataset.word)) return;
            this.classList.remove('wrong');
            if (!selectedWord) {
                selectedWord = this;
                this.classList.add('selected');
            } else if (
                selectedWord !== this &&
                selectedWord.classList.contains('en-word') !== this.classList.contains('en-word') &&
                !isAlreadyPaired(selectedWord.dataset.word) &&
                !isAlreadyPaired(this.dataset.word)
            ) {
                let en, cs;
                if (selectedWord.classList.contains('en-word')) {
                    en = selectedWord.dataset.word;
                    cs = this.dataset.word;
                } else {
                    en = this.dataset.word;
                    cs = selectedWord.dataset.word;
                }
                const pair = pairs.find(p => p.en === en && p.cz === cs);
                if (pair) {
                    window.matchedPairs.push([en, cs]);
                    selectedWord.classList.add('paired');
                    this.classList.add('paired');
                    selectedWord.classList.remove('selected');
                    this.classList.remove('selected');
                    selectedWord = null;
                    // Okam쬴t캩 vyhodno콘 v칳sledek
                    if (window.matchedPairs.length === pairs.length) {
                        document.getElementById('matchingResult').innerHTML = `<span style="color:#27ae60;">游꿀 V코e spr치vn캩! V칳born캩!</span>`;
                    }
                } else {
                    selectedWord.classList.add('wrong');
                    this.classList.add('wrong');
                    setTimeout(() => {
                        selectedWord.classList.remove('wrong', 'selected');
                        this.classList.remove('wrong');
                    }, 400);
                    selectedWord = null;
                }
            } else {
                if (selectedWord) selectedWord.classList.remove('selected');
                selectedWord = null;
            }
        });
    });
}

// --- DARK MODE STYLY pro spojova캜ku ---
const style = document.createElement('style');
style.innerHTML = `
.word-box { display:inline-block; margin:2px; padding:8px 14px; border:1.5px solid #aaa; border-radius:6px; cursor:pointer; background:#f8f8f8; transition:background 0.15s,border 0.15s; }
.word-box.selected { background:#cce5ff; border-color:#007bff; }
.word-box.paired { background:#d4edda; border-color:#28a745; }
.word-box.wrong { background:#f8d7da; border-color:#dc3545; }
body.dark-mode .word-box { background:#23272e; color:#fff; border-color:#444; }
body.dark-mode .word-box.selected { background:#184b7b; border-color:#3399ff; }
body.dark-mode .word-box.paired { background:#245a3a; border-color:#36c36c; }
body.dark-mode .word-box.wrong { background:#7b2323; border-color:#dc3545; }
`;
document.head.appendChild(style);

// --- Inicializace spojova캜ky na str치nce ---
if (window.exerciseConfig && window.exerciseConfig.word_pairs) {
    const pairs = Object.entries(window.exerciseConfig.word_pairs)
        .filter(([en, cz], i, arr) => arr.findIndex(([e, c]) => e === en && c === cz) === i)
        .map(([en, cz]) => ({en, cz}));
    const uniquePairs = [];
    pairs.forEach(p => {
        if (!uniquePairs.find(u => (u.en === p.en && u.cz === p.cz) || (u.en === p.cz && u.cz === p.en))) {
            uniquePairs.push(p);
        }
    });
    if (!document.getElementById('matchingExerciseContainer')) {
        const container = document.createElement('div');
        container.id = 'matchingExerciseContainer';
        document.querySelector('.exercise-section')?.appendChild(container);
    }
    showMatchingExerciseMusic(uniquePairs);
}
</script>
{% endblock %}