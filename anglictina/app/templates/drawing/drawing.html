<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description"
              content="Z√°bavn√© procviƒçov√°n√≠ angliƒçtiny pomoc√≠ p√≠sniƒçek, chatu a test≈Ø. Knowix je zdarma a bez reklam.">
        <meta name="keywords"
              content="angliƒçtina, procviƒçov√°n√≠, p√≠sniƒçky, testy, chat, v√Ωuka, zdarma, knowix, z√°bava, ≈°kola">
        <meta name="robots" content="index, follow">
        <meta property="og:title" content="Knowix ‚Äì Procviƒçov√°n√≠ angliƒçtiny zdarma">
        <meta property="og:description"
              content="Procviƒçuj angliƒçtinu z√°bavnƒõ pomoc√≠ p√≠sniƒçek, chatu a test≈Ø. Bez reklam, zdarma.">
        <meta property="og:url" content="https://www.knowix.cz">
        <meta property="og:type" content="website">
        <meta property="og:image" content="https://www.knowix.cz/static/og-banner.png">

        <link rel="canonical" href="https://www.knowix.cz">


        <title>Kreslen√≠ | Knowix</title>
        <link rel="stylesheet" href="/static/style.css">

        <!-- Preconnect zrychl√≠ DNS a spojen√≠ -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

        <!-- Font naƒçti a≈æ po naƒçten√≠ str√°nky -->
        <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet"
              media="print" onload="this.media='all'">
        <noscript>
            <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap"
                  rel="stylesheet">
        </noscript>

        <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-W1EN990JKP"></script>
        <script>
            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());

            gtag('config', 'G-W1EN990JKP');
        </script>
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "WebSite",
                "name": "Knowix",
                "url": "https://www.knowix.cz",
                "description": "Z√°bavn√© procviƒçov√°n√≠ angliƒçtiny pomoc√≠ p√≠sniƒçek, chatu a test≈Ø. Knowix je zdarma a bez reklam."
            }
        </script>
    <style>
      .resize-handle {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #4285f4;
        border: 1px solid white;
        cursor: nwse-resize;
        display: none;
        z-index: 100;
      }

      .context-menu {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        display: none;
      }

      .context-menu-item {
        padding: 8px 12px;
        cursor: pointer;
      }

      .context-menu-item:hover {
        background: #f0f0f0;
      }
    </style>
    </head>
    <body class="{{ 'dark-mode' if session.get('theme') == 'dark' else '' }}"></body>
<header>
    <div class="logo-streak-wrapper">
        <div class="logo">
            <a href="{{ url_for('main.index') }}">
                <img src="{{ url_for('static', filename='pic/logo.webp') }}" alt="Knowix Logo">
            </a>
        </div>
        <span class="streak-badge">
            <img src="/static/fire.svg" alt="Streak">
            {{ user_streak }}
        </span>
    </div>
    <div class="nav-profile-wrapper">
        <ul class="nav-right">
            <li>
                <a href="/anglictina" title="Angliƒçtina">
                    <img src="{{ url_for('static', filename='icons/eng.png') }}" alt="Angliƒçtina" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/feedback" title="Feedback">
                    <img src="{{ url_for('static', filename='icons/chat.png') }}" alt="Feedback" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/news" title="Novinky">
                    <img src="{{ url_for('static', filename='icons/bell.png') }}" alt="Novinky" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/obchod" title="Obchod">
                    <img src="{{ url_for('static', filename='icons/shop.png') }}" alt="Obchod" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/zpravy" title="Zpr√°vy">
                    <img src="{{ url_for('static', filename='icons/mail.png') }}" alt="Zpr√°vy" class="nav-icon">
                </a>
            </li>
            <li>
                <button id="theme-toggle" title="P≈ôepnout t√©ma" style="background:none;border:none;cursor:pointer;padding:0;">
                    üåô
                </button>
            </li>
        </ul>
        {% if session['user_name'] %}
        <div class="user-profile">
            <div class="profile-container">
                {% if session.get('profile_pic') %}
                <img src="{{ url_for('static', filename='profile_pics/' + session['profile_pic']) }}"
                     alt="Profilov√° fotka" width="64" class="profile-pic">
                {% else %}
                <img src="{{ url_for('static', filename='pic/default.webp') }}" alt="Defaultn√≠ profilovka"
                     class="profile-pic" id="profileMenuTrigger">
                {% endif %}
                <div class="profile-menu" id="profileMenu">
                    <a href="{{ url_for('auth.settings') }}">‚öôÔ∏è Nastaven√≠</a>
                    <a href="{{ url_for('auth.logout') }}">üö™ Odhl√°sit se</a>
                </div>
                <span class="greeting" style="margin-left: 10px;">Ahoj {{ session['user_name'].split()[0] }}!</span>
            </div>
            {% if user_xp is defined and user_level is defined and user_level_name is defined and user_progress_percent is defined %}
            <div class="xp-header-bar">
                <div class="xp-header-bar-labels">
                    <span class="xp-level-badge">Level {{ user_level }} ‚Äì {{ user_level_name }}</span>
                    <span class="xp-value">{{ user_xp_in_level }}/50 XP</span>
                </div>
                <div class="xp-header-bar-progress-bg">
                    <div class="xp-header-bar-progress" style="width: {{ user_progress_percent }}%"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
<div class="auth-links">
    <a href="{{ url_for('auth.login') }}" class="auth-btn login-btn">üîë P≈ôihl√°sit se</a>
    <a href="{{ url_for('auth.register') }}" class="auth-btn register-btn">üìù Registrovat se</a>
</div>
        {% endif %}
    </div>
</header>
<body>
    <div class="container">
        <h1>Vytvo≈ôte sv≈Øj komiks</h1>

        <div class="controls">
            <div class="tool-btn active" id="btn-panel">Kreslit r√°meƒçky</div>
            <div class="tool-btn" id="btn-draw">Kreslit obsah</div>
            <div class="tool-btn" id="btn-line">Rovn√° ƒç√°ra</div>
            <div class="tool-btn" id="btn-text">P≈ôidat text</div>
            <div class="tool-btn" id="btn-image">P≈ôidat obr√°zek</div>
            <div class="tool-btn" id="btn-select">Vybrat</div>
            <div class="tool-btn" id="btn-clear">Vymazat v≈°e</div>
            <div class="tool-btn" id="btn-save">Ulo≈æit komiks</div>
            <input type="file" id="image-upload" accept="image/*" style="display:none">
        </div>

        <!-- Textov√Ω editor -->
        <div id="text-editor" class="text-editor">
            <input type="text" id="text-input" class="text-input" placeholder="Napi≈°te text...">
            <div class="font-controls">
                <input type="number" id="font-size" class="font-size-input" min="10" max="72" value="20">
                <select id="font-family">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times</option>
                    <option value="Courier New">Courier</option>
                </select>
                <input type="color" id="font-color" value="#000000">
            </div>
        </div>

        <div class="controls">
            <div class="tool-btn" id="btn-delete">Smazat</div>
            <div class="tool-btn" id="btn-forward">Dop≈ôedu</div>
            <div class="tool-btn" id="btn-backward">Dozadu</div>
        </div>
        <div id="resize-handle" class="resize-handle"></div>

        <div id="drawing-container">
            <canvas id="drawing-canvas" width="794" height="1123">
                V√°≈° prohl√≠≈æeƒç nepodporuje Canvas (knihovna pro kreslen√≠).
            </canvas>
        </div>
    </div>
    <script>
// Roz≈°√≠≈ôen√Ω stav aplikace
const canvas = document.getElementById('drawing-canvas');
const ctx = canvas.getContext('2d');
const panelBtn = document.getElementById('btn-panel');
const drawBtn = document.getElementById('btn-draw');
const lineBtn = document.getElementById('btn-line');
const textBtn = document.getElementById('btn-text');
const imageBtn = document.getElementById('btn-image');
const selectBtn = document.getElementById('btn-select');
const clearBtn = document.getElementById('btn-clear');
const saveBtn = document.getElementById('btn-save');
const textEditor = document.getElementById('text-editor');
const textInput = document.getElementById('text-input');
const fontSizeInput = document.getElementById('font-size');
const fontFamilySelect = document.getElementById('font-family');
const fontColorInput = document.getElementById('font-color');
const imageUpload = document.getElementById('image-upload');
const resizeHandle = document.getElementById('resize-handle');
const contextMenu = document.getElementById('context-menu');
const menuDelete = document.getElementById('menu-delete');
const menuBringForward = document.getElementById('menu-bring-forward');
const menuSendBackward = document.getElementById('menu-send-backward');
const btnDelete = document.getElementById('btn-delete');
const btnForward = document.getElementById('btn-forward');
const btnBackward = document.getElementById('btn-backward');

// Stav aplikace
let currentMode = 'panel';
let isDrawing = false;
let startX = 0;
let startY = 0;
let panels = [];
let contentPaths = [];
let currentPath = [];
let lines = [];
let currentLine = null;
let texts = [];
let images = [];
let textStartX = 0;
let textStartY = 0;
let selectedItem = null;
let isDragging = false;
let isResizing = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let originalAspectRatio = 1; // Ulo≈æen√≠ p≈Øvodn√≠ho pomƒõru stran obr√°zku

// Inicializace pl√°tna
function initCanvas() {
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#000000';
    ctx.lineWidth = 3;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
}

// Funkce pro zmƒõnu re≈æimu
function setMode(mode) {
    currentMode = mode;
    panelBtn.classList.toggle('active', mode === 'panel');
    drawBtn.classList.toggle('active', mode === 'draw');
    lineBtn.classList.toggle('active', mode === 'line');
    textBtn.classList.toggle('active', mode === 'text');
    imageBtn.classList.toggle('active', mode === 'image');
    selectBtn.classList.toggle('active', mode === 'select');

    if (mode === 'select') {
        canvas.style.cursor = 'default';
    } else if (mode === 'draw' || mode === 'line') {
        canvas.style.cursor = 'crosshair';
    } else if (mode === 'text') {
        canvas.style.cursor = 'text';
    } else {
        canvas.style.cursor = 'default';
    }

    // Skr√Ωt resize handle p≈ôi zmƒõnƒõ re≈æimu
    resizeHandle.style.display = 'none';
    selectedItem = null;
}

// P≈ôekreslen√≠ cel√© sc√©ny
function redrawScene() {
    // Vymazat pl√°tno
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Nakreslit b√≠l√© pozad√≠
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Nakreslit panely (r√°meƒçky) - dozadu
    panels.forEach(panel => {
        ctx.strokeRect(panel.x, panel.y, panel.width, panel.height);
    });

    // Nakreslit obsah (kresby)
    ctx.strokeStyle = '#000000';
    ctx.lineWidth = 3;
    contentPaths.forEach(path => {
        if (path.length > 0) {
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }
            ctx.stroke();
        }
    });

    // Nakreslit ƒç√°ry
    lines.forEach(line => {
        ctx.beginPath();
        ctx.moveTo(line.startX, line.startY);
        ctx.lineTo(line.endX, line.endY);
        ctx.stroke();
    });

    // Nakreslit obr√°zky
    images.forEach(img => {
        ctx.drawImage(img.image, img.x, img.y, img.width, img.height);
    });

    // Nakreslit texty
    ctx.textBaseline = 'top';
    texts.forEach(text => {
        ctx.font = `${text.size}px ${text.font}`;
        ctx.fillStyle = text.color;
        ctx.fillText(text.content, text.x, text.y);
    });

    // Zv√Ωraznit vybran√Ω prvek
    if (selectedItem) {
        ctx.strokeStyle = '#4285f4';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 3]);

        if (selectedItem.type === 'image') {
            const img = images[selectedItem.index];
            ctx.strokeRect(img.x, img.y, img.width, img.height);
        } else if (selectedItem.type === 'drawing') {
            const path = contentPaths[selectedItem.index];
            if (path.length > 0) {
                let minX = path[0].x, minY = path[0].y, maxX = path[0].x, maxY = path[0].y;
                for (const point of path) {
                    minX = Math.min(minX, point.x);
                    minY = Math.min(minY, point.y);
                    maxX = Math.max(maxX, point.x);
                    maxY = Math.max(maxY, point.y);
                }
                ctx.strokeRect(minX, minY, maxX - minX, maxY - minY);
            }
        } else if (selectedItem.type === 'text') {
            const text = texts[selectedItem.index];
            const textWidth = ctx.measureText(text.content).width;
            ctx.strokeRect(text.x, text.y, textWidth, text.size);
        } else if (selectedItem.type === 'panel') {
            const panel = panels[selectedItem.index];
            ctx.strokeRect(panel.x, panel.y, panel.width, panel.height);
        } else if (selectedItem.type === 'line') {
            const line = lines[selectedItem.index];
            ctx.beginPath();
            ctx.moveTo(line.startX, line.startY);
            ctx.lineTo(line.endX, line.endY);
            ctx.stroke();
        }

        ctx.setLineDash([]);
    }
}

// Funkce pro zobrazen√≠ resize handle
function showResizeHandle(x, y) {
    resizeHandle.style.display = 'block';
    resizeHandle.style.left = (x - 5) + 'px';
    resizeHandle.style.top = (y - 5) + 'px';
}

// Funkce pro skryt√≠ resize handle
function hideResizeHandle() {
    resizeHandle.style.display = 'none';
}

// Funkce pro zobrazen√≠ kontextov√©ho menu
function showContextMenu(x, y) {
    contextMenu.style.display = 'block';
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
}

// Funkce pro skryt√≠ kontextov√©ho menu
function hideContextMenu() {
    contextMenu.style.display = 'none';
}

// Funkce pro vybr√°n√≠ prvku
function selectItem(item) {
    selectedItem = item;

    if (selectedItem) {
        if (selectedItem.type === 'image') {
            const img = images[selectedItem.index];
            const canvasRect = canvas.getBoundingClientRect();
            showResizeHandle(canvasRect.left + img.x + img.width, canvasRect.top + img.y + img.height);
        } else {
            hideResizeHandle();
        }
    } else {
        hideResizeHandle();
    }

    redrawScene();
}

// Funkce pro kontrolu, zda je bod uvnit≈ô obr√°zku
function isPointInImage(x, y, img) {
    return x >= img.x && x <= img.x + img.width &&
           y >= img.y && y <= img.y + img.height;
}

// Funkce pro kontrolu, zda je bod uvnit≈ô kresby
function isPointInDrawing(x, y, path) {
    // Zjednodu≈°en√° kontrola - projde v≈°echny body a hled√° bl√≠zk√Ω
    for (const point of path) {
        const distance = Math.sqrt(Math.pow(point.x - x, 2) + Math.pow(point.y - y, 2));
        if (distance < 10) return true;
    }
    return false;
}

// Funkce pro kontrolu, zda je bod uvnit≈ô textu
function isPointInText(x, y, text, ctx) {
    const textWidth = ctx.measureText(text.content).width;
    return x >= text.x && x <= text.x + textWidth &&
           y >= text.y && y <= text.y + text.size;
}

// Funkce pro kontrolu, zda je bod uvnit≈ô panelu
function isPointInPanel(x, y, panel) {
    return x >= panel.x && x <= panel.x + panel.width &&
           y >= panel.y && y <= panel.y + panel.height;
}

// Funkce pro kontrolu, zda je bod na ƒç√°≈ôe
function isPointOnLine(x, y, line, tolerance = 5) {
    // Vzd√°lenost od bodu k √∫seƒçce
    const A = {x: line.startX, y: line.startY};
    const B = {x: line.endX, y: line.endY};
    const P = {x, y};

    // Pokud je √∫seƒçka jen bod
    if (A.x === B.x && A.y === B.y) {
        return Math.sqrt(Math.pow(A.x - P.x, 2) + Math.pow(A.y - P.y, 2)) <= tolerance;
    }

    // Vektor AB
    const AB = {x: B.x - A.x, y: B.y - A.y};
    // Vektor AP
    const AP = {x: P.x - A.x, y: P.y - A.y};

    // Skal√°rn√≠ souƒçin
    const dot = AP.x * AB.x + AP.y * AB.y;
    // D√©lka AB na druhou
    const lenAB = AB.x * AB.x + AB.y * AB.y;

    // Normalizovan√° vzd√°lenost pod√©l √∫seƒçky
    const t = Math.max(0, Math.min(1, dot / lenAB));

    // Projekce P na AB
    const proj = {
        x: A.x + t * AB.x,
        y: A.y + t * AB.y
    };

    // Vzd√°lenost P od projekce
    const dist = Math.sqrt(Math.pow(P.x - proj.x, 2) + Math.pow(P.y - proj.y, 2));

    return dist <= tolerance;
}

// Funkce pro smaz√°n√≠ vybran√©ho prvku
function deleteSelectedItem() {
    if (!selectedItem) return;

    if (selectedItem.type === 'image') {
        images.splice(selectedItem.index, 1);
    } else if (selectedItem.type === 'drawing') {
        contentPaths.splice(selectedItem.index, 1);
    } else if (selectedItem.type === 'text') {
        texts.splice(selectedItem.index, 1);
    } else if (selectedItem.type === 'panel') {
        panels.splice(selectedItem.index, 1);
    } else if (selectedItem.type === 'line') {
        lines.splice(selectedItem.index, 1);
    }

    selectItem(null);
    redrawScene();
}

// Funkce pro p≈ôesun dop≈ôedu
function bringSelectedItemForward() {
    if (!selectedItem) return;

    let array;
    switch (selectedItem.type) {
        case 'image': array = images; break;
        case 'drawing': array = contentPaths; break;
        case 'text': array = texts; break;
        case 'panel': array = panels; break;
        case 'line': array = lines; break;
        default: return;
    }

    if (selectedItem.index >= array.length - 1) return;

    const nextIndex = selectedItem.index + 1;
    [array[selectedItem.index], array[nextIndex]] = [array[nextIndex], array[selectedItem.index]];
    selectedItem.index = nextIndex;
    redrawScene();
}

// Funkce pro p≈ôesun dozadu
function sendSelectedItemBackward() {
    if (!selectedItem) return;

    let array;
    switch (selectedItem.type) {
        case 'image': array = images; break;
        case 'drawing': array = contentPaths; break;
        case 'text: array = texts; break;
        case 'panel': array = panels; break;
        case 'line': array = lines; break;
        default: return;
    }

    if (selectedItem.index <= 0) return;

    const prevIndex = selectedItem.index - 1;
    [array[selectedItem.index], array[prevIndex]] = [array[prevIndex], array[selectedItem.index]];
    selectedItem.index = prevIndex;
    redrawScene();
}

// Event listeners pro tlaƒç√≠tka
panelBtn.addEventListener('click', () => setMode('panel'));
drawBtn.addEventListener('click', () => setMode('draw'));
lineBtn.addEventListener('click', () => setMode('line'));
textBtn.addEventListener('click', () => setMode('text'));
imageBtn.addEventListener('click', () => {
    setMode('image');
    imageUpload.click();
});
selectBtn.addEventListener('click', () => setMode('select'));
btnDelete.addEventListener('click', deleteSelectedItem);
btnForward.addEventListener('click', bringSelectedItemForward);
btnBackward.addEventListener('click', sendSelectedItemBackward);

// Nahr√°n√≠ obr√°zku
imageUpload.addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();

        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                // Ulo≈æ√≠me p≈Øvodn√≠ pomƒõr stran
                originalAspectRatio = img.width / img.height;

                // P≈ôid√°me obr√°zek do pole s v√Ωchoz√≠ pozic√≠
                images.push({
                    image: img,
                    x: canvas.width/2 - img.width/2,
                    y: canvas.height/2 - img.height/2,
                    width: img.width,
                    height: img.height,
                    originalWidth: img.width,
                    originalHeight: img.height
                });
                redrawScene();
            };
            img.src = event.target.result;
        };

        reader.readAsDataURL(e.target.files[0]);
    }
});

clearBtn.addEventListener('click', () => {
    panels = [];
    contentPaths = [];
    lines = [];
    texts = [];
    images = [];
    selectedItem = null;
    hideResizeHandle();
    initCanvas();
});

saveBtn.addEventListener('click', () => {
    const dataUrl = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = 'komiks.png';
    link.href = dataUrl;
    link.click();
});

// Event listeners pro pl√°tno
canvas.addEventListener('mousedown', (e) => {
    const mouseX = e.offsetX;
    const mouseY = e.offsetY;

    if (currentMode === 'select') {
        // 1. Kontrola, zda kliknuto na resize handle
        const handleRect = resizeHandle.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();
        const handleX = handleRect.left - canvasRect.left;
        const handleY = handleRect.top - canvasRect.top;

        if (Math.abs(mouseX - handleX - 5) < 10 && Math.abs(mouseY - handleY - 5) < 10) {
            isResizing = true;
            return;
        }

        // 2. Kontrola, zda kliknuto na nƒõjak√Ω prvek
        let clickedItem = null;

        // Obr√°zky (od konce, proto≈æe posledn√≠ je naho≈ôe)
        for (let i = images.length - 1; i >= 0; i--) {
            if (isPointInImage(mouseX, mouseY, images[i])) {
                clickedItem = { type: 'image', index: i };
                break;
            }
        }

        // Kresby
        if (!clickedItem) {
            for (let i = contentPaths.length - 1; i >= 0; i--) {
                if (isPointInDrawing(mouseX, mouseY, contentPaths[i])) {
                    clickedItem = { type: 'drawing', index: i };
                    break;
                }
            }
        }

        // Texty
        if (!clickedItem) {
            for (let i = texts.length - 1; i >= 0; i--) {
                if (isPointInText(mouseX, mouseY, texts[i], ctx)) {
                    clickedItem = { type: 'text', index: i };
                    break;
                }
            }
        }

        // Panely
        if (!clickedItem) {
            for (let i = panels.length - 1; i >= 0; i--) {
                if (isPointInPanel(mouseX, mouseY, panels[i])) {
                    clickedItem = { type: 'panel', index: i };
                    break;
                }
            }
        }

        // ƒå√°ry
        if (!clickedItem) {
            for (let i = lines.length - 1; i >= 0; i--) {
                if (isPointOnLine(mouseX, mouseY, lines[i])) {
                    clickedItem = { type: 'line', index: i };
                    break;
                }
            }
        }

        if (clickedItem) {
            // Pokud dr≈æ√≠me Ctrl, p≈ôid√°me k v√Ωbƒõru, jinak nov√Ω v√Ωbƒõr
            if (e.ctrlKey || e.metaKey) {
                // Pro jednoduchost jen jeden v√Ωbƒõr
            } else {
                selectItem(clickedItem);
            }

            // P≈ô√≠prava pro p≈ôesun
            isDragging = true;
            dragOffsetX = mouseX;
            dragOffsetY = mouseY;

            // Kontextov√© menu na prav√Ω klik
            if (e.button === 2) {
                const canvasRect = canvas.getBoundingClientRect();
                showContextMenu(e.clientX, e.clientY);
            }
        } else {
            selectItem(null);
        }
    }
    else if (currentMode === 'panel') {
        isDrawing = true;
        startX = e.offsetX;
        startY = e.offsetY;
    }
    else if (currentMode === 'draw') {
        isDrawing = true;
        currentPath = [{x: e.offsetX, y: e.offsetY}];
    }
    else if (currentMode === 'line') {
        isDrawing = true;
        startX = e.offsetX;
        startY = e.offsetY;
        currentLine = {
            startX: startX,
            startY: startY,
            endX: startX,
            endY: startY
        };
    }
    else if (currentMode === 'text') {
        textStartX = e.offsetX;
        textStartY = e.offsetY;

        // Zobrazit textov√Ω editor na spr√°vn√© pozici
        const canvasRect = canvas.getBoundingClientRect();
        textEditor.style.display = 'block';
        textEditor.style.left = (canvasRect.left + textStartX + 10) + 'px';
        textEditor.style.top = (canvasRect.top + textStartY + 10) + 'px';
        textInput.focus();
    }
});

canvas.addEventListener('mousemove', (e) => {
    const mouseX = e.offsetX;
    const mouseY = e.offsetY;

    if (currentMode === 'select') {
        if (isDragging && selectedItem) {
            // P≈ôesun vybran√©ho prvku
            const diffX = mouseX - dragOffsetX;
            const diffY = mouseY - dragOffsetY;
            dragOffsetX = mouseX;
            dragOffsetY = mouseY;

            if (selectedItem.type === 'image') {
                const img = images[selectedItem.index];
                img.x += diffX;
                img.y += diffY;

                // Aktualizace resize handle
                const canvasRect = canvas.getBoundingClientRect();
                showResizeHandle(canvasRect.left + img.x + img.width, canvasRect.top + img.y + img.height);
            }
            else if (selectedItem.type === 'drawing') {
                const path = contentPaths[selectedItem.index];
                for (const point of path) {
                    point.x += diffX;
                    point.y += diffY;
                }
            }
            else if (selectedItem.type === 'text') {
                const text = texts[selectedItem.index];
                text.x += diffX;
                text.y += diffY;
            }
            else if (selectedItem.type === 'panel') {
                const panel = panels[selectedItem.index];
                panel.x += diffX;
                panel.y += diffY;
            }
            else if (selectedItem.type === 'line') {
                const line = lines[selectedItem.index];
                line.startX += diffX;
                line.startY += diffY;
                line.endX += diffX;
                line.endY += diffY;
            }

            redrawScene();
        }
        else if (isResizing && selectedItem && selectedItem.type === 'image') {
            // Zmƒõna velikosti obr√°zku
            const img = images[selectedItem.index];
            const newWidth = mouseX - img.x;

            // Zachov√°n√≠ pomƒõru stran
            if (newWidth > 10) {
                img.width = newWidth;
                img.height = newWidth / originalAspectRatio;

                // Aktualizace resize handle
                const canvasRect = canvas.getBoundingClientRect();
                showResizeHandle(canvasRect.left + img.x + img.width, canvasRect.top + img.y + img.height);
                redrawScene();
            }
        }
    }
    else if (!isDrawing) return;

    if (currentMode === 'panel') {
        redrawScene();
        const width = e.offsetX - startX;
        const height = e.offsetY - startY;
        ctx.strokeRect(startX, startY, width, height);
    }
    else if (currentMode === 'draw') {
        currentPath.push({x: e.offsetX, y: e.offsetY});
        redrawScene();

        // P≈ôekreslit aktu√°ln√≠ cestu
        ctx.beginPath();
        ctx.moveTo(currentPath[0].x, currentPath[0].y);
        for (let i = 1; i < currentPath.length; i++) {
            ctx.lineTo(currentPath[i].x, currentPath[i].y);
        }
        ctx.stroke();
    }
    else if (currentMode === 'line') {
        currentLine.endX = e.offsetX;
        currentLine.endY = e.offsetY;
        redrawScene();

        ctx.beginPath();
        ctx.moveTo(currentLine.startX, currentLine.startY);
        ctx.lineTo(currentLine.endX, currentLine.endY);
        ctx.stroke();
    }
});

canvas.addEventListener('mouseup', (e) => {
    if (currentMode === 'select') {
        isDragging = false;
        isResizing = false;
        return;
    }

    if (!isDrawing) return;
    isDrawing = false;

    if (currentMode === 'panel') {
        const endX = e.offsetX;
        const endY = e.offsetY;
        const width = endX - startX;
        const height = endY - startY;

        if (Math.abs(width) > 10 && Math.abs(height) > 10) {
            panels.push({
                x: startX,
                y: startY,
                width: width,
                height: height
            });
        }
        redrawScene();
    }
    else if (currentMode === 'draw') {
        if (currentPath.length > 1) {
            contentPaths.push([...currentPath]);
        }
        currentPath = [];
        redrawScene();
    }
    else if (currentMode === 'line') {
        const endX = e.offsetX;
        const endY = e.offsetY;
        const dx = endX - startX;
        const dy = endY - startY;
        const length = Math.sqrt(dx*dx + dy*dy);
        if (length > 10) {
            lines.push({
                startX: startX,
                startY: startY,
                endX: endX,
                endY: endY
            });
        }
        currentLine = null;
        redrawScene();
    }
});

canvas.addEventListener('mouseout', () => {
    isDrawing = false;
    if (currentMode === 'panel' || currentMode === 'line') {
        redrawScene();
    }
});

// Zak√°zat v√Ωchoz√≠ kontextov√© menu
canvas.addEventListener('contextmenu', (e) => {
    e.preventDefault();
});

// Kliknut√≠ mimo kontextov√© menu
document.addEventListener('click', (e) => {
    if (!contextMenu.contains(e.target)) {
        hideContextMenu();
    }
});

// Akce kontextov√©ho menu
menuDelete.addEventListener('click', () => {
    deleteSelectedItem();
    hideContextMenu();
});

menuBringForward.addEventListener('click', () => {
    bringSelectedItemForward();
    hideContextMenu();
});

menuSendBackward.addEventListener('click', () => {
    sendSelectedItemBackward();
    hideContextMenu();
});

// Textov√Ω editor
textInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        saveText();
    } else if (e.key === 'Escape') {
        cancelText();
    }
});

function saveText() {
    const text = textInput.value.trim();
    if (text) {
        texts.push({
            x: textStartX,
            y: textStartY,
            content: text,
            size: parseInt(fontSizeInput.value),
            font: fontFamilySelect.value,
            color: fontColorInput.value
        });
        redrawScene();
    }
    textEditor.style.display = 'none';
    textInput.value = '';
}

function cancelText() {
    textEditor.style.display = 'none';
    textInput.value = '';
}

// P≈ôesunut√≠ textov√©ho editoru p≈ôi scrollov√°n√≠
window.addEventListener('scroll', () => {
    if (textEditor.style.display === 'block') {
        const canvasRect = canvas.getBoundingClientRect();
        textEditor.style.left = (canvasRect.left + textStartX + 10) + 'px';
        textEditor.style.top = (canvasRect.top + textStartY + window.scrollY + 10) + 'px';
    }
});

// Inicializace
initCanvas();
setMode('panel');
    </script>
<script>
(function(){ if(window.__themeToggleInit) return; window.__themeToggleInit=true; const btn=document.getElementById('theme-toggle'); if(!btn) return; const CSRF_TOKEN='{{ csrf_token() }}'; btn.addEventListener('click',()=>{ fetch('/set_theme',{ method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': CSRF_TOKEN}, body: JSON.stringify({ theme: document.body.classList.contains('dark-mode') ? 'light':'dark', csrf_token: CSRF_TOKEN }) }).then(r=>{ if(r.ok){ document.body.classList.toggle('dark-mode'); sessionStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark':'light'); } }); }); })();
</script>
</body>
</html>