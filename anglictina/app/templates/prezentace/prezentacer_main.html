<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Maycomb ‚Äì Pixel mapa navigace</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}"/>
    <link rel="stylesheet" href="../../static/prezentace/style.css"/>
    <style>
        .sound-btn {
            position: fixed;
            right: 12px;
            top: 12px;
            z-index: 15;
            background: var(--c-gold);
            color: var(--c-ink);
            border: 4px solid var(--c-ink);
            box-shadow: 4px 4px 0 var(--c-ink);
            padding: 8px 10px;
            text-decoration: none;
            cursor: pointer;
            font-family: var(--pixel-font, monospace);
        }

        .sound-btn:hover, .sound-btn:focus {
            background: var(--c-orange);
            outline: none;
        }
    </style>
</head>
<body>
<button class="back-btn" aria-label="Vr√°tit se zpƒõt"
        onclick="if(history.length>2){history.back()}else{window.location.href='..'}">‚Üê Zpƒõt
</button>
<button class="sound-btn" id="soundToggleBtn" aria-label="Zvuk">üîà</button>
<audio id="bgm" preload="auto" loop src="../../static/prezentace/audio/ambient.mp3"></audio>

<div class="map-wrap full" id="mapWrap" aria-label="Klikac√≠ mapa Maycombu">
    <div class="map-inner" id="mapInner">
        <svg viewBox="0 0 800 500" role="img" aria-labelledby="mapTitle mapDesc">
            <title id="mapTitle">Mapa Maycombu</title>
            <desc id="mapDesc">Pixel mƒõsto ve stylu star√Ωch RPG map: ƒçist√° m≈ô√≠≈æka, tr√°va, ≈ôeka, spr√°vnƒõ um√≠stƒõn√© budovy,
                silnice a 4 hlavn√≠ interaktivn√≠ budovy.
            </desc>

            <!-- Definice pro textury, gradienty a filtry -->
            <defs>
                <linearGradient id="grad-river" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#4a90e2"/>
                    <stop offset="50%" stop-color="#6bb6ff"/>
                    <stop offset="100%" stop-color="#357abd"/>
                </linearGradient>
                <!-- V√Ωrazn√° tr√°va pattern -->
                <pattern id="pat-grass" width="16" height="16" patternUnits="userSpaceOnUse">
                    <rect width="16" height="16" fill="#5a7c2a"/>
                    <rect x="2" y="2" width="2" height="2" fill="#4a6b23"/>
                    <rect x="8" y="1" width="2" height="2" fill="#6b8e33"/>
                    <rect x="12" y="6" width="2" height="2" fill="#4a6b23"/>
                    <rect x="4" y="10" width="2" height="2" fill="#6b8e33"/>
                    <rect x="10" y="13" width="2" height="2" fill="#4a6b23"/>
                </pattern>
                <!-- Silnice pattern -->
                <pattern id="pat-road" width="12" height="12" patternUnits="userSpaceOnUse">
                    <rect width="12" height="12" fill="#a8a090"/>
                    <rect x="0" y="5" width="12" height="2" fill="#958876"/>
                </pattern>
                <!-- St≈ôechy pattern -->
                <pattern id="pat-roof" width="8" height="8" patternUnits="userSpaceOnUse">
                    <rect width="8" height="8" fill="#8b4513"/>
                    <rect width="8" height="2" y="0" fill="#cd853f"/>
                    <rect width="8" height="2" y="4" fill="#cd853f"/>
                </pattern>
                <!-- Park/les pattern -->
                <pattern id="pat-forest" width="12" height="12" patternUnits="userSpaceOnUse">
                    <rect width="12" height="12" fill="#2d5016"/>
                    <circle cx="3" cy="3" r="2" fill="#4a7c23"/>
                    <circle cx="9" cy="6" r="2" fill="#4a7c23"/>
                    <circle cx="6" cy="9" r="2" fill="#4a7c23"/>
                </pattern>
                <filter id="f-shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="2" dy="2" stdDeviation="1" flood-color="#000" flood-opacity="0.3"/>
                </filter>
                <filter id="f-smoke" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur stdDeviation="1.5"/>
                </filter>
            </defs>

            <!-- M≈ò√ç≈ΩKOV√ù PODKLAD (Pok√©mon styl) -->
            <rect class="base-ground" x="0" y="0" width="800" height="500" fill="url(#pat-grass)"/>

            <!-- Silniƒçn√≠ s√≠≈• (p≈ôed budovami) -->
            <g class="road-network" aria-hidden="true">
                <!-- Hlavn√≠ horizont√°ln√≠ silnice -->
                <rect class="road main" x="0" y="180" width="800" height="20" fill="url(#pat-road)"/>
                <rect class="road main" x="0" y="320" width="800" height="20" fill="url(#pat-road)"/>

                <!-- Hlavn√≠ vertik√°ln√≠ silnice -->
                <rect class="road main" x="200" y="0" width="20" height="500" fill="url(#pat-road)"/>
                <rect class="road main" x="400" y="0" width="20" height="500" fill="url(#pat-road)"/>
                <rect class="road main" x="600" y="0" width="20" height="500" fill="url(#pat-road)"/>

                <!-- Men≈°√≠ ulice -->
                <rect class="road minor" x="0" y="100" width="400" height="16" fill="url(#pat-road)"/>
                <rect class="road minor" x="500" y="120" width="300" height="16" fill="url(#pat-road)"/>
                <rect class="road minor" x="300" y="400" width="500" height="16" fill="url(#pat-road)"/>
            </g>

            <!-- ≈òeka (vlevo) -->
            <path class="river"
                  d="M0,60 C80,50 100,90 0,130 L0,210 C120,180 140,240 0,280 L0,380 C90,360 110,400 0,420 L0,500 L0,60 Z"
                  fill="url(#grad-river)" filter="url(#f-shadow)"/>

            <!-- Mosty p≈ôes ≈ôeku -->
            <g class="bridges" aria-hidden="true">
                <rect class="bridge" x="0" y="186" width="120" height="8" fill="#8b7355" stroke="#654321"
                      stroke-width="2"/>
                <rect class="bridge" x="0" y="326" width="120" height="8" fill="#8b7355" stroke="#654321"
                      stroke-width="2"/>
            </g>

            <!-- Parky/lesy -->
            <g class="nature" aria-hidden="true">
                <rect class="forest" x="450" y="40" width="120" height="80" fill="url(#pat-forest)" stroke="#2d5016"
                      stroke-width="2"/>
                <rect class="forest" x="650" y="360" width="100" height="60" fill="url(#pat-forest)" stroke="#2d5016"
                      stroke-width="2"/>
                <rect class="forest" x="50" y="450" width="80" height="45" fill="url(#pat-forest)" stroke="#2d5016"
                      stroke-width="2"/>
            </g>

            <!-- N√°mƒõst√≠ s font√°nou (st≈ôed mapy) -->
            <g class="town-square" aria-hidden="true">
                <rect class="square-base" x="240" y="240" width="120" height="60" fill="#d2b48c" stroke="#8b7355"
                      stroke-width="3" rx="4"/>
                <circle class="fountain-outer" cx="300" cy="270" r="25" fill="#87ceeb" stroke="#4682b4"
                        stroke-width="2"/>
                <circle class="fountain-inner" cx="300" cy="270" r="15" fill="#b0e0e6"/>
                <circle class="fountain-water animated" cx="300" cy="265" r="6" fill="#00bfff"/>
                <circle class="fountain-water animated" cx="295" cy="272" r="4" fill="#00bfff"
                        style="animation-delay:.3s"/>
                <circle class="fountain-water animated" cx="305" cy="272" r="4" fill="#00bfff"
                        style="animation-delay:.6s"/>
            </g>

            <!-- Obyƒçejn√© domy (mimo silnice) -->
            <g class="residential" aria-hidden="true">
                <!-- Lev√° ƒçtvr≈• -->
                <g class="house">
                    <rect class="house-body" x="140" y="80" width="24" height="18"/>
                    <polygon class="house-roof" points="138,80 152,68 166,80"/>
                    <rect class="door" x="148" y="86" width="8" height="12"/>
                </g>
                <g class="house">
                    <rect class="house-body" x="140" y="130" width="20" height="16"/>
                    <polygon class="house-roof" points="138,130 150,120 162,130"/>
                    <rect class="door" x="146" y="134" width="8" height="12"/>
                </g>
                <g class="house">
                    <rect class="house-body" x="80" y="240" width="22" height="20"/>
                    <polygon class="house-roof" points="78,240 91,226 104,240"/>
                    <rect class="door" x="86" y="248" width="8" height="12"/>
                </g>

                <!-- Horn√≠ ƒçtvr≈• -->
                <g class="house">
                    <rect class="house-body" x="250" y="40" width="26" height="20"/>
                    <polygon class="house-roof" points="248,40 263,26 278,40"/>
                    <rect class="door" x="258" y="48" width="8" height="12"/>
                </g>
                <g class="house">
                    <rect class="house-body" x="320" y="50" width="24" height="18"/>
                    <polygon class="house-roof" points="318,50 332,38 346,50"/>
                    <rect class="door" x="328" y="56" width="8" height="12"/>
                </g>

                <!-- Prav√° ƒçtvr≈• -->
                <g class="house">
                    <rect class="house-body" x="640" y="80" width="22" height="18"/>
                    <polygon class="house-roof" points="638,80 651,68 664,80"/>
                    <rect class="door" x="646" y="86" width="8" height="12"/>
                </g>
                <g class="house">
                    <rect class="house-body" x="680" y="140" width="26" height="20"/>
                    <polygon class="house-roof" points="678,140 693,126 708,140"/>
                    <rect class="door" x="688" y="148" width="8" height="12"/>
                </g>
                <g class="house">
                    <rect class="house-body" x="720" y="240" width="24" height="18"/>
                    <polygon class="house-roof" points="718,240 732,228 746,240"/>
                    <rect class="door" x="726" y="246" width="8" height="12"/>
                </g>

                <!-- Spodn√≠ ƒçtvr≈• -->
                <g class="house">
                    <rect class="house-body" x="280" y="450" width="28" height="22"/>
                    <polygon class="house-roof" points="278,450 294,434 310,450"/>
                    <rect class="door" x="288" y="460" width="8" height="12"/>
                </g>
                <g class="house">
                    <rect class="house-body" x="520" y="440" width="24" height="20"/>
                    <polygon class="house-roof" points="518,440 532,426 546,440"/>
                    <rect class="door" x="526" y="448" width="8" height="12"/>
                </g>
            </g>

            <!-- Civic budovy (≈°kola, po≈°ta, policie, kostel) -->
            <!-- ≈†kola (vlevo naho≈ôe) -->
            <g class="building school" aria-hidden="true">
                <rect class="base" x="80" y="140" width="80" height="40" fill="#deb887" stroke="#8b7355"
                      stroke-width="2"/>
                <rect class="roof" x="80" y="128" width="80" height="12" fill="url(#pat-roof)"/>
                <rect class="tower" x="112" y="110" width="16" height="18" fill="#deb887"/>
                <polygon class="tower-roof" points="110,110 120,98 130,110" fill="url(#pat-roof)"/>
                <rect class="door" x="116" y="160" width="12" height="20" fill="#8b4513"/>
                <rect class="window" x="88" y="150" width="10" height="12" fill="#87ceeb"/>
                <rect class="window" x="142" y="150" width="10" height="12" fill="#87ceeb"/>
                <text class="building-label" x="120" y="195" text-anchor="middle" fill="#2f4f2f">≈†KOLA</text>
            </g>

            <!-- Po≈°ta (vpravo naho≈ôe) -->
            <g class="building post-office" aria-hidden="true">
                <rect class="base" x="640" y="200" width="70" height="35" fill="#f0e68c" stroke="#daa520"
                      stroke-width="2"/>
                <rect class="roof" x="640" y="188" width="70" height="12" fill="url(#pat-roof)"/>
                <rect class="door" x="668" y="215" width="14" height="20" fill="#8b4513"/>
                <rect class="slot" x="674" y="208" width="8" height="4" fill="#696969"/>
                <polygon class="emblem" points="675,192 679,196 675,200 671,196" fill="#ff6347"/>
                <text class="building-label" x="675" y="250" text-anchor="middle" fill="#2f4f2f">PO≈†TA</text>
            </g>

            <!-- Policie (vlevo dole) -->
            <g class="building police" aria-hidden="true">
                <rect class="base" x="140" y="360" width="60" height="40" fill="#4682b4" stroke="#2f4f4f"
                      stroke-width="2"/>
                <rect class="roof" x="140" y="348" width="60" height="12" fill="url(#pat-roof)"/>
                <rect class="door" x="162" y="380" width="16" height="20" fill="#8b4513"/>
                <polygon class="badge" points="170,352 176,356 174,364 170,368 166,364 164,356" fill="#ffd700"/>
                <text class="building-label" x="170" y="415" text-anchor="middle" fill="#2f4f2f">POLICIE</text>
            </g>

            <!-- Kostel (vpravo dole) -->
            <g class="building church" aria-hidden="true">
                <rect class="nave" x="650" y="450" width="70" height="45" fill="#deb887" stroke="#8b7355"
                      stroke-width="2"/>
                <rect class="tower" x="675" y="410" width="20" height="45" fill="#deb887"/>
                <polygon class="nave-roof" points="650,450 685,435 720,450" fill="url(#pat-roof)"/>
                <polygon class="tower-roof" points="675,410 685,395 695,410" fill="url(#pat-roof)"/>
                <rect class="door" x="680" y="470" width="14" height="25" fill="#8b4513"/>
                <rect class="window" x="660" y="465" width="8" height="12" fill="#87ceeb"/>
                <rect class="window" x="702" y="465" width="8" height="12" fill="#87ceeb"/>
                <g class="cross" transform="translate(685 390)">
                    <rect x="-1" y="0" width="2" height="12" fill="#ffd700"/>
                    <rect x="-4" y="4" width="8" height="2" fill="#ffd700"/>
                </g>
                <text class="building-label" x="685" y="510" text-anchor="middle" fill="#2f4f2f">KOSTEL</text>
            </g>

            <!-- POIs (ƒçty≈ôi hlavn√≠ odkazy) - um√≠stƒõn√© mimo silnice -->
            <!-- Autor (knihovna - horn√≠ st≈ôed) -->
            <g class="poi big-poi" tabindex="0" role="link" aria-label="Autor" data-href="autor.html" data-cx="54%"
               data-cy="25%">
                <g class="building landmark library">
                    <rect x="440" y="80" width="80" height="60" class="main-body" fill="#8fbc8f" stroke="#556b2f"
                          stroke-width="3"/>
                    <rect x="440" y="65" width="80" height="15" class="main-roof" fill="url(#pat-roof)"/>
                    <rect x="470" y="80" width="20" height="60" class="spine" fill="#2f4f2f"/>
                    <g class="windows">
                        <rect x="448" y="95" width="12" height="16" class="win" fill="#fff8dc"/>
                        <rect x="492" y="95" width="12" height="16" class="win" fill="#fff8dc"/>
                        <rect x="448" y="115" width="12" height="16" class="win" fill="#fff8dc"/>
                        <rect x="492" y="115" width="12" height="16" class="win" fill="#fff8dc"/>
                    </g>
                    <rect x="475" y="120" width="10" height="20" class="door" fill="#8b4513"/>
                </g>
                <text class="poi-label" x="480" y="160" text-anchor="middle">AUTOR</text>
                <title>Autor</title>
            </g>

            <!-- Struƒçn√Ω obsah (radnice - lev√Ω st≈ôed) -->
            <g class="poi big-poi" tabindex="0" role="link" aria-label="Struƒçn√Ω obsah" data-href="strucny.html"
               data-cx="32%" data-cy="55%">
                <g class="building landmark town-hall">
                    <rect x="240" y="350" width="90" height="50" class="main-body" fill="#daa520" stroke="#b8860b"
                          stroke-width="3"/>
                    <rect x="240" y="335" width="90" height="15" class="main-roof" fill="url(#pat-roof)"/>
                    <rect x="275" y="320" width="20" height="30" class="tower" fill="#daa520"/>
                    <polygon class="tower-roof" points="273,320 285,305 297,320" fill="url(#pat-roof)"/>
                    <g class="windows">
                        <rect x="250" y="365" width="12" height="15" class="win" fill="#fff8dc"/>
                        <rect x="268" y="365" width="12" height="15" class="win" fill="#fff8dc"/>
                        <rect x="300" y="365" width="12" height="15" class="win" fill="#fff8dc"/>
                        <rect x="318" y="365" width="12" height="15" class="win" fill="#fff8dc"/>
                    </g>
                    <rect x="280" y="375" width="14" height="25" class="door" fill="#8b4513"/>
                </g>
                <text class="poi-label" x="285" y="415" text-anchor="middle">STRUƒåN√ù</text>
                <title>Struƒçn√Ω obsah</title>
            </g>

            <!-- Vyd√°n√≠ (tisk√°rna - prav√Ω st≈ôed) -->
            <g class="poi big-poi" tabindex="0" role="link" aria-label="Vyd√°n√≠" data-href="vydani.html" data-cx="75%"
               data-cy="45%">
                <g class="building landmark print-house">
                    <rect x="580" y="270" width="85" height="45" class="main-body" fill="#cd853f" stroke="#a0522d"
                          stroke-width="3"/>
                    <rect x="580" y="255" width="85" height="15" class="main-roof" fill="url(#pat-roof)"/>
                    <rect x="590" y="280" width="65" height="8" class="sign-band" fill="#2f4f2f"/>
                    <g class="windows">
                        <rect x="590" y="290" width="12" height="12" class="win" fill="#fff8dc"/>
                        <rect x="608" y="290" width="12" height="12" class="win" fill="#fff8dc"/>
                        <rect x="635" y="290" width="12" height="12" class="win" fill="#fff8dc"/>
                        <rect x="653" y="290" width="12" height="12" class="win" fill="#fff8dc"/>
                    </g>
                    <rect x="615" y="300" width="14" height="15" class="door" fill="#8b4513"/>
                </g>
                <text class="poi-label" x="622" y="330" text-anchor="middle">VYD√ÅN√ç</text>
                <title>Vyd√°n√≠</title>
            </g>

            <!-- N√°zor (debatn√≠ klub - doln√≠ st≈ôed) -->
            <g class="poi big-poi" tabindex="0" role="link" aria-label="N√°zor" data-href="nazor.html" data-cx="58%"
               data-cy="75%">
                <g class="building landmark debate-hall">
                    <rect x="440" y="380" width="80" height="50" class="main-body" fill="#bc8f8f" stroke="#8b7355"
                          stroke-width="3"/>
                    <rect x="440" y="365" width="80" height="15" class="main-roof" fill="url(#pat-roof)"/>
                    <g class="windows">
                        <rect x="450" y="395" width="15" height="15" class="win talk" fill="#fff8dc"/>
                        <rect x="470" y="395" width="15" height="15" class="win talk" fill="#fff8dc"/>
                        <rect x="490" y="395" width="15" height="15" class="win talk" fill="#fff8dc"/>
                    </g>
                    <rect x="475" y="410" width="14" height="20" class="door" fill="#8b4513"/>
                    <!-- ≈òeƒçnick√° tribuna -->
                    <rect x="460" y="350" width="30" height="15" class="podium" fill="#8b7355" stroke="#654321"
                          stroke-width="2"/>
                </g>
                <text class="poi-label" x="480" y="445" text-anchor="middle">N√ÅZOR</text>
                <title>N√°zor</title>
            </g>

            <!-- Kou≈ô z kom√≠n≈Ø -->
            <g class="atmosphere" aria-hidden="true" filter="url(#f-smoke)">
                <circle class="smoke" cx="485" cy="62" r="5" fill="rgba(255,255,255,0.6)" style="animation-delay:0s"/>
                <circle class="smoke" cx="482" cy="55" r="4" fill="rgba(255,255,255,0.5)" style="animation-delay:.5s"/>
                <circle class="smoke" cx="488" cy="50" r="3" fill="rgba(255,255,255,0.4)" style="animation-delay:1s"/>

                <circle class="smoke" cx="685" cy="392" r="4" fill="rgba(255,255,255,0.5)" style="animation-delay:.3s"/>
                <circle class="smoke" cx="682" cy="387" r="3" fill="rgba(255,255,255,0.4)" style="animation-delay:.8s"/>
            </g>
        </svg>
    </div>
</div>

<!-- Loading overlay: ƒçern√© pozad√≠ + n√°hodn√© b√≠l√© teƒçky -->
<div class="loading-overlay" id="loading" aria-hidden="true">
    <div class="stars" id="stars"></div>

    <!-- Pixel loading UI -->
    <div class="loading-container">
        <!-- Pixel ikona mƒõsta -->
        <div class="loading-icon">
            <div class="pixel-building">
                <div class="building-base"></div>
                <div class="building-roof"></div>
                <div class="building-windows">
                    <div class="window"></div>
                    <div class="window"></div>
                    <div class="window"></div>
                    <div class="window"></div>
                </div>
            </div>
        </div>

        <!-- Hlavn√≠ loading text -->
        <div class="loading-label">Naƒç√≠t√°n√≠ Maycombu...</div>

        <!-- Pixel progress bar -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-blocks">
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                    <div class="block"></div>
                </div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
        </div>

        <!-- Pixel loading f√°ze texty -->
        <div class="loading-phases" id="loadingPhases">
            <div class="phase active">¬ª Generov√°n√≠ travnat√Ωch ploch...</div>
            <div class="phase">¬ª Stavƒõn√≠ silnic a most≈Ø...</div>
            <div class="phase">¬ª Zakl√°d√°n√≠ dom≈Ø a budov...</div>
            <div class="phase">¬ª Otev√≠r√°n√≠ knihovny a ≈°koly...</div>
            <div class="phase">¬ª Startov√°n√≠ font√°ny na n√°mƒõst√≠...</div>
        </div>
    </div>
</div>

<!-- Final overlay shown after all sections visited -->
<div class="loading-overlay" id="finalOverlay" aria-hidden="true">
    <div class="stars" id="finalStars"></div>
    <div class="loading-container">
        <div class="loading-icon">
            <div class="pixel-building">
                <div class="building-base"></div>
                <div class="building-roof"></div>
                <div class="building-windows">
                    <div class="window"></div>
                    <div class="window"></div>
                    <div class="window"></div>
                    <div class="window"></div>
                </div>
            </div>
        </div>
        <div class="loading-label">KONEC</div>
        <div class="progress-text">Dƒõkuji za pozornost <3</div>
        <p class="progress-text">-Vojta</p>
        <div style="margin-top:16px; text-align:center;">
            <button class="back-to-map-btn" id="restartBtn">ZAƒå√çT ZNOVU</button>
        </div>
    </div>
</div>

<script>
    (function () {
        const wrap = document.getElementById('mapWrap');
        const inner = document.getElementById('mapInner');
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const overlay = document.getElementById('loading');
        const stars = document.getElementById('stars');
        const finalOverlay = document.getElementById('finalOverlay');
        const finalStars = document.getElementById('finalStars');
        const restartBtn = document.getElementById('restartBtn');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const loadingPhases = document.getElementById('loadingPhases');
        const LOAD_DELAY = 5000; // 5 sekund zobrazen√≠ loadingu
        let busy = false;

        // === HUDBA MP3 NA POZAD√ç ===
        const bgmEl = document.getElementById('bgm');
        let bgmStarted = false;
        let bgmMuted = localStorage.getItem('bgmMuted') === '1';
        const soundToggleBtn = document.getElementById('soundToggleBtn');

        function updateSoundBtn() {
            if (!soundToggleBtn) return;
            soundToggleBtn.textContent = bgmMuted ? 'üîá' : 'üîà';
            soundToggleBtn.setAttribute('aria-label', bgmMuted ? 'Zvuk vypnut√Ω' : 'Zvuk zapnut√Ω');
        }

        function startBgmOnce() {
            if (bgmStarted || !bgmEl) return;
            try {
                bgmEl.volume = 0.35; // v√Ωchoz√≠ hlasitost
                bgmEl.muted = bgmMuted;
                const p = bgmEl.play();
                if (p && typeof p.catch === 'function') p.catch(() => {
                });
                bgmStarted = true;
            } catch (e) {
                // ignore
            }
        }

        updateSoundBtn();
        if (bgmEl) {
            document.addEventListener('click', startBgmOnce, {once: true});
            document.addEventListener('keydown', startBgmOnce, {once: true});
        }

        soundToggleBtn && soundToggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            bgmMuted = !bgmMuted;
            localStorage.setItem('bgmMuted', bgmMuted ? '1' : '0');
            if (bgmEl) {
                bgmEl.muted = bgmMuted;
                if (!bgmMuted && !bgmStarted) startBgmOnce();
            }
            updateSoundBtn();
        });
        // === konec hudby ===

        // Restart button clears progress
        restartBtn && restartBtn.addEventListener('click', () => {
            ['visited_autor', 'visited_strucny', 'visited_vydani', 'visited_nazor'].forEach(k => localStorage.removeItem(k));
            finalOverlay?.classList.remove('show');
        });

        function buildStars() {
            stars.innerHTML = '';
            const w = window.innerWidth, h = window.innerHeight;
            const area = w * h;
            const count = Math.min(240, Math.max(40, Math.round(area / 12000)));
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                const x = Math.random() * w, y = Math.random() * h;
                const delay = Math.round(Math.random() * 900) + 'ms';
                s.style.left = x + 'px';
                s.style.top = y + 'px';
                s.style.animationDelay = delay;
                stars.appendChild(s);
            }
        }

        function animateLoading() {
            const phases = loadingPhases.querySelectorAll('.phase');
            let currentPhase = 0;
            let progress = 0;

            const interval = setInterval(() => {
                progress += 2;

                // Update progress bar
                progressFill.style.width = Math.min(progress, 100) + '%';
                progressText.textContent = Math.min(progress, 100) + '%';

                // Update phases
                const phaseProgress = Math.floor(progress / 20);
                if (phaseProgress > currentPhase && phaseProgress < phases.length) {
                    phases[currentPhase].classList.remove('active');
                    phases[phaseProgress].classList.add('active');
                    currentPhase = phaseProgress;
                }

                if (progress >= 100) {
                    clearInterval(interval);
                    // Add completion phase
                    phases[currentPhase].classList.remove('active');
                    const completionPhase = document.createElement('div');
                    completionPhase.className = 'phase active completion';
                    completionPhase.textContent = '¬ª Maycomb je p≈ôipraven!';
                    loadingPhases.appendChild(completionPhase);
                }
            }, LOAD_DELAY / 50); // 50 updates over the duration
        }

        // Track visited sections and show final overlay when all done
        function markVisited(href) {
            const map = {
                'autor.html': 'visited_autor',
                'strucny.html': 'visited_strucny',
                'vydani.html': 'visited_vydani',
                'nazor.html': 'visited_nazor'
            };
            const key = map[href];
            if (key) localStorage.setItem(key, '1');
        }

        function allVisited() {
            return ['visited_autor', 'visited_strucny', 'visited_vydani', 'visited_nazor']
                .every(k => localStorage.getItem(k) === '1');
        }

        function buildStarsFinal() {
            if (!finalStars) return;
            finalStars.innerHTML = '';
            const w = window.innerWidth, h = window.innerHeight;
            const area = w * h;
            const count = Math.min(240, Math.max(40, Math.round(area / 12000)));
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                const x = Math.random() * w, y = Math.random() * h;
                const delay = Math.round(Math.random() * 900) + 'ms';
                s.style.left = x + 'px';
                s.style.top = y + 'px';
                s.style.animationDelay = delay;
                finalStars.appendChild(s);
            }
        }

        function showFinalOverlay() {
            buildStarsFinal();
            finalOverlay?.classList.add('show');
        }

        function onZoomEndOnce(cb) {
            const handler = (e) => {
                if (e.propertyName === 'transform') {
                    inner.removeEventListener('transitionend', handler);
                    cb();
                }
            };
            inner.addEventListener('transitionend', handler);
            setTimeout(() => {
                inner.removeEventListener('transitionend', handler);
                cb();
            }, 700);
        }

        function goTo(el) {
            if (busy) return;
            busy = true;
            const cx = el.getAttribute('data-cx') || '50%';
            const cy = el.getAttribute('data-cy') || '50%';
            const href = el.getAttribute('data-href');
            if (!href) {
                busy = false;
                return;
            }
            // mark as visited when user clicks
            markVisited(href);
            wrap.style.setProperty('--cx', cx);
            wrap.style.setProperty('--cy', cy);
            if (prefersReduced) {
                window.location.href = href;
                return;
            }
            wrap.classList.add('zoom');
            onZoomEndOnce(() => {
                buildStars();
                overlay.classList.add('show');
                animateLoading(); // Start loading animation
                setTimeout(() => {
                    window.location.href = href;
                }, LOAD_DELAY);
            });
        }

        function resetView() {
            overlay?.classList.remove('show');
            wrap?.classList.remove('zoom');
            stars && (stars.innerHTML = '');
            // Reset loading UI
            if (progressFill) {
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
                const phases = loadingPhases?.querySelectorAll('.phase');
                if (phases) {
                    phases.forEach((phase, index) => {
                        phase.classList.toggle('active', index === 0);
                    });
                    // Remove completion phase if exists
                    const completion = loadingPhases?.querySelector('.completion');
                    if (completion) completion.remove();
                }
            }
            busy = false;
            // If all sections were visited, show final overlay
            if (allVisited()) {
                showFinalOverlay();
            }
        }

        window.addEventListener('pageshow', resetView);
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') resetView();
        });

        document.addEventListener('click', (e) => {
            const el = e.target.closest('.poi');
            if (el) {
                e.preventDefault();
                goTo(el);
            }
        });

        document.addEventListener('keydown', (e) => {
            if ((e.key === 'Enter' || e.key === ' ') && e.target.closest('.poi')) {
                e.preventDefault();
                goTo(e.target.closest('.poi'));
            }
        });

        window.addEventListener('resize', () => {
            if (overlay.classList.contains('show')) buildStars();
            if (finalOverlay && finalOverlay.classList.contains('show')) buildStarsFinal();
        });
    })();
</script>
</body>
</html>
