<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Procviƒçuj si angliƒçtinu z√°bavnƒõ s Knowixem ‚Äì chaty, p√≠sniƒçky, p≈ôeklady a hry.">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Roleplaying| Knowix</title>
    <link rel="stylesheet" href="/static/style.css">
        <link rel="stylesheet" href="/static/mobile_header.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet"
          media="print" onload="this.media='all'">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W1EN990JKP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-W1EN990JKP');
</script>
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet">
    </noscript>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        .dual-lang-bubble {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .lang-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .lang-label {
            font-weight: bold;
            color: #666;
            min-width: 30px;
            font-size: 0.9em;
        }

        .lang-text {
            flex: 1;
        }

        .en-text {
            color: #2c3e50;
            font-weight: 500;
        }

        .cz-text {
            color: #7f8c8d;
            font-style: italic;
        }

        .dark-mode .lang-label {
            color: #bdc3c7;
        }

        .dark-mode .en-text {
            color: #ecf0f1;
        }

        .dark-mode .cz-text {
            color: #95a5a6;
        }
    </style>
</head>
<body class="{{ 'dark-mode' if session.get('theme') == 'dark' else '' }}">
<header>
    <div class="logo-streak-wrapper">
        <div class="logo">
            <a href="{{ url_for('main.index') }}">
                <img src="{{ url_for('static', filename='pic/logo.webp') }}" alt="Knowix Logo">
            </a>
        </div>
        <span class="streak-badge">
            <img src="/static/fire.svg" alt="Streak">
            {{ user_streak }}
        </span>
    </div>
    <div class="nav-profile-wrapper">
        <ul class="nav-right">
            <li>
                <a href="/anglictina" title="Angliƒçtina">
                    <img src="{{ url_for('static', filename='icons/eng.png') }}" alt="Angliƒçtina" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/feedback" title="Feedback">
                    <img src="{{ url_for('static', filename='icons/chat.png') }}" alt="Feedback" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/news" title="Novinky">
                    <img src="{{ url_for('static', filename='icons/bell.png') }}" alt="Novinky" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/obchod" title="Obchod">
                    <img src="{{ url_for('static', filename='icons/shop.png') }}" alt="Obchod" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/zpravy" title="Zpr√°vy">
                    <img src="{{ url_for('static', filename='icons/mail.png') }}" alt="Zpr√°vy" class="nav-icon">
                </a>
            </li>
            <li>
                <button id="theme-toggle" title="P≈ôepnout t√©ma" style="background:none;border:none;cursor:pointer;padding:0;">
                    üåô
                </button>
            </li>
        </ul>
        {% if session['user_name'] %}
        <div class="user-profile">
            <div class="profile-container">
                {% if session.get('profile_pic') %}
                <img src="{{ url_for('static', filename='profile_pics/' + session['profile_pic']) }}"
                     alt="Profilov√° fotka" width="64" class="profile-pic"
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='pic/default.webp') }}';">
                {% else %}
                <img src="{{ url_for('static', filename='pic/default.webp') }}" alt="Defaultn√≠ profilovka"
                     class="profile-pic" id="profileMenuTrigger">
                {% endif %}
                <div class="profile-menu" id="profileMenu">
                    <a href="{{ url_for('auth.settings') }}">‚öôÔ∏è Nastaven√≠</a>
                    <a href="{{ url_for('auth.logout') }}">üö™ Odhl√°sit se</a>
                </div>
                <span class="greeting" style="margin-left: 10px;">Ahoj {{ session['user_name'].split()[0] }}!</span>
            </div>
            {% if user_xp is defined and user_level is defined and user_level_name is defined and user_progress_percent is defined %}
            <div class="xp-header-bar">
                <div class="xp-header-bar-labels">
                    <span class="xp-level-badge">Level {{ user_level }} ‚Äì {{ user_level_name }}</span>
                    <span class="xp-value">{{ user_xp_in_level }}/50 XP</span>
                </div>
                <div class="xp-header-bar-progress-bg">
                    <div class="xp-header-bar-progress" style="width: {{ user_progress_percent }}%"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
<div class="auth-links">
    <a href="{{ url_for('auth.login') }}" class="auth-btn login-btn">üîë P≈ôihl√°sit se</a>
    <a href="{{ url_for('auth.register') }}" class="auth-btn register-btn">üìù Registrovat se</a>
</div>
        {% endif %}
    </div>
</header>

<div class="game-container">
    <h1>Roleplaying konverzace</h1>
    <div id="topicTitle" style="font-size:1.1em; color:#888; margin-bottom:10px;">
        T√©ma: {{ topic|capitalize }}
    </div>
    <div class="conversation-history" id="conversationHistory">
        <!-- Chatov√© bubliny se budou p≈ôid√°vat sem JS -->
    </div>
    <div id="inputArea">
        {% if speaker.lower() == 'u≈æivatel' %}
            <div style="margin-bottom:10px; color:#888;">Co ≈ô√≠ct: <b>{{ cz }}</b></div>
            <input type="text"
                   class="translation-input"
                   id="prekladInput"
                   placeholder="≈òeknƒõte nebo napi≈°te p≈ôeklad...">
            <button class="mic-btn" id="micButton">
                <span>üé§</span>
            </button>
            <button class="submit-btn" id="submitBtn">
                Odeslat
            </button>
        {% else %}
            <div style="margin-bottom:10px; color:#888;">Poslouchej a pokraƒçuj</div>
            <button class="next-btn" id="nextBtn" style="display:block;">
                Pokraƒçovat &rarr;
            </button>
        {% endif %}
    </div>
    <div class="result" id="resultContainer"></div>
</div>
<!-- XP/STREAK TOAST -->
<div id="streakToast" class="streak-toast" style="display:none;">
    <img src="/static/fire.svg" alt="Streak" class="streak-fire" style="width:32px;vertical-align:middle;">
    <span id="streakToastText"></span>
</div>
<footer>
    <p>&copy; 2025 Knowix. V≈°echna pr√°va vyhrazena.</p>
    <p class="footer-signature">
        Made with ‚ù§Ô∏è by
        <a href="https://ko-fi.com/voku199" target="_blank" style="color: inherit; text-decoration: underline;">Voku</a>
        and lot of ‚òï
    </p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- SpeechRecognition ---
    let recognition;
    let isListening = false;
    let noSpeechTimeout = null;
    // Nov√© stavov√© p≈ô√≠znaky pro opr√°vnƒõn√≠ mikrofonu
    let micPermissionGranted = false;

    function lockScroll() {
        document.body.style.overflow = 'hidden';
    }
    function unlockScroll() {
        document.body.style.overflow = '';
    }

    // Pomocn√©: bezpeƒçn√Ω kontext (HTTPS nebo localhost)
    function isSecureContextOrLocalhost() {
        try {
            return window.isSecureContext || location.protocol === 'https:' || /(localhost|127\.0\.0\.1)/.test(location.hostname);
        } catch (_) { return false; }
    }

    // Zobrazen√≠ n√°povƒõdy k povolen√≠ mikrofonu
    function showPermissionHelp(message) {
        const text = message || 'Pro pokraƒçov√°n√≠ povol mikrofon v prohl√≠≈æeƒçi (ikona kamery/mikrofonu v adresn√≠m ≈ô√°dku).';
        let warn = document.getElementById('micPermissionHelp');
        if (!warn) {
            warn = document.createElement('div');
            warn.id = 'micPermissionHelp';
            warn.style.position = 'fixed';
            warn.style.bottom = '40px';
            warn.style.left = '50%';
            warn.style.transform = 'translateX(-50%)';
            warn.style.background = '#fffbe6';
            warn.style.border = '2px solid #ff9800';
            warn.style.borderRadius = '12px';
            warn.style.padding = '14px 28px';
            warn.style.fontSize = '1.05em';
            warn.style.boxShadow = '0 4px 16px rgba(0,0,0,0.12)';
            warn.style.zIndex = 9999;
            warn.style.color = '#b26a00';
            warn.style.maxWidth = '90%';
            warn.style.textAlign = 'center';
            document.body.appendChild(warn);
        }
        warn.innerHTML = text + '<br><small>Tip: Pokud vid√≠≈° hl√°≈°ku o nezabezpeƒçen√©m p≈ôipojen√≠, otev≈ôi str√°nku p≈ôes HTTPS.</small>';
        setTimeout(() => {
            warn.style.opacity = '0';
            setTimeout(() => { if (warn) warn.remove(); }, 800);
        }, 5000);
    }

    // Vy≈æ√°d√°n√≠ opr√°vnƒõn√≠ mikrofonu (vyvol√° syst√©movou bublinu)
    async function ensureMicPermission() {
        if (!isSecureContextOrLocalhost()) {
            showPermissionHelp('Prohl√≠≈æeƒç vy≈æaduje HTTPS pro p≈ô√≠stup k mikrofonu. Otev≈ôi tuto str√°nku p≈ôes https:// nebo pou≈æij localhost.');
            throw new Error('insecure-context');
        }
        // Permissions API (kdy≈æ je k dispozici)
        try {
            if (navigator.permissions && navigator.permissions.query) {
                const status = await navigator.permissions.query({ name: 'microphone' });
                if (status.state === 'granted') {
                    micPermissionGranted = true;
                    return true;
                }
                // status: 'prompt' nebo 'denied' -> spust√≠me getUserMedia pro vyvol√°n√≠ bubliny
            }
        } catch (_) { /* ignorujeme, pokraƒçujeme n√≠≈æe */ }

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showPermissionHelp('Tento prohl√≠≈æeƒç nepodporuje p≈ô√≠stup k mikrofonu. Zkus Chrome/Edge na desktopu.');
            throw new Error('no-getUserMedia');
        }

        try {
            // Vy≈æ√°d√°me pouze audio; stopneme hned po udƒõlen√≠
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream.getTracks().forEach(t => t.stop());
            micPermissionGranted = true;
            return true;
        } catch (err) {
            const name = err && (err.name || err.code) || '';
            if (name === 'NotAllowedError' || name === 'PermissionDeniedError') {
                showPermissionHelp('Povol pros√≠m mikrofon v horn√≠m panelu prohl√≠≈æeƒçe a zkus to znovu.');
            } else if (name === 'NotFoundError' || name === 'DevicesNotFoundError') {
                showPermissionHelp('Nenalezen ≈æ√°dn√Ω mikrofon. Zkontroluj p≈ôipojen√≠ za≈ô√≠zen√≠.');
            } else if (name === 'NotReadableError') {
                showPermissionHelp('Mikrofon je pou≈æ√≠v√°n jinou aplikac√≠. Zav≈ôi ji a zkus to znovu.');
            } else {
                showPermissionHelp('Nepoda≈ôilo se z√≠skat p≈ô√≠stup k mikrofonu. Zkus to pros√≠m znovu.');
            }
            throw err;
        }
    }

    // --- Vylep≈°en√° spojovaƒçka slov ---
    function showMatchingExercise(pairs) {
        inputArea.innerHTML = `
            <div style="font-size:1.2em;margin-bottom:10px;">Spoj anglick√° slova/vƒõty s ƒçesk√Ωmi:</div>
            <div id="matchingExercise" style="display:flex;gap:40px;justify-content:center;">
                <div id="enCol"></div>
                <div id="czCol"></div>
            </div>
            <button class="submit-btn" id="checkMatchingBtn" style="margin-top:20px;">Zkontrolovat</button>
            <div id="matchingResult" style="margin-top:15px;font-size:1.1em;"></div>
        `;

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        const enArr = pairs.map(p => p.en);
        const czArr = pairs.map(p => p.cz);
        shuffle(enArr);
        shuffle(czArr);

        const enCol = document.getElementById('enCol');
        const czCol = document.getElementById('czCol');

        enArr.forEach((en) => {
            const div = document.createElement('div');
            div.className = 'matching-item';
            div.textContent = en;
            div.draggable = true;
            div.dataset.en = en;
            div.style.padding = '10px 18px';
            div.style.margin = '8px 0';
            div.style.background = '#e3eafc';
            div.style.borderRadius = '8px';
            div.style.cursor = 'grab';
            div.style.border = '1px solid #b3c6e7';
            enCol.appendChild(div);
        });

        czArr.forEach((cz) => {
            const drop = document.createElement('div');
            drop.className = 'matching-drop';
            drop.textContent = cz;
            drop.dataset.cz = cz;
            drop.style.padding = '10px 18px';
            drop.style.margin = '8px 0';
            drop.style.background = '#f8f9fa';
            drop.style.borderRadius = '8px';
            drop.style.minHeight = '40px';
            drop.style.border = '2px dashed #b3c6e7';
            drop.style.position = 'relative';
            drop.style.transition = 'background 0.2s';
            czCol.appendChild(drop);
        });

        // Drag & drop logic
        let dragged = null;
        enCol.querySelectorAll('.matching-item').forEach(item => {
            item.addEventListener('dragstart', function () {
                dragged = item;
                setTimeout(() => item.style.opacity = '0.5', 0);
            });
            item.addEventListener('dragend', function () {
                item.style.opacity = '1';
            });
        });
        czCol.querySelectorAll('.matching-drop').forEach(drop => {
            drop.addEventListener('dragover', function (e) {
                e.preventDefault();
                drop.style.background = '#d4edda';
            });
            drop.addEventListener('dragleave', function () {
                drop.style.background = '#f8f9fa';
            });
            drop.addEventListener('drop', function (e) {
                e.preventDefault();
                drop.style.background = '#f8f9fa';
                if (dragged) {
                    // Remove previous if exists
                    if (drop.querySelector('.matching-item')) {
                        enCol.appendChild(drop.querySelector('.matching-item'));
                    }
                    drop.appendChild(dragged);
                    dragged.style.margin = '0';
                    dragged = null;
                }
            });
        });

        // Kontrola v√Ωsledku
        document.getElementById('checkMatchingBtn').onclick = function () {
            let correct = 0;
            let userMatches = [];
            czCol.querySelectorAll('.matching-drop').forEach(drop => {
                const cz = drop.dataset.cz;
                const item = drop.querySelector('.matching-item');
                if (item) {
                    const en = item.dataset.en;
                    const pair = pairs.find(p => p.en === en && p.cz === cz);
                    userMatches.push({en, cz, correct: !!pair});
                    if (pair) correct++;
                }
            });
            const resultDiv = document.getElementById('matchingResult');
            if (correct === pairs.length) {
                resultDiv.innerHTML = `<span style="color:#27ae60;">üéâ V≈°e spr√°vnƒõ! V√Ωbornƒõ!</span>`;
                setTimeout(() => showCongratsPopout(pairs, userMatches), 1200);
            } else {
                resultDiv.innerHTML = `<span style="color:#e74c3c;">Nƒõkter√© dvojice nesed√≠, zkus to znovu.</span>`;
            }
        };
    }

    // --- Vylep≈°en√Ω popout po spojovaƒçce ---
   // --- Vylep≈°en√Ω popout po spojovaƒçce ---
    function showCongratsPopout(matchingPairs, userMatches) {
        lockScroll();
        let answersHtml = '';
        if (userMatches && userMatches.length) {
            answersHtml = `
                <div class="matching-summary">
                    <h3 style="margin-bottom:10px;">Tvoje spojen√≠:</h3>
                    <table class="matching-table" style="margin:auto;">
                        <thead>
                            <tr>
                                <th>Anglicky</th>
                                <th>ƒåesky</th>
                                <th>Spr√°vnƒõ?</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${userMatches.map(pair => `
                                <tr>
                                    <td>${pair.en}</td>
                                    <td>${pair.cz}</td>
                                    <td>${pair.correct ? '‚úîÔ∏è' : '‚ùå'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        const pop = document.createElement('div');
        pop.id = 'congratsPopout';
        pop.className = 'popup-container';
        pop.innerHTML = `
            <div class="popup-content" style="max-width:420px;text-align:center;">
                <div style="font-size:2.2em;margin-bottom:10px;">üéâ Skvƒõl√° pr√°ce!</div>
                <div style="font-size:1.15em;margin-bottom:18px;">Dokonƒçil(a) jsi konverzaci i spojovaƒçku.</div>
                <div style="margin-bottom:18px;">
                    <button id="showAnswersBtn" class="submit-btn" style="margin:0 8px 0 0;">Zobrazit odpovƒõdi</button>
                    <button id="nextLessonBtn" class="next-btn" style="margin:0 0 0 8px;">Dal≈°√≠ lekce &rarr;</button>
                    <button id="continueBtn" class="submit-btn" style="margin:0 0 0 8px;">Pokraƒçovat</button>
                </div>
                <div id="matchingAnswersDetail" style="display:none;">${answersHtml}
                    <div style="margin-top:18px;">
                        <button id="continueBtn2" class="submit-btn">Pokraƒçovat</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(pop);

        document.getElementById('showAnswersBtn').onclick = function () {
            document.getElementById('matchingAnswersDetail').style.display = 'block';
            this.style.display = 'none';
        };
        document.getElementById('continueBtn').onclick = goToRoleplaying;
        document.getElementById('continueBtn2').onclick = goToRoleplaying;
        document.getElementById('nextLessonBtn').onclick = goToRoleplaying;

        function goToRoleplaying() {
            unlockScroll();
            window.location.href = '/roleplaying';
        }
    }

    // --- SpeechRecognition a dal≈°√≠ p≈Øvodn√≠ logika z≈Øst√°v√° beze zmƒõny ---

    function initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.onstart = function () {
                isListening = true;
                if (micButton) micButton.classList.add('listening');
                if (prekladInput) prekladInput.placeholder = "Poslouch√°m...";
                noSpeechTimeout = setTimeout(() => {
                    stopListening();
                    showNoSpeechWarning();
                }, 6000);
            };
            recognition.onresult = function (event) {
                clearTimeout(noSpeechTimeout);
                const transcript = event.results[0][0].transcript;
                if (prekladInput) prekladInput.value = transcript;
                stopListening();
            };
            recognition.onerror = function (event) {
                clearTimeout(noSpeechTimeout);
                // Specifick√© chybov√© stavy ‚Äì uka≈æ n√°povƒõdu a neblokuj u≈æivatele
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    showPermissionHelp('P≈ô√≠stup k mikrofonu byl zam√≠tnut. Povol jej v nastaven√≠ webu a zkus to znovu.');
                } else if (event.error === 'no-speech') {
                    showNoSpeechWarning();
                } else if (event.error === 'aborted') {
                    // u≈æivatel zav≈ôel bublinu; nezahlcuj hl√°≈°kou
                } else {
                    showResult('Chyba: ' + event.error, false);
                }
                stopListening();
            };
            recognition.onend = function () {
                clearTimeout(noSpeechTimeout);
                stopListening();
            };
        } else {
            if (micButton) micButton.disabled = true;
            if (micButton) micButton.title = "V√°≈° prohl√≠≈æeƒç nepodporuje rozpozn√°v√°n√≠ ≈ôeƒçi";
            if (prekladInput) prekladInput.placeholder = "Napi≈°te p≈ôeklad...";
        }
    }

    async function startListeningWithPermission() {
        try {
            if (!micPermissionGranted) {
                await ensureMicPermission();
            }
            if (recognition) recognition.start();
        } catch (_) {
            // Povolen√≠ se nezda≈ôilo ‚Äì ponech√°me psan√≠ jako fallback
            if (prekladInput) prekladInput.placeholder = 'Povolen√≠ mikrofonu selhalo ‚Äì napi≈° p≈ôeklad...';
        }
    }

    function startListening() {
        if (recognition) recognition.start();
    }

    function stopListening() {
        if (recognition && isListening) {
            try { recognition.stop(); } catch (_) {}
            isListening = false;
            if (micButton) micButton.classList.remove('listening');
            if (prekladInput) prekladInput.placeholder = "Zkuste to anglicky...";
        }
        clearTimeout(noSpeechTimeout);
    }

    // ... showTypeWarning, showNoSpeechWarning, showStreakToast z≈Øst√°vaj√≠ stejn√© ...

    const conversationHistory = document.getElementById('conversationHistory');
    const inputArea = document.getElementById('inputArea');
    const resultContainer = document.getElementById('resultContainer');
    let prekladInput, micButton, submitBtn, nextBtn;

    function playAlexAudio(enText, topic, index) {
        if (!topic) topic = window.ROLEPLAYING_TOPIC || "";
        if (typeof index !== "number") index = window.currentAlexIndex || 0;
        topic = topic.replace(/\.json$/i, '');
        const audioUrl = `/static/speaking/roleplaying/mp3/${topic}_${index}.mp3`;
        let audio = new Audio(audioUrl);
        let played = false;

        audio.addEventListener('canplaythrough', function () {
            audio.play().then(() => {
                played = true;
            }).catch(() => {
                if (!played && enText && 'speechSynthesis' in window) {
                    const utter = new SpeechSynthesisUtterance(enText);
                    utter.lang = 'en-US';
                    window.speechSynthesis.speak(utter);
                }
            });
        });

        audio.addEventListener('error', function () {
            if (!played && enText && 'speechSynthesis' in window) {
                const utter = new SpeechSynthesisUtterance(enText);
                utter.lang = 'en-US';
                window.speechSynthesis.speak(utter);
            }
        });

        audio.load();
        window.currentAlexIndex = index + 2;
    }

  // --- P≈ôid√°n√≠ do historie: Alex ukazuje obƒõ vƒõty ---
    function addToHistory(speaker, cz, en = null, userInput = null, correct = null, isAlex = false, topic = null, index = null, showBothLangs = false) {
        // Ovƒõ≈ôen√≠, ≈æe speaker nen√≠ undefined
        if (!speaker) {
            console.error('addToHistory: speaker is undefined or null');
            return;
        }

        const row = document.createElement('div');
        row.className = 'chat-row ' + (speaker.toLowerCase() === 'u≈æivatel' ? 'user' : 'ai');
        const avatar = document.createElement('img');
        avatar.className = 'chat-avatar';
        avatar.src = speaker.toLowerCase() === 'u≈æivatel'
            ? '/static/profile_pics/{{ session.get("profile_pic", "default.webp") }}'
            : '/static/pic/danndas.png';
        avatar.alt = speaker;
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble ' + (speaker.toLowerCase() === 'u≈æivatel' ? 'bubble-user' : 'bubble-ai');

        let text;
        if (speaker.toLowerCase() === 'alex' && showBothLangs && en) {
            // Vylep≈°en√Ω form√°t pro zobrazen√≠ obou jazyk≈Ø
            text = `
                <div class="dual-lang-bubble">
                    <div class="lang-row">
                        <span class="lang-label">EN:</span>
                        <span class="lang-text en-text">${en}</span>
                    </div>
                    <div class="lang-row">
                        <span class="lang-label">CZ:</span>
                        <span class="lang-text cz-text">${cz}</span>
                    </div>
                </div>
            `;
        } else if (speaker.toLowerCase() === 'alex') {
            text = en || cz;
        } else {
            text = cz;
        }

        bubble.innerHTML = `<span class="speaker-label">${speaker === 'U≈æivatel' ? 'Vy' : speaker}:</span> ${text}`;

        if (userInput !== null) {
            bubble.innerHTML += `<span class="answer-feedback">Va≈°e odpovƒõƒè: <b>${userInput}</b></span>`;
            if (correct !== null) {
                bubble.innerHTML += correct
                    ? `<span class="answer-feedback correct">‚úîÔ∏è Spr√°vnƒõ!</span>`
                    : `<span class="answer-feedback incorrect">‚ùå Nespr√°vnƒõ.<br>Spr√°vnƒõ: <b>${en}</b></span>`;
            }
        }

        if (speaker.toLowerCase() === 'u≈æivatel') {
            row.appendChild(bubble);
            row.appendChild(avatar);
        } else {
            row.appendChild(avatar);
            row.appendChild(bubble);
        }

        conversationHistory.appendChild(row);
        conversationHistory.scrollTop = conversationHistory.scrollHeight;

        if (isAlex && en) {
            playAlexAudio(en, topic, index);
        }
    }
    function handleUserSubmit() {
        const translation = prekladInput.value.trim();
        if (!translation) {
            showResult("Zadejte nebo ≈ôeknƒõte p≈ôeklad", false);
            return;
        }
        submitBtn.disabled = true;

        // Z√≠sk√°n√≠ CSRF tokenu
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
        
        if (!csrfToken) {
            console.error('CSRF token not found in meta tag');
            showResult('Chyba: CSRF token nenalezen. Obnovte str√°nku.', false);
            submitBtn.disabled = false;
            return;
        }

        fetch(window.ROLEPLAYING_NEXT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({preklad: translation})
        })
            .then(response => {
                // Nejprve zkontrolujeme, jestli je response OK
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Kontrola, ≈æe m√°me spr√°vn√° data
                if (data.error) {
                    throw new Error(data.error);
                }

                addToHistory('U≈æivatel', document.getElementById('czText').textContent, data.correct_answer, translation, data.correct, false);
                if (data.correct) {
                    showResult("Spr√°vnƒõ! ‚úÖ", true);
                    if (data.xp_awarded && data.xp_awarded > 0) showStreakToast(`+${data.xp_awarded} XP!`);
                    if (data.streak_info && data.streak_info.streak) showStreakToast(`üî• Streak: ${data.streak_info.streak} dn√≠!`);
                } else {
                    showResult(`Nespr√°vnƒõ. Spr√°vn√° odpovƒõƒè: "${data.correct_answer}"`, false);
                }
                setTimeout(() => {
                    showNextTurn(data);
                }, 1200);
            })
            .catch(error => {
                console.error('Error:', error);
                showResult('Chyba p≈ôi odes√≠l√°n√≠ odpovƒõdi. Zkuste to znovu.', false);
                submitBtn.disabled = false;
            });
    }

    function showNextTurn(data) {
        resultContainer.textContent = '';
        inputArea.innerHTML = '';

        // Kontrola chyb v datech
        if (data.error) {
            showResult(`Chyba: ${data.error}`, false);
            return;
        }

        if (data.end) {
            if (data.matching_pairs && Array.isArray(data.matching_pairs) && data.matching_pairs.length > 0) {
                showMatchingExercise(data.matching_pairs);
            } else {
                inputArea.innerHTML = `<div style="font-size:1.3em;margin:30px 0;">üéâ Konverzace dokonƒçena!</div>`;
            }
            return;
        }

        // Ovƒõ≈ôen√≠, ≈æe m√°me pot≈ôebn√° data
        if (!data.speaker) {
            console.error('showNextTurn: data.speaker is missing', data);
            showResult('Chyba: Chyb√≠ informace o mluvƒç√≠m. Zkuste obnovit str√°nku.', false);
            return;
        }

        if (data.speaker && data.speaker.toLowerCase() === 'u≈æivatel') {
            inputArea.innerHTML = `
                <div style="margin-bottom:10px; color:#888;">Co ≈ô√≠ct: <b id="czText">${data.cz || ''}</b></div>
                <input type="text" class="translation-input" id="prekladInput" placeholder="Zkuste to anglicky...">
                <button class="mic-btn" id="micButton"><span>üé§</span></button>
                <button class="submit-btn" id="submitBtn">Odeslat</button>
            `;
            prekladInput = document.getElementById('prekladInput');
            micButton = document.getElementById('micButton');
            submitBtn = document.getElementById('submitBtn');
            if (micButton) {
                micButton.addEventListener('click', async function () {
                    if (isListening) {
                        stopListening();
                    } else {
                        await startListeningWithPermission();
                    }
                });
            }
            if (submitBtn) submitBtn.addEventListener('click', handleUserSubmit);
            prekladInput.addEventListener('input', function () {
                if (prekladInput.value.length > 0) showTypeWarning();
            });
        } else {
            // Alex ≈ô√≠k√° anglicky
            let en = data.en;
            if (Array.isArray(en)) en = en[0];
            // P≈ôid√°me zpr√°vu do historie pouze pokud nen√≠ ji≈æ p≈ôid√°na
            if (!data.already_in_history) {
                let idx = window.currentAlexIndex || 0;
                addToHistory(data.speaker, data.cz || '', en, null, null, true, window.ROLEPLAYING_TOPIC, idx);
                window.currentAlexIndex = (window.currentAlexIndex || 0) + 1;
            }
            inputArea.innerHTML = `
                <div style="margin-bottom:10px; color:#888;">Poslouchej a pokraƒçuj</div>
                <button class="next-btn" id="nextBtn" style="display:block;">Pokraƒçovat &rarr;</button>
            `;
            nextBtn = document.getElementById('nextBtn');
            if (nextBtn) nextBtn.addEventListener('click', function () {
                // Z√≠sk√°n√≠ CSRF tokenu
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
                
                if (!csrfToken) {
                    console.error('CSRF token not found in meta tag');
                    showResult('Chyba: CSRF token nenalezen. Obnovte str√°nku.', false);
                    return;
                }

                fetch(window.ROLEPLAYING_NEXT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({})
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                            });
                        }
                        return response.json();
                    })
                    .then(showNextTurn)
                    .catch(error => {
                        console.error('Error:', error);
                        showResult('Chyba p≈ôi naƒç√≠t√°n√≠ dal≈°√≠ zpr√°vy. Zkuste obnovit str√°nku.', false);
                    });
            });
        }
    }

    function showResult(message, isCorrect) {
        resultContainer.textContent = message;
        resultContainer.className = 'result ' + (isCorrect ? 'correct' : 'incorrect');
    }

    window.ROLEPLAYING_NEXT_URL = window.ROLEPLAYING_NEXT_URL || '{{ url_for("roleplaying.roleplaying_next") }}';


    const firstSpeaker = '{{ speaker }}';
    const firstCz = `{{ cz }}`;
    const firstEnRaw = '{{ en|default("") }}';
    const topic = '{{ topic|e }}';
    window.ROLEPLAYING_TOPIC = topic;
    window.currentAlexIndex = 0;

    if (firstSpeaker && firstCz) {
        let en = firstEnRaw;
        if (en && en.startsWith('[')) {
            try { en = JSON.parse(en)[0]; } catch { en = ""; }
        }

        // Pro prvn√≠ Alexovu zpr√°vu v≈ædy zobraz√≠me obƒõ jazykov√© verze
        const isFirstAlex = firstSpeaker.toLowerCase() === 'alex';
        addToHistory(
            firstSpeaker,
            firstCz,
            en,
            null,
            null,
            isFirstAlex,
            topic,
            0,  // index prv√©ho audio souboru
            true // v≈ædy zobrazit obƒõ jazykov√© verze pro prvn√≠ zpr√°vu
        );

        // Audio se u≈æ p≈ôehraje v addToHistory() funkci, tak≈æe zde to nemus√≠me volat znovu
    }

    if (firstSpeaker.toLowerCase() === 'u≈æivatel') {
        inputArea.innerHTML = `
            <div style="margin-bottom:10px; color:#888;">Co ≈ô√≠ct: <b id="czText">${firstCz}</b></div>
            <input type="text" class="translation-input" id="prekladInput" placeholder="Zkuste to anglicky...">
            <button class="mic-btn" id="micButton"><span>üé§</span></button>
            <button class="submit-btn" id="submitBtn">Odeslat</button>
        `;
        prekladInput = document.getElementById('prekladInput');
        micButton = document.getElementById('micButton');
        submitBtn = document.getElementById('submitBtn');
        if (micButton) {
            micButton.addEventListener('click', async function () {
                if (isListening) {
                    stopListening();
                } else {
                    await startListeningWithPermission();
                }
            });
        }
        if (submitBtn) submitBtn.addEventListener('click', handleUserSubmit);
        prekladInput.addEventListener('input', function () {
            if (prekladInput.value.length > 0) showTypeWarning();
        });
    } else {
        let en = firstEnRaw;
        if (en && en.startsWith('[')) {
            try { en = JSON.parse(en)[0]; } catch { en = ""; }
        }
        // Alex u≈æ byl p≈ôid√°n v√Ω≈°e, zde jen input pro pokraƒçov√°n√≠
        inputArea.innerHTML = `
            <div style="margin-bottom:10px; color:#888;">Poslouchej a pokraƒçuj</div>
            <button class="next-btn" id="nextBtn" style="display:block;">Pokraƒçovat &rarr;</button>
        `;
        nextBtn = document.getElementById('nextBtn');
        if (nextBtn) nextBtn.addEventListener('click', function () {
            // Z√≠sk√°n√≠ CSRF tokenu
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch(window.ROLEPLAYING_NEXT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(showNextTurn)
                .catch(error => {
                    console.error('Error:', error);
                    showResult('Chyba p≈ôi naƒç√≠t√°n√≠ dal≈°√≠ zpr√°vy. Zkuste obnovit str√°nku.', false);
                });
        });
    }

    initSpeechRecognition();

    // --- Dopl≈à zde ostatn√≠ pomocn√© funkce showTypeWarning, showNoSpeechWarning, showStreakToast, atd. ---


    function showStreakToast(message) {
        const toast = document.getElementById('streakToast');
        const toastText = document.getElementById('streakToastText');
        toastText.textContent = message;
        toast.style.display = 'flex';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2200);
    }

        function showTypeWarning() {
        let warn = document.getElementById('typeWarning');
        if (!warn) {
            warn = document.createElement('div');
            warn.id = 'typeWarning';
            warn.style.position = 'fixed';
            warn.style.bottom = '40px';
            warn.style.left = '50%';
            warn.style.transform = 'translateX(-50%)';
            warn.style.background = '#fffbe6';
            warn.style.border = '2px solid #ff9800';
            warn.style.borderRadius = '12px';
            warn.style.padding = '14px 28px';
            warn.style.fontSize = '1.1em';
            warn.style.boxShadow = '0 4px 16px rgba(0,0,0,0.12)';
            warn.style.zIndex = 9999;
            warn.style.color = '#b26a00';
            warn.innerHTML = 'Pou≈æ√≠vej mikrofon üé§ pokud m≈Ø≈æe≈°! Pi≈° jen kdy≈æ opravdu nem≈Ø≈æe≈° mluvit.';
            document.body.appendChild(warn);
            setTimeout(() => {
                warn.style.opacity = '0';
                setTimeout(() => { if (warn) warn.remove(); }, 600);
            }, 3200);
        }
    }

    function showNoSpeechWarning() {
        let warn = document.getElementById('noSpeechWarning');
        if (!warn) {
            warn = document.createElement('div');
            warn.id = 'noSpeechWarning';
            warn.style.position = 'fixed';
            warn.style.bottom = '40px';
            warn.style.left = '50%';
            warn.style.transform = 'translateX(-50%)';
            warn.style.background = '#ffeaea';
            warn.style.border = '2px solid #e74c3c';
            warn.style.borderRadius = '12px';
            warn.style.padding = '14px 28px';
            warn.style.fontSize = '1.1em';
            warn.style.boxShadow = '0 4px 16px rgba(0,0,0,0.12)';
            warn.style.zIndex = 9999;
            warn.style.color = '#c0392b';
            warn.innerHTML = 'Nebyla rozpozn√°na ≈æ√°dn√° ≈ôeƒç. Zkuste to znovu a mluvte z≈ôetelnƒõji!';
            document.body.appendChild(warn);
            setTimeout(() => {
                warn.style.opacity = '0';
                setTimeout(() => { if (warn) warn.remove(); }, 600);
            }, 3200);
        }
    }
    });
</script>
<script src="/static/script.js"></script>
</body>
</html>
