<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obchod | Knowix</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/mobile_header.css">

    <!-- Preconnect zrychlí DNS a spojení -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Font načti až po načtení stránky -->
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet"
          media="print" onload="this.media='all'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600&display=swap" rel="stylesheet">
    </noscript>

    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W1EN990JKP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-W1EN990JKP');
    </script>

    <!-- CSRF Token pro JavaScript -->
    <script>
        window.csrfToken = "{{ csrf_token() }}";
    </script>

    <style>
        body.dark-mode {
            background: #f5f1e8;
        }
        .shop-container {
            max-width: 600px;
            margin: 2.5em auto 2em auto;
            background: #f9f7f4;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(139,122,96,0.15);
            padding: 2.5em 2em 2em 2em;
        }
        body.dark-mode .shop-container {
            background: #2d2922;
            box-shadow: 0 4px 24px rgba(0,0,0,0.32);
        }
        .xp-status {
            text-align: center;
            font-size: 1.15em;
            margin-bottom: 2em;
            background: #f0eee9;
            border-radius: 8px;
            padding: 0.7em 0;
            font-weight: 500;
            color: #8b7a60;
        }
        .xp-status .keys-badge { display:inline-block; margin-left:10px; padding:2px 8px; border-radius:999px; background:#e7e1d6; color:#6b5d4f; font-weight:700; }
        body.dark-mode .xp-status {
            background: #3a342a;
            color: #d4c4a8;
        }
        body.dark-mode .xp-status .keys-badge { background:#4a4135; color:#e8dcc5; }
        .shop-items {
            display: flex;
            flex-wrap: wrap;
            gap: 2em;
            justify-content: center;
        }
        .shop-item {
            background: #f5f3f0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(139,122,96,0.08);
            padding: 1.5em 1.2em 1.2em 1.2em;
            flex: 1 1 220px;
            min-width: 220px;
            max-width: 270px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: box-shadow 0.2s;
        }
        body.dark-mode .shop-item {
            background: #3a342a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }
        .shop-item:hover {
            box-shadow: 0 6px 24px rgba(139,122,96,0.20);
        }
        .shop-item h2 {
            margin-top: 0;
            margin-bottom: 0.5em;
            font-size: 1.3em;
            font-weight: 600;
            color: #8b7a60;
            letter-spacing: 0.01em;
        }
        body.dark-mode .shop-item h2 {
            color: #d4c4a8;
        }
        .shop-item p {
            margin: 0.5em 0 1em 0;
            text-align: center;
            color: #6b5d4f;
            line-height: 1.4;
        }
        body.dark-mode .shop-item p {
            color: #c4b49a;
        }
        .shop-item .buy-btn {
            background: linear-gradient(90deg, #8b7a60 60%, #a69080 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.7em 1.5em;
            font-size: 1.08em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 0.7em;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(139,122,96,0.15);
            width: 100%;
            max-width: 200px;
        }
        body.dark-mode .shop-item .buy-btn {
            background: linear-gradient(90deg, #5a4f3e 60%, #6b5d4f 100%);
            color: #d4c4a8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.32);
        }
        .shop-item .buy-btn:hover:not(:disabled) {
            background: linear-gradient(90deg, #7a6b55 60%, #8b7a60 100%);
            box-shadow: 0 4px 16px rgba(139,122,96,0.25);
        }
        body.dark-mode .shop-item .buy-btn:hover:not(:disabled) {
            background: linear-gradient(90deg, #6b5d4f 60%, #7a6b55 100%);
        }
        .shop-item .buy-btn:disabled {
            background: #bdbdbd;
            color: #eee;
            cursor: not-allowed;
            box-shadow: none;
        }
        body.dark-mode .shop-item .buy-btn:disabled {
            background: #4a443a;
            color: #888;
        }
        .shop-item strong {
            color: #8b7a60;
        }
        body.dark-mode .shop-item strong {
            color: #d4c4a8;
        }
        .shop-item .freeze-count, .shop-item .booster-status {
            margin-top: 0.2em;
            font-size: 0.98em;
            color: #6b5d4f;
            text-align: center;
        }
        body.dark-mode .shop-item .freeze-count, body.dark-mode .shop-item .booster-status {
            color: #c4b49a;
        }
        a {
            display: inline-block;
            margin-top: 2em;
            text-decoration: none;
            color: #8b7a60;
            font-weight: 500;
            transition: color 0.15s;
        }
        body.dark-mode a {
            color: #d4c4a8;
        }
        a:hover {
            color: #6b5d4f;
            text-decoration: underline;
        }
        body.dark-mode a:hover {
            color: #f0eee9;
        }

        /* Wheel of fortune */
        .wheel-card{ margin-top:2em; padding:1.2em; border-radius:14px; background:#f5f3f0; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
        body.dark-mode .wheel-card{ background:#3a342a; }
        .wheel-title{ margin:0 0 .6em 0; font-size:1.3em; font-weight:700; color:#8b7a60; }
        body.dark-mode .wheel-title{ color:#d4c4a8; }
        .wheel-row{ display:flex; align-items:center; gap:16px; justify-content:space-between; flex-wrap:wrap; }
        .wheel{ width:160px; height:160px; border-radius:50%; background:
            conic-gradient(#ffd966 0 51.43deg,#b6d7a8 0 102.86deg,#a2c4c9 0 154.29deg,#d5a6bd 0 205.72deg,#f4cccc 0 257.15deg,#cfe2f3 0 308.58deg,#f9cb9c 0 360deg);
            border:6px solid #e7e1d6; position:relative; box-shadow:0 6px 16px rgba(0,0,0,0.12);
        }
        body.dark-mode .wheel{ border-color:#4a443a; }
        .wheel::after{ content:""; position:absolute; top:-18px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:18px solid #e07a5f; }
        .spin-anim{ animation: spin 2.2s cubic-bezier(.2,.8,.2,1) forwards; }
        @keyframes spin{ from{ transform:rotate(0); } to{ transform:rotate(1020deg); } }
        .wheel-info{ flex:1; min-width:220px; color:#6b5d4f; }
        body.dark-mode .wheel-info{ color:#e8dcc5; }
        .wheel-btn{ background:#e07a5f; color:white; border:none; padding:.7em 1.2em; border-radius:10px; font-weight:700; cursor:pointer; }
        .wheel-btn:disabled{ opacity:.6; cursor:not-allowed; }
        .keys-inline{ font-weight:700; }
        .wheel-result{ margin-top:.6em; font-weight:700; }

        /* Mobilní optimalizace */
        @media (max-width: 768px) {
            .shop-container {
                margin: 1em auto;
                padding: 1.5em 1em;
                border-radius: 12px;
                max-width: calc(100% - 2em);
            }
            .wheel-row{ flex-direction:column; align-items:center; }
        }

        /* Velmi malé mobily */
        @media (max-width: 480px) {
            .shop-container {
                margin: 0.5em auto;
                padding: 1em 0.8em;
                border-radius: 8px;
            }
        }

        /* Landscape mobily */
        @media (max-width: 900px) and (orientation: landscape) {
            .shop-container { margin: 1em auto; padding: 1.2em; }
        }
    </style>
</head>
<body class="{{ 'dark-mode' if session.get('theme') == 'dark' else '' }}"></body>
<header>
    <div class="logo-streak-wrapper">
        <div class="logo">
            <a href="{{ url_for('main.index') }}">
                <img src="{{ url_for('static', filename='pic/logo.webp') }}" alt="Knowix Logo">
            </a>
        </div>
        <span class="streak-badge">
            <img src="/static/fire.svg" alt="Streak">
            {{ user_streak }}
        </span>
    </div>
    <div class="nav-profile-wrapper">
        <ul class="nav-right">
            <li>
                <a href="/anglictina" title="Angličtina">
                    <img src="{{ url_for('static', filename='icons/eng.png') }}" alt="Angličtina" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/feedback" title="Feedback">
                    <img src="{{ url_for('static', filename='icons/chat.png') }}" alt="Feedback" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/news" title="Novinky">
                    <img src="{{ url_for('static', filename='icons/bell.png') }}" alt="Novinky" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/obchod" title="Obchod">
                    <img src="{{ url_for('static', filename='icons/shop.png') }}" alt="Obchod" class="nav-icon">
                </a>
            </li>
            <li>
                <a href="/zpravy" title="Zprávy">
                    <img src="{{ url_for('static', filename='icons/mail.png') }}" alt="Zprávy" class="nav-icon">
                </a>
            </li>
            <li>
                <button id="theme-toggle" title="Přepnout téma" style="background:none;border:none;cursor:pointer;padding:0;">
                    🌙
                </button>
            </li>
        </ul>
        {% if session['user_name'] %}
        <div class="user-profile">
            <div class="profile-container">
                {% if session.get('profile_pic') %}
                <img src="{{ url_for('static', filename='profile_pics/' + session['profile_pic']) }}"
                     alt="Profilová fotka" width="64" class="profile-pic">
                {% else %}
                <img src="{{ url_for('static', filename='pic/default.webp') }}" alt="Defaultní profilovka"
                     class="profile-pic" id="profileMenuTrigger">
                {% endif %}
                <div class="profile-menu" id="profileMenu">
                    <a href="{{ url_for('auth.settings') }}">⚙️ Nastavení</a>
                    <a href="{{ url_for('auth.logout') }}">🚪 Odhlásit se</a>
                </div>
                <span class="greeting" style="margin-left: 10px;">Ahoj {{ session['user_name'].split()[0] }}!</span>
            </div>
            {% if user_xp is defined and user_level is defined and user_level_name is defined and user_progress_percent is defined %}
            <div class="xp-header-bar">
                <div class="xp-header-bar-labels">
                    <span class="xp-level-badge">Level {{ user_level }} – {{ user_level_name }}</span>
                    <span class="xp-value">{{ user_xp_in_level }}/50 XP</span>
                </div>
                <div class="xp-header-bar-progress-bg">
                    <div class="xp-header-bar-progress" style="width: {{ user_progress_percent }}%"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
<div class="auth-links">
    <a href="{{ url_for('auth.login') }}" class="auth-btn login-btn">🔑 Přihlásit se</a>
    <a href="{{ url_for('auth.register') }}" class="auth-btn register-btn">📝 Registrovat se</a>
</div>
        {% endif %}
    </div>
</header>
<body>
<main class="shop-container">
    <h1>Obchod</h1>
    <div class="xp-status">
        <strong>Tvůj XP stav:</strong> {{ shop_status['xp'] }} XP
        <span class="keys-badge" id="keysBadge">Klíče: {{ shop_status['key_count'] or 0 }}</span>
    </div>
    <div class="shop-items">
        <div class="shop-item">
            <h2>🔥 Freeze</h2>
            <p>Ochrání tvůj streak, když bys o něj přišel. <br>
            <strong>Cena:</strong> {{ FREEZE_COST }} XP</p>
            <button type="button" class="buy-btn" data-item="freeze"
                {% if shop_status['freeze_count'] >= 3 or shop_status['xp'] < FREEZE_COST %}
                    disabled
                {% endif %}
            >
                {% if shop_status['freeze_count'] >= 3 %}
                    Limit 3 freeze dosažen
                {% elif shop_status['xp'] < FREEZE_COST %}
                    Nedostatek XP
                {% else %}
                    Koupit Freeze
                {% endif %}
            </button>
            <div class="freeze-count">Máš aktivních freeze: <strong>{{ shop_status['freeze_count'] }}</strong> / 3</div>
        </div>
        <div class="shop-item">
            <h2>⚡ XP Booster</h2>
            <p>Zdvojnásobí získané XP na 1 den.<br>
            <strong>Cena:</strong> {{ XP_BOOSTER_COST }} XP</p>
            <button type="button" class="buy-btn" data-item="xp_booster"
                {% if shop_status['xp'] < XP_BOOSTER_COST or shop_status['xp_booster_active'] %}
                    disabled
                {% endif %}
            >
                {% if shop_status['xp_booster_active'] %}
                    Booster už je aktivní
                {% elif shop_status['xp'] < XP_BOOSTER_COST %}
                    Nedostatek XP
                {% else %}
                    Koupit XP Booster
                {% endif %}
            </button>
            <div class="booster-status">XP Booster je {% if shop_status['xp_booster_active'] %}<strong>aktivní</strong>{% else %}neaktivní{% endif %}.</div>
        </div>
    </div>

    <!-- Kolo štěstí -->
    <section class="wheel-card" aria-label="Kolo štěstí">
        <h2 class="wheel-title">🎡 Kolo štěstí</h2>
        <div class="wheel-row">
            <div class="wheel" id="wheel"></div>
            <div class="wheel-info">
                <p>Roztoč kolo a vyhraj: 1× freeze, 1× XP boost, +100 XP, náhodný achievement, +1 klíč, nic, +1 streak.</p>
                <p>Klíče k dispozici: <span class="keys-inline" id="keysInline">{{ shop_status['key_count'] or 0 }}</span></p>
                <button class="wheel-btn" id="spinBtn">Roztočit (1 klíč)</button>
                <div class="wheel-result" id="spinResult"></div>
            </div>
        </div>
    </section>

    <a href="{{ url_for('main.index') }}">← Zpět na hlavní stránku</a>
</main>

<script>
    // Nákup položek s CSRF ochranou
    document.querySelectorAll('.buy-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const item = e.target.getAttribute('data-item');
            if (!item || e.target.disabled) return;

            try {
                const res = await fetch('/buy_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrfToken
                    },
                    body: JSON.stringify({ item })
                });

                const data = await res.json();
                if (data.status === 'success') {
                    alert(data.message);
                    location.reload(); // Znovu načteme stránku pro aktualizaci stavu
                } else {
                    alert('Chyba: ' + data.message);
                }
            } catch (error) {
                console.error("Chyba při nákupu:", error);
                alert('Nastala chyba při zpracování nákupu.');
            }
        });
    });

    // Theme toggle podle vzoru z news.html
    document.getElementById('theme-toggle')?.addEventListener('click', async () => {
        try {
            const response = await fetch('/toggle_theme', { method: 'POST' });
            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('Chyba při přepínání tématu:', error);
        }
    });

    // Profile menu toggle
    const profileTrigger = document.getElementById('profileMenuTrigger');
    const profileMenu = document.getElementById('profileMenu');
    if (profileTrigger && profileMenu) {
        profileTrigger.addEventListener('click', () => {
            profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', (e) => {
            if (!profileTrigger.contains(e.target) && !profileMenu.contains(e.target)) {
                profileMenu.style.display = 'none';
            }
        });
    }

    // Kolo štěstí – spin
    (function(){
      const btn = document.getElementById('spinBtn');
      const wheel = document.getElementById('wheel');
      const resEl = document.getElementById('spinResult');
      const keysInline = document.getElementById('keysInline');
      const keysBadge = document.getElementById('keysBadge');

      function setKeys(n){
        if(keysInline) keysInline.textContent = String(n);
        if(keysBadge) keysBadge.textContent = 'Klíče: ' + String(n);
      }

      btn?.addEventListener('click', async ()=>{
        if (!btn) return;
        if (btn.disabled) return;
        const have = parseInt((keysInline?.textContent||'0'),10) || 0;
        if (have <= 0){ alert('Nemáš dostatek klíčů.'); return; }
        btn.disabled = true; resEl.textContent='';
        try{
          // vizuální spin
          wheel?.classList.remove('spin-anim'); void wheel?.offsetWidth; wheel?.classList.add('spin-anim');
          const r = await fetch('/spin_wheel', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':window.csrfToken}, body: '{}' });
          const data = await r.json();
          // počkej chvilku, ať animace doběhne
          setTimeout(()=>{
            if(data && data.status === 'success'){
              resEl.textContent = data.message || 'Hotovo.';
              if(typeof data.key_count === 'number'){ setKeys(data.key_count); }
            } else {
              resEl.textContent = (data && data.message) ? data.message : 'Nepodařilo se roztočit.';
            }
            btn.disabled = false;
          }, 1200);
        }catch(e){
          resEl.textContent = 'Chyba sítě.'; btn.disabled=false;
        }
      });
    })();
</script>
<script>const CSRF_TOKEN = "{{ csrf_token() }}";</script>
<script>
    document.getElementById('theme-toggle').addEventListener('click', () => {
        fetch('/set_theme', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN},
            body: JSON.stringify({
                theme: document.body.classList.contains('dark-mode') ? 'light' : 'dark',
                csrf_token: CSRF_TOKEN
            })
        }).then(r => {
            if (r.ok) {
                document.body.classList.toggle('dark-mode');
                sessionStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            }
        });
    });
</script>
</body>
</html>