<!doctype html>
<html lang="cs">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin · Připomínky</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fb;
            margin: 0;
            padding: 24px;
            color: #0f172a;
        }

        .card {
            max-width: 720px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .card h1 {
            margin: 0;
            padding: 18px 20px;
            font-size: 20px;
            background: #0a66c2;
            color: #fff;
        }

        .card .body {
            padding: 20px;
        }

        .row {
            display: flex;
            gap: 14px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #0a66c2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn[disabled] {
            opacity: .6;
            cursor: not-allowed;
        }

        .muted {
            color: #64748b;
            font-size: 13px;
        }

        .stat {
            margin-top: 14px;
            font-size: 14px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.8s linear infinite;
            vertical-align: -2px;
            margin-right: 6px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="card">
    <h1>Hromadná rozesílka připomínek</h1>
    <div class="body">
        <p>Odešle připomínku všem uživatelům, kteří mají povoleno <code>receive_reminder_emails</code>. Každému se
            nastaví <code>last_reminder_sent = NOW()</code>, takže běžný automat čeká 24 hodin.</p>
        <div class="row">
            <button id="sendAll" class="btn">
                Poslat všem
            </button>
            <span id="status" class="muted"></span>
        </div>
        <div id="stats" class="stat"></div>
        <p class="muted" style="margin-top:18px;">Poznámka: pro odesílání musí být nastavena proměnná prostředí <code>EMAIL_PASSWORD</code>.
            Hromadné odeslání může trvat déle a u některých poskytovatelů je limitováno.</p>
    </div>
</div>

<script>
    // CSRF token z Jinja (viz security_ext.csrf_token)
    const CSRF_TOKEN = "{{ csrf_token() }}";

    const btn = document.getElementById('sendAll');
    const statusEl = document.getElementById('status');
    const statsEl = document.getElementById('stats');

    async function sendAll() {
        btn.disabled = true;
        statusEl.innerHTML = '<span class="spinner"></span>Odesílám…';
        statsEl.textContent = '';
        try {
            const res = await fetch('/admin/reminders/send_all', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN
                }
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || !data.success) throw new Error(data.error || 'Chyba při odesílání');
            statusEl.textContent = 'Hotovo';
            statsEl.textContent = `Odesláno: ${data.sent} / ${data.total}`;
        } catch (e) {
            statusEl.textContent = 'Chyba';
            statsEl.textContent = e.message || 'Neznámá chyba';
        } finally {
            btn.disabled = false;
        }
    }

    btn.addEventListener('click', sendAll);
</script>
</body>
</html>
